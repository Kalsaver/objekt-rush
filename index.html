<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBJEKT Rush (v10.311 - Icon & Config Refactor)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js" defer></script>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp, where, doc, updateDoc, getDoc, setDoc, arrayUnion, increment, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js';

        // Dimension Link ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyAnLnKulINF54LKsQ5tRzXHfvUx3XWSuKw",
            authDomain: "dimension-link.firebaseapp.com",
            projectId: "dimension-link",
            storageBucket: "dimension-link.firebasestorage.app",
            messagingSenderId: "753751766984",
            appId: "1:753751766984:web:808abfa8a593c161c5b2fd"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.fbOnAuthStateChanged = onAuthStateChanged;

        // ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ ÏûêÎèô Ïã§Ìñâ
        signInAnonymously(auth).then(() => {
            console.log("Logged in anonymously to Dimension Link");
        }).catch((error) => {
            console.error("Login failed", error);
        });

        // Expose Firebase helpers to global window object for Alpine.js
        window.fbAuth = auth;
        window.fbDb = db;
        window.fbCollection = collection;
        window.fbAddDoc = addDoc;
        window.fbUpdateDoc = updateDoc;
        window.fbDoc = doc;
        window.fbQuery = query;
        window.fbOrderBy = orderBy;
        window.fbLimit = limit;
        window.fbGetDocs = getDocs;
        window.fbServerTimestamp = serverTimestamp;
        window.fbWhere = where; 
        window.fbGetDoc = getDoc;
        window.fbSetDoc = setDoc;
        window.fbArrayUnion = arrayUnion;
        window.fbIncrement = increment;
        window.fbOnSnapshot = onSnapshot;
        
        console.log("Firebase Initialized");
    </script>

    <style>
        /* --- LAYOUT & SCROLLBAR --- */
        [x-cloak] { display: none !important; }
        
        body, #game-container { height: 100vh; height: -webkit-fill-available; background-color: #000; }
        .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #4a5568 #1a202c; }
        .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1a202c00; border-radius: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #4a556880; border-radius: 4px; }

        /* --- UTILS --- */
        .writing-mode-v-rl { writing-mode: vertical-rl; text-orientation: mixed; }
        .perspective { perspective: 1000px; }
        
        /* --- ANIMATIONS --- */
        .countdown-zoom { animation: zoom-in-out 0.5s ease-in-out infinite; }
        @keyframes zoom-in-out { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } }
        
        .boss-border { border-color: #f56565; box-shadow: 0 0 15px 5px rgba(245, 101, 101, 0.5); animation: pulse-red 2s infinite; position: relative; overflow: hidden; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 15px 5px rgba(245, 101, 101, 0.4); } 50% { box-shadow: 0 0 20px 8px rgba(245, 101, 101, 0.7); } }
        .boss-border::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.3) 50%, rgba(255, 255, 255, 0) 100%); transform: rotate(30deg); animation: shine 3s infinite linear; }
        @keyframes shine { 0% { transform: rotate(30deg) translateX(-150%); } 100% { transform: rotate(30deg) translateX(150%); } }
        
        .unlock-bounce { animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounce-in { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* --- CARD FLIP --- */
        .card-flip { transform-style: preserve-3d; transition: transform 0.6s; position: relative; width: 100%; height: 100%; }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 0.5rem; overflow: hidden; }
        .card-back { background: linear-gradient(225deg, #0a0e17 0%, #0c1445 50%, #0a0e17 100%); display: flex; align-items: center; justify-content: center; transform: rotateY(0deg); border: 2px solid #9ca3af; cursor: pointer; }
        .card-front { transform: rotateY(180deg); }
        .card-flip.is-flipped { transform: rotateY(180deg); }

        /* --- THEME STYLES --- */
        .premium-bg {
            background-color: #0f0f13;
            background-image: 
                radial-gradient(at 50% 0%, rgba(88, 28, 135, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(219, 39, 119, 0.2) 0px, transparent 50%),
                linear-gradient(to bottom, #0f0f13, #000);
            background-attachment: fixed;
        }
        .title-bg-effect {
             background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 5px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 4px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            animation: bg-drift 60s linear infinite;
        }
        @keyframes bg-drift { from { background-position: 0 0, 40px 60px, 130px 270px; } to { background-position: 550px 550px, 390px 410px, 680px 820px; } }

        .glass-panel {
            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .glass-button {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.2s ease-out;
        }
        .glass-button:hover:not(:disabled) {
            background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.1));
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1); transform: translateY(-1px);
            color: white !important;
        }
        .glass-button:active:not(:disabled) { transform: scale(0.98) translateY(0px); }
        .glass-button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .holo-bg {
            background: rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            border-right: 1px solid #ffffff33;
            background-image: linear-gradient(0deg, 
                rgba(255, 0, 255, 0.8) 0%,
                rgba(255, 255, 0, 0.8) 25%,
                rgba(0, 255, 255, 0.8) 50%,
                rgba(255, 0, 255, 0.8) 75%,
                rgba(255, 255, 0, 0.8) 100%
            );
            background-size: 100% 450%;
            animation: holo-color 5s linear infinite; 
        }
        .holo-bg::before, .holo-bg::after { content: none; }
        
        @keyframes holo-color {
            0% { background-position: 50% 100%; }
            100% { background-position: 50% 0%; }
        }

        .btn-green-glow { box-shadow: 0 0 10px rgba(34, 197, 94, 0.3); border-color: rgba(34, 197, 94, 0.5); }
        .btn-red-glow { box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); border-color: rgba(239, 68, 68, 0.5); }
        .btn-yellow-glow { box-shadow: 0 0 10px rgba(234, 179, 8, 0.3); border-color: rgba(234, 179, 8, 0.5); }
        .btn-blue-glow { box-shadow: 0 0 10px rgba(96, 165, 250, 0.3); border-color: rgba(96, 165, 250, 0.5); }
        .btn-gold-glow { box-shadow: 0 0 15px rgba(234, 179, 8, 0.5); border-color: rgba(253, 224, 71, 0.7); }

        .rekord-archive-text {
            color: white; 
            background: none;
            -webkit-text-fill-color: initial;
            animation: none;
        }
        
        .holo-text {
            background: linear-gradient(90deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            background-size: 200% auto; color: #000; background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: holo-text-shine 5s linear infinite;
        }
        @keyframes holo-text-shine { to { background-position: 200% center; } }

        .text-glow { text-shadow: 0 0 8px currentColor; }
        .text-glow-sm { text-shadow: 0 0 4px currentColor; }

        .floating-objekt {
            position: absolute; width: 60px; height: 80px; border-radius: 6px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            backdrop-filter: blur(2px); 
            border: 1px solid rgba(255,255,255,0.3);
            animation: float-rotate 20s infinite linear; 
            opacity: 0.5; 
        }
        @keyframes float-rotate {
            0% { transform: translateY(0) rotate(0deg) scale(1); }
            50% { transform: translateY(-20px) rotate(180deg) scale(1.1); }
            100% { transform: translateY(0) rotate(360deg) scale(1); }
        }
        
        .craft-grid-container { position: relative; width: 24rem; height: 24rem; display: flex; justify-content: center; align-items: center; }
        .craft-card { position: absolute; width: 4rem; height: 5rem; animation-duration: 1.0s; animation-fill-mode: forwards; animation-timing-function: ease-in-out; }
        .craft-card-1 { top: 50%; left: 50%; margin-top: -8.5rem; margin-left: -2rem; animation-name: merge-down; }   
        .craft-card-2 { top: 50%; left: 50%; margin-top: -2.5rem; margin-left: -8rem; animation-name: merge-right; }  
        .craft-card-3 { top: 50%; left: 50%; margin-top: -2.5rem; margin-left: 4rem;  animation-name: merge-left; }   
        .craft-card-4 { top: 50%; left: 50%; margin-top: 3.5rem;  margin-left: -2rem; animation-name: merge-up; }     
        .craft-special-card { position: absolute; top: 50%; left: 50%; width: 4rem; height: 5rem; margin-top: -2.5rem; margin-left: -2rem; z-index: 10; opacity: 0; transform: scale(0.9); animation: appear-center-light 1.5s 1.0s forwards ease-out; }
        @keyframes merge-down { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(6rem) scale(0.5); } }
        @keyframes merge-right{ 0% { opacity: 1; transform: translateX(0) scale(1); } 100% { opacity: 0; transform: translateX(6rem) scale(0.5); } }
        @keyframes merge-left { 0% { opacity: 1; transform: translateX(0) scale(1); } 100% { opacity: 0; transform: translateX(-6rem) scale(0.5); } }
        @keyframes merge-up   { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-6rem) scale(0.5); } }
        @keyframes appear-center-light { 0% { opacity: 0; transform: scale(0.9); filter: brightness(10) blur(5px); } 100% { opacity: 1; transform: scale(1); filter: brightness(1) blur(0px); } }

        /* --- Gacha Animation Styles --- */
        .booster-pack-container { perspective: 1000px; }
        .booster-pack {
            width: 140px; height: 190px; background: linear-gradient(135deg, #4f46e5, #9333ea, #db2777);
            border-radius: 12px; box-shadow: 0 0 30px rgba(168, 85, 247, 0.6);
            display: flex; align-items: center; justify-content: center; font-size: 5rem;
            position: relative; overflow: hidden; animation: pack-hover 3s ease-in-out infinite;
        }
        .booster-pack::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: rotate(30deg); animation: holo-shine 4s infinite linear;
        }
        .pack-shaking { animation: pack-shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes pack-hover { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-10px) rotate(2deg); } }
        @keyframes pack-shake { 10%, 90% { transform: translate3d(-2px, 0, 0) rotate(-2deg); } 20%, 80% { transform: translate3d(3px, 0, 0) rotate(3deg); } 30%, 50%, 70% { transform: translate3d(-5px, 0, 0) rotate(-5deg); } 40%, 60% { transform: translate3d(5px, 0, 0) rotate(5deg); } }
        .flash-overlay { animation: flash-bang 0.8s ease-out forwards; }
        @keyframes flash-bang { 0% { opacity: 0; } 50% { opacity: 0.6; background: white; } 100% { opacity: 0; } }
        .flash-overlay-purple { animation: flash-bang-purple 1.2s ease-out forwards; }
        @keyframes flash-bang-purple { 0% { opacity: 0; } 30% { opacity: 0.8; background: #d8b4fe; } 100% { opacity: 0; } }
        .card-reveal { animation: card-appear-scale 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes card-appear-scale { 0% { opacity: 0; transform: scale(0.1) rotate(-10deg); } 100% { transform: scale(1.5) rotate(0deg); } }

        /* --- Mission Briefing Styles --- */
        .briefing-panel {
            background: linear-gradient(180deg, rgba(20, 20, 30, 0.9) 0%, rgba(10, 10, 15, 0.95) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8), 0 0 30px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        .briefing-panel::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, transparent, #ef4444, transparent);
            animation: scan-line 3s ease-in-out infinite; opacity: 0.7;
        }
        .briefing-panel::after {
            content: 'TOP SECRET // CLASSIFIED'; position: absolute; top: 1rem; right: 1.5rem;
            font-size: 0.7rem; font-weight: 900; color: #ef4444; letter-spacing: 0.2em; opacity: 0.6;
            border: 2px solid #ef4444; padding: 0.2rem 0.5rem; transform: rotate(-5deg);
            z-index: 50; pointer-events: none;
        }
        @keyframes scan-line { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        
        /* --- SCANLINE EFFECT --- */
        #order-area { position: relative; overflow: hidden; }
        #order-area::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                to bottom,
                rgba(0, 0, 0, 0.2),
                rgba(0, 0, 0, 0.3) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 10;
            opacity: 0.8;
            animation: monitor-flicker 0.1s infinite step-end;
        }
        @keyframes monitor-flicker {
            0% { opacity: 0.8; }
            50% { opacity: 0.75; }
            100% { opacity: 0.8; }
        }

        .ending-screen-overlay::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                to bottom,
                rgba(0, 0, 0, 0.4),
                rgba(0, 0, 0, 0.4) 1px,
                transparent 1px,
                transparent 3px
            );
            z-index: 50;
            opacity: 0.1;
            pointer-events: none;
        }
        .ending-rank-glow {
            animation: rank-pulse 2s infinite alternate;
        }
        @keyframes rank-pulse {
            0% { filter: drop-shadow(0 0 5px currentColor); }
            100% { filter: drop-shadow(0 0 15px currentColor); }
        }

        /* SMART GUIDE GLOW for Stage 1 */
        .guide-pulse {
            box-shadow: 0 0 10px 3px rgba(250, 204, 21, 0.6);
            border-color: rgba(250, 204, 21, 0.9) !important;
            animation: guide-flash 1.5s infinite;
            z-index: 10;
        }
        @keyframes guide-flash {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.02); }
        }

    </style>

    <script>

        function objektCard(cardData, showEffects = true) {
            return {
                card: cardData,
                showEffects: showEffects,
                get cardStyles() {
                    const card = this.card;
                    if (!card) return {};
                    let backgroundStyle = `background-color: #FFFFFF;`; 
                    if (card.color) backgroundStyle = `background-color: ${card.color};`;
                    let textColor = 'color: #000000;'; 
                    if (card.customTextColor) {
                        textColor = `color: ${card.customTextColor};`; 
                    } else if (card.sNumber === 'MH') {
                        textColor = 'color: #F5F5F5;'; 
                    }
                    return { background: backgroundStyle, text: textColor };
                },
                get borderStyles() {
                    return 'border-gray-400';
                }
            }
        }

        const GAME_SCORING = { 
            CORRECT_CARD: 10, 
            PERFECT_BASE_MULTIPLIER: 5, 
            BOSS_PERFECT_MULTIPLIER: 10,
            FAIL_PENALTY: 20, 
            TIME_OVER_PENALTY: 5, 
        };

        const GAME_ITEM_INFO = {
            objekt: { title: 'OBJEKT PACK', desc: '', cost: 1, icon: 'üÉè', maxLevel: 0 }, // 0ÏùÄ Î¨¥Ï†úÌïú/ÏÜåÎ™®Ìíà ÏùòÎØ∏
            reload: { title: 'RELOAD CHARGE', desc: 'item_reload_desc', cost: 1, icon: 'üîÑ', maxLevel: 20, stateKey: 'reloadBoost' },
            timePlus: { title: 'TIME+ (Lv.1)', desc: 'item_timePlus_desc', cost: 4, icon: '‚è≥', maxLevel: 1, stateKey: 'timePlusLevel' }, 
            scan: { title: 'SCAN (Lv.1)', desc: 'item_scan_desc', cost: 4, icon: 'üîç', maxLevel: 1, stateKey: 'scanLevel' }, 
            amulet: { title: 'AMULET (Lv.1)', desc: 'item_amulet_desc', cost: 3, icon: 'üåô', maxLevel: 1, stateKey: 'amuletLevel' }, 
            assist: { title: 'ASSIST (Lv.1)', desc: 'item_assist_desc', cost: 3, icon: 'ü§ù', maxLevel: 1, stateKey: 'assistLevel' } 
        };

        const GAME_DEFAULT_BADGE = 'üëæ';

        const GAME_SEASON_BADGE_TABLE = [
            'üåä', 'üíé', 'üçì', 'üèÜ', '‚ú®', 'üöÄ', 'üåô', '‚≠ê', '‚ù§Ô∏è', 'üçÄ', 'ü•¶', '‚ö°Ô∏è'
        ];

        const GAME_BOSS_COMMENTS = {
            S: ["boss_S_0", "boss_S_1", "boss_S_2"],
            A: ["boss_A_0", "boss_A_1", "boss_A_2"],
            B: ["boss_B_0", "boss_B_1", "boss_B_2"],
            C: ["boss_C_0", "boss_C_1", "boss_C_2"],
            F: ["boss_F_0", "boss_F_1", "boss_F_2"]
        };

        const GAME_ENDING_MESSAGES = { 
            S: { title: "ending_S_title", desc: "ending_S_desc", theme: "text-yellow-300" },
            A: { title: "ending_A_title", desc: "ending_A_desc", theme: "text-green-400" },
            B: { title: "ending_B_title", desc: "ending_B_desc", theme: "text-blue-400" },
            C: { title: "ending_C_title", desc: "ending_C_desc", theme: "text-gray-400" },
            F: { title: "ending_F_title", desc: "ending_F_desc", theme: "text-red-400" } 
        };

        const GAME_STAGE_CONFIG = [
            { blocks: 7, decoy: 0, birthdayChance: 0, timeBonus: 2000, bosses: [] }, 
            { blocks: 7, decoy: 0.1, birthdayChance: 0, timeBonus: 2000, bosses: [] }, 
            { blocks: 7, decoy: 0.1, birthdayChance: 0.1, timeBonus: 2000, bosses: [] }, 
            { blocks: 8, decoy: 0.1, birthdayChance: 0.1, timeBonus: 0, bosses: [] }, 
            { blocks: 8, decoy: 0.2, birthdayChance: 0.1, timeBonus: 0, bosses: ['NXT_GLOW'] }, 
            { blocks: 8, decoy: 0.2, birthdayChance: 0.1, timeBonus: 0, bosses: ['AAA_KRE'] }, 
            { blocks: 9, decoy: 0.2, birthdayChance: 0.2, timeBonus: 0, bosses: ['MSNZ'] }, 
            { blocks: 9, decoy: 0.2, birthdayChance: 0.2, timeBonus: 0, bosses: ['LOVE_EVOL'] }, 
            { blocks: 9, decoy: 0.3, birthdayChance: 0.2, timeBonus: 0, bosses: ['HATCH_ALPHIE'] }, 
            { blocks: 10, decoy: 0.3, birthdayChance: 0.2, timeBonus: 0, bosses: ['ARIA_VV'] }, 
            { blocks: 24, decoy: 0.3, birthdayChance: 0.3, timeBonus: 0, bosses: ['MSNZ'] }
        ];

        const GAME_BOSS_POOLS = {
            'NXT_GLOW': ['NXT', 'Glow'],
            'AAA_KRE': ['AAA', 'KRE'],
            'MSNZ': ['Moon', 'Sun', 'Neptune', 'Zenith'],
            'LOVE_EVOL': ['LOVE', 'EVOL'],
            'HATCH_ALPHIE': ['Hatch!', 'Alphie'],
            'ARIA_VV': ['Aria', 'VV']
        };

        const GAME_MEMBER_DATA = [
            { sNumber: 'S1', kor: 'ÏÑúÏó∞', eng: 'SeoYeon', color: '#22AEFF', birthday: '08-06', dimensions: ['KRE', 'LOVE', 'Neptune'], decoysKor: ['ÏÑúÏñ∏', 'ÏÑúÏòÅ', 'ÏÖîÏó∞'], decoysEng: ['SeoYoun', 'SeoYeong', 'SoeYeon'], type: 'member_card' },
            { sNumber: 'S2', kor: 'ÌòúÎ¶∞', eng: 'HyeRin', color: '#9200FF', birthday: '04-12', dimensions: ['AAA', 'LOVE', 'VV', 'Sun'], decoysKor: ['Ìó§Î¶∞', 'ÌòúÎ¶º', 'Ìï¥Î¶∞'], decoysEng: ['HyeLin', 'HyeRim', 'HeyRin'], type: 'member_card' },
            { sNumber: 'S3', kor: 'ÏßÄÏö∞', eng: 'JiWoo', color: '#FFF800', birthday: '10-24', dimensions: ['KRE', 'EVOL', 'Aria', 'Hatch!', 'Zenith'], decoysKor: ['ÏßÄÏú†', 'ÏãúÏö∞', 'ÏßÄÌõÑ'], decoysEng: ['JiWu', 'JiYu', 'JiWooo'], type: 'member_card' },
            { sNumber: 'S4', kor: 'Ï±ÑÏó∞', eng: 'ChaeYeon', color: '#98F21D', birthday: '12-04', dimensions: ['KRE', 'EVOL', 'Aria', 'Hatch!', 'Sun'], decoysKor: ['Ï±ÑÏñ∏', 'Ï±ÑÏòÅ', 'Ï≤¥Ïó∞'], decoysEng: ['ChaeYoun', 'ChaeYeong', 'CheaYeon'], type: 'member_card' },
            { sNumber: 'S5', kor: 'Ïú†Ïó∞', eng: 'YooYeon', color: '#DB0C74', birthday: '02-09', dimensions: ['AAA', 'EVOL', 'VV', 'Hatch!', 'Alphie', 'Sun'], decoysKor: ['Ïú†Ïñ∏', 'Ïú†ÏòÅ', 'Ïö∞Ïó∞'], decoysEng: ['YooYoun', 'YooYeong', 'YooYoen'], type: 'member_card' },
            { sNumber: 'S6', kor: 'ÏàòÎØº', eng: 'SooMin', color: '#FC83A4', birthday: '10-03', dimensions: ['KRE', 'EVOL', 'Hatch!', 'Zenith'], decoysKor: ['ÏàòÎ∞à', 'ÏàòÎπà', 'ÏäàÎØº'], decoysEng: ['SooMean', 'SooBin', 'SuMin'], type: 'member_card' },
            { sNumber: 'S7', kor: 'ÎÇòÍ≤Ω', eng: 'NaKyoung', color: '#6799A0', birthday: '10-13', dimensions: ['AAA', 'EVOL', 'VV', 'Neptune'], decoysKor: ['ÎÇòÍ≤Ö', 'ÎÇòÍ≤∏', 'Îã§Í≤Ω'], decoysEng: ['NaKyeong', 'NaKyoum', 'NaKyuong'], type: 'member_card' },
            { sNumber: 'S8', kor: 'Ïú†Îπà', eng: 'YuBin', color: '#FFE3E2', birthday: '02-03', dimensions: ['AAA', 'LOVE', 'VV', 'Zenith'], decoysKor: ['Ïú†Îπî', 'Ïú†ÎØº', 'Ïö∞Îπà'], decoysEng: ['YuBean', 'YuBim', 'YooBin'], type: 'member_card' },
            { sNumber: 'S9', kor: 'Ïπ¥ÏóêÎç∞', eng: 'Kaede', color: '#FFC935', birthday: '12-20', dimensions: ['LOVE', 'Aria', 'VV', 'Moon'], decoysKor: ['Ïπ¥ÏóêÎåÄ', 'Ïπ¥Ïï†Îç∞', 'Í∞ÄÏóêÎç∞'], decoysEng: ['Kaedeh', 'Kaebe', 'Keade'], type: 'member_card' },
            { sNumber: 'S10', kor: 'Îã§ÌòÑ', eng: 'DaHyun', color: '#FF9AD6', birthday: '01-08', dimensions: ['LOVE', 'Aria', 'Neptune'], decoysKor: ['Îã§Ìóå', 'Îã§Ìòï', 'Îã§Ïó∞'], decoysEng: ['DaHyeon', 'DaHyung', 'DaHuyn'], type: 'member_card' },
            { sNumber: 'S11', kor: 'ÏΩîÌÜ†ÎÑ§', eng: 'Kotone', color: '#FFDE00', birthday: '03-10', dimensions: ['EVOL', 'VV', 'Hatch!', 'Alphie', 'Neptune'], decoysKor: ['ÏΩîÌÜ†ÎÇ¥', 'ÏΩîÎèÑÎÑ§', 'Í≥†ÌÜ†ÎÑ§'], decoysEng: ['Kotoneh', 'Katone', 'Kotonae'], type: 'member_card' },
            { sNumber: 'S12', kor: 'Ïó∞ÏßÄ', eng: 'YeonJi', color: '#5974FF', birthday: '01-08', dimensions: ['EVOL', 'VV', 'Zenith'], decoysKor: ['Ïó∞Ïãú', 'ÏòÅÏßÄ', 'Ïñ∏ÏßÄ'], decoysEng: ['YeonJee', 'YeongJi', 'YoenJi'], type: 'member_card' },
            { sNumber: 'S13', kor: 'ÎãàÏóî', eng: 'Nien', color: '#FF953F', birthday: '06-02', dimensions: ['LOVE', 'Aria', 'VV', 'Alphie', 'Neptune'], decoysKor: ['ÎãàÏï§', 'ÎãàÏòå', 'Î¶¨Ïóî'], decoysEng: ['Niaen', 'Niyen', 'Nein'], type: 'member_card' },
            { sNumber: 'S14', kor: 'ÏÜåÌòÑ', eng: 'SoHyun', color: '#1222B5', birthday: '10-13', dimensions: ['LOVE', 'VV', 'Moon'], decoysKor: ['ÏÜåÌóå', 'ÏÜåÌòï', 'ÏÜåÏó∞'], decoysEng: ['SoHyeon', 'SoHyung', 'SoHuyn'], type: 'member_card' },
            { sNumber: 'S15', kor: 'Ïã†ÏúÑ', eng: 'Xinyu', color: '#D51313', birthday: '05-25', dimensions: ['LOVE', 'VV', 'Sun'], decoysKor: ['Ïã†Ïù¥', 'ÏãúÎãà', 'Ïã†Ïú†'], decoysEng: ['Xinyui', 'Xinyi', 'Xinuy'], type: 'member_card' },
            { sNumber: 'S16', kor: 'ÎßàÏú†', eng: 'Mayu', color: '#FE8E76', birthday: '05-12', dimensions: ['EVOL', 'Hatch!', 'Sun'], decoysKor: ['ÎßàÏö∞', 'ÎØ∏Ïú†', 'ÎßàÏúÑ'], decoysEng: ['Mayoo', 'Miyu', 'Mayuu'], type: 'member_card' },
            { sNumber: 'S17', kor: 'Î¶∞', eng: 'Lynn', color: '#AC62B7', birthday: '04-12', dimensions: ['NXT', 'VV', 'Alphie', 'Moon'], decoysKor: ['ÎßÅ', 'Î¶º', 'Î¶¥'], decoysEng: ['Lyn', 'Lym', 'Rynn'], type: 'member_card' },
            { sNumber: 'S18', kor: 'Ï£ºÎπà', eng: 'JooBin', color: '#B7F54C', birthday: '01-16', dimensions: ['NXT', 'Zenith'], decoysKor: ['Ï£ºÎπî', 'Ï£ºÎØº', 'Ï•¨Îπà'], decoysEng: ['JooBean', 'JooBim', 'JuBin'], type: 'member_card' },
            { sNumber: 'S19', kor: 'ÌïòÏó∞', eng: 'HaYeon', color: '#52D9BB', birthday: '08-01', dimensions: ['NXT', 'Alphie', 'Zenith'], decoysKor: ['ÌïòÏñ∏', 'ÌïòÏòÅ', 'ÌñêÏó∞'], decoysEng: ['HaYoun', 'HaYeong', 'HaYoen'], type: 'member_card' },
            { sNumber: 'S20', kor: 'ÏãúÏò®', eng: 'ShiOn', color: '#FF428A', birthday: '04-03', dimensions: ['NXT', 'Hatch!', 'Alphie', 'Moon'], decoysKor: ['ÏãúÏùÄ', 'ÏãúÏò¥', 'ÏãúÏöò'], decoysEng: ['SiOn', 'ShiOm', 'ShiOne'], type: 'member_card' },
            { sNumber: 'S21', kor: 'Ï±ÑÏõê', eng: 'ChaeWon', color: '#C7A3E0', birthday: '05-02', dimensions: ['Glow', 'Hatch!', 'Alphie', 'Sun'], decoysKor: ['Ï±ÑÏúà', 'Ï±ÑÏõ°', 'Ï≤¥Ïõê'], decoysEng: ['ChaeOne', 'ChaeWong', 'CheaWon'], type: 'member_card' },
            { sNumber: 'S22', kor: 'ÏÑ§Î¶∞', eng: 'Sullin', color: '#7BBA8D', birthday: '11-30', dimensions: ['Glow', 'Moon'], decoysKor: ['ÏÑ§Î•Ä', 'ÏÑ§Î¶º', 'ÏÑ†Î¶∞'], decoysEng: ['Seollin', 'Sullim', 'Sulin'], type: 'member_card' },
            { sNumber: 'S23', kor: 'ÏÑúÏïÑ', eng: 'SeoAh', color: '#CFF3FF', birthday: '06-11', dimensions: ['Glow', 'Neptune'], decoysKor: ['ÏÑúÏù¥', 'ÏãúÏïÑ', 'ÏÑúÌïò'], decoysEng: ['SeoA', 'SeeAh', 'SoeAh'], type: 'member_card' },
            { sNumber: 'S24', kor: 'ÏßÄÏó∞', eng: 'JiYeon', color: '#FFAB62', birthday: '02-13', dimensions: ['Glow', 'VV', 'Alphie', 'Moon'], decoysKor: ['ÏßÄÏñ∏', 'ÏßÄÏòÅ', 'ÏãúÏó∞'], decoysEng: ['JiYoun', 'JiYeong', 'JiYoen'], type: 'member_card' }
        ];

        const GAME_DIMENSION_DATA = [ 
            { sNumber: 'AAA', color: '#333333', textColor: '#F5F5F5' }, 
            { sNumber: 'KRE', color: '#EEAFA7', textColor: '#333333' }, 
            { sNumber: 'LOVE', color: '#FFF3EB', textColor: '#FF4499' }, 
            { sNumber: 'EVOL', color: '#0D549A', textColor: '#F5F5F5' }, 
            { sNumber: 'NXT', color: '#0C324D', textColor: '#F5F5F5' }, 
            { sNumber: 'Glow', color: '#DEFBE9', textColor: '#333333' }, 
            { sNumber: 'Aria', color: '#C8A2C8', textColor: '#F5F5F5' }, 
            { sNumber: 'VV', color: '#947CAD', textColor: '#F5F5F5' }, 
            { sNumber: 'Hatch!', color: '#EECBE1', textColor: '#333333' }, 
            { sNumber: 'Alphie', color: '#6C81AC', textColor: '#333333' }, 
            { sNumber: 'Moon', color: '#333333', textColor: '#7BBA8D' }, 
            { sNumber: 'Sun', color: '#333333', textColor: '#D51313' }, 
            { sNumber: 'Neptune', color: '#333333', textColor: '#22AEFF' }, 
            { sNumber: 'Zenith', color: '#333333', textColor: '#52D9BB' }
        ];

        const GAME_MODHAUS_DATA = [
            { sNumber: 'X', kor: 'Ïã§Ìå®', eng: 'Fail', color: '#F5F5F5', birthday: '08-08', type: 'fail_card' },
            { sNumber: 'MH', kor: 'Ï†úÏù¥Îì†', eng: 'Jaden', color: '#333333', birthday: '05-01', type: 'joker_card' }
        ];

        const GAME_ARTMS_DATA = [
            { sNumber: 'A1', kor: 'Ìù¨ÏßÑ', eng: 'HeeJin', color: '#ED008F', birthday: '10-19', type: 'goddess_card' },
            { sNumber: 'A2', kor: 'ÌïòÏä¨', eng: 'HaSeul', color: '#01C261', birthday: '08-18', type: 'goddess_card' },
            { sNumber: 'A3', kor: 'ÍπÄÎ¶Ω', eng: 'Kim Lip', color: '#DB3547', birthday: '02-10', type: 'goddess_card' },
            { sNumber: 'A4', kor: 'ÏßÑÏÜî', eng: 'JinSoul', color: '#1724A7', birthday: '06-13', type: 'goddess_card' },
            { sNumber: 'A5', kor: 'ÏµúÎ¶¨', eng: 'Choerry', color: '#5B2A93', birthday: '06-04', type: 'goddess_card' }
        ];

        const GAME_FRIEND_DATA = [
            { sNumber: 'BB', kor: 'ÎπÑÎπÑ', eng: 'BIBI', color: '#AAAAAA', birthday: '09-27', type: 'friend_card' },
            { sNumber: 'HS', kor: 'ÌòïÏÑú', eng: 'HyungSeo', color: '#AAAAAA', birthday: '06-25', type: 'friend_card' },
            { sNumber: 'JM', kor: 'ÏßÄÎØº', eng: 'JiMin', color: '#AAAAAA', birthday: '11-25', type: 'friend_card' },
            { sNumber: 'BE', kor: 'Î≥¥ÏùÄ', eng: 'BoEun', color: '#AAAAAA', birthday: '02-11', type: 'friend_card' },
            { sNumber: 'YA', kor: 'Ïú§ÏïÑ', eng: 'YunAh', color: '#AAAAAA', birthday: '01-15', type: 'friend_card' },
            { sNumber: 'MK', kor: 'Î™®Ïπ¥', eng: 'Moka', color: '#AAAAAA', birthday: '10-08', type: 'friend_card' },
            { sNumber: 'DH', kor: 'ÎèÑÌù¨', eng: 'DoHee', color: '#AAAAAA', birthday: '12-09', type: 'friend_card' },
            { sNumber: 'SJ', kor: 'ÏäπÏ£º', eng: 'SeungJoo', color: '#AAAAAA', birthday: '09-24', type: 'friend_card' },
            { sNumber: 'HR', kor: 'ÌïòÎ£®ÎÇò', eng: 'Haruna', color: '#AAAAAA', birthday: '01-30', type: 'friend_card' },
            { sNumber: 'YS', kor: 'ÏòàÏÑú', eng: 'YeSeo', color: '#AAAAAA', birthday: '08-22', type: 'friend_card' }
        ];

        const GAME_TRANSLATIONS_FALLBACK = {
            en: {
                "lang_select": "Language Select",
                "lang_desc": "Set the display language for in-game text.",
                
                "intro_line_0": "Welcome to MH, New Agent.\nYour mission is as follows:",
                "intro_line_1_a": "Craft the correct Objekt corresponding to the Order and deliver it to the Client.",
                "intro_line_1_b": "Match the Data pool items below accurately and Input them into the Slot.",
                "intro_line_1_c": "Remember, all Order Blocks have a strict deadline.",
                "intro_line_1_d": "Before deployment, you must fully understand the confidential data on the next page.",
                "intro_line_prompt": "...I don't tolerate mistakes. Are you up to it?",
                
                "item_reload_desc": "Purchase additional RELOAD counts. Max capacity is +20 times.",
                "item_timePlus_desc": "Improves transaction speed, securing an additional 2s block processing time.",
                "item_scan_desc": "Restores the color hints of Birthday blocks by locating lost data.",
                "item_amulet_desc": "Moon Goddess Amulet that rarely saves you from wrong data input.",
                "item_assist_desc": "Incorrect data rarely changes into an easier format to identify.",
                
                "boss_S_0": "You're quite capable. Only with this capability can you be my partner.",
                "boss_S_1": "It was a perfect job. Not just anyone receives an S.",
                "boss_S_2": "Hmm... I am satisfied with this. I trust you with the next one.",
                "boss_A_0": "A... Not bad. But aim for S.",
                "boss_A_1": "Excellent. But keep your guard up.",
                "boss_A_2": "Well done. Don't forget this feeling.",
                "boss_B_0": "B... You've passed average. Keep improving.",
                "boss_B_1": "I still see shortcomings. Work harder.",
                "boss_B_2": "Hey, New Agent. Show me a better performance tomorrow than today.",
                "boss_C_0": "C? ...We have a meeting tomorrow.",
                "boss_C_1": "...Is this your best?",
                "boss_C_2": "New Agent. Show me a better performance tomorrow than today.",
                "boss_F_0": "Contract expired. Security access revoked due to underperformance. Report immediately to Headquarters.",
                "boss_F_1": "Warning: Mission failed. Next stage progress has been suspended by the system.",
                "boss_F_2": "Contract terminated due to insufficient performance. No further mission assignment.",

                "ending_S_title": "PERFECT AGENT",
                "ending_S_desc": "You have achieved perfection in everything!\nYou are MH's S-Class Agent.",
                "ending_A_title": "ELITE AGENT",
                "ending_A_desc": "Excellent results.\nYou are MH's Elite Agent.",
                "ending_B_title": "GOOD AGENT",
                "ending_B_desc": "Mission completed safely.\nWe expect better results next time.",
                "ending_C_title": "AGENT",
                "ending_C_desc": "Mission completed.\n...However, the Boss seems unsatisfied.",
                "ending_F_title": "TERMINATED",
                "ending_F_desc": "Contract terminated due to failure to meet minimum required performance.",
                
                "gravity_desc_prefix": "Vote with COMO to decide",
                "gravity_desc_stage": "Stage",
                "gravity_desc_suffix": "which Dimension will perform!",

                "feedback_collect_full": "COLLECT FULL!",
                "feedback_not_enough_como": "NOT ENOUGH COMO!", 
                "feedback_amulet_activated": "‚ú® AMULET ACTIVATED! ‚ú®", 
                "feedback_joker_acquired": "‚ú® JOKER(MH) ACQUIRED! ‚ú®",
                "feedback_card_acquired": " Card Acquired!", 
                "feedback_grid_available": " GRID AVAILABLE!", 
                "feedback_grid_complete": "‚ú® GRID COMPLETE!",
                "feedback_need_four_cards": "You need 4 or more identical common cards!", 
                "feedback_spin_failed": "SPIN FAILED... Card Lost!", 
                "feedback_reload_penalty": "Score Penalty",

                "confirm_return_title": "‚ö†Ô∏è WARNING",
                "confirm_return_msg": "All current progress will be initialized.\nReturn to title?",

                "playing_next_block_boss": "WARNING: Detecting Dimension...",
                "playing_next_block_normal": "Receiving next block..."
            }
        };

        const GAME_AUDIO_CONFIG = {
            basePath: 'assets/audio/',
            bgm: {
                'start': 'bgm_title.mp3',
                'intro': 'bgm_title.mp3', 
                'ranking': 'bgm_title.mp3', 
                'settings': 'bgm_title.mp3', 
                'intermission': 'bgm_intermission.mp3',
                'playing': 'bgm_playing.mp3',
                'boss_playing': 'bgm_boss.mp3', 
                'gacha': 'bgm_intermission.mp3', 
                'submitScore': 'bgm_intermission.mp3',
                'ending': 'bgm_ending.mp3'
            },
            sfx: ['click', 'select', 'input', 'refresh', 'perfect', 'clear', 'fail', 'chain', 'warn', 'buy', 'gacha', 'data_select', 'stage_clear']
        };

        const GAME_BANNED_NAMES = ['SEX', 'ASS', 'FCK', 'FUK', 'KKK', 'NIG', 'GAY', 'TIT', 'CNT', 'ADM', 'SYS'];

        const GAME_SEASON_NAMES = ['Atom', 'Binary', 'Cream', 'Divine', 'Ever'];
        const GAME_SEASON_COLORS = {'Atom': '#FFDD00', 'Binary': '#00FF00', 'Cream': '#FF7477', 'Divine': '#B400FF', 'Ever': '#33ECFD'};

        const GAME_BASE_YEAR = 2025;
        const GAME_BASE_MONTH = 10;

        const GAME_GRADE_CRITERIA = [
            { grade: 'S', min: 65, bonus: 3, endingType: 'S' },
            { grade: 'A', min: 50, bonus: 2, endingType: 'A' },
            { grade: 'B', min: 35, bonus: 1, endingType: 'B' },
            { grade: 'C', min: 20, bonus: 0, endingType: 'C' },
            { grade: 'F', min: -999, bonus: 0, endingType: 'F' } // Í∏∞Î≥∏Í∞í (Fail)
        ];

        function game() {
            return {
                // --- STATE ---
                gameState: 'start', 
                previousGameState: 'start',
                introStep: 1,
                introTab: 'members',
                rankingTab: 'main',
                
                // Core Game
                stage: 1,
                score: 0,
                totalScore: 0,
                lastStageScore: 0,
                finalScore: 0,
                como: 5, 
                comoEarned: 0,
                bonusComo: 0,
                
                // Blocks & Timer
                currentBlock: null,
                blocksCompleted: 0,
                totalBlocksPerStage: 0,
                orderTimer: null,
                startTimer: null,
                isStarting: false,
                startCountdown: '',
                nextBlockWillBeBoss: false,
                
                // Scoring & Chain
                chainCount: 0,
                consecutivePerfects: 0,
                lastStageGrade: 'C',
                bossJComment: '',
                endingType: 'C',
                // [MODIFIED] stageGradesÎäî Ïù¥Ï†ú ÏµúÏ¢Ö Stage Grade Í∏∞Î°ùÏö©ÏúºÎ°úÎßå ÏÇ¨Ïö© (S1~S10)
                stageGrades: [], 
                
                // [NEW] ÏûÑÏãú Ï†ÄÏû•ÏÜå: ÌòÑÏû¨ Ïä§ÌÖåÏù¥ÏßÄÏùò Î™®Îì† Î∏îÎ°ù ÏÉÅÏÑ∏ Ï†êÏàò Í∏∞Î°ù
                currentStageBlockDetails: [],
                
                // [NEW] Î¶¨Î°úÎìú Ï¥ù Í∞êÏ†êÏï° Ï∂îÏ†Å
                reloadPenaltyTotal: 0, 

                // [NEW] Stage Report Data
                report: {
                    show: false,
                    stage: 0,
                    score: 0,
                    maxBlocks: 0,
                    clearedBlocks: 0, // ÏãúÍ∞Ñ Ï¥àÍ≥º ÏóÜÏù¥ ÏôÑÎ£åÎêú Î∏îÎ°ù Ïàò (processBlockCompleteÏóêÏÑú Ï¶ùÍ∞Ä)
                    baseScore: 0,
                    perfectBonusScore: 0,
                    chainBonusScore: 0,
                    failPenalty: 0,
                    timeOverPenalty: 0,
                    reloadPenalty: 0,
                    maxChain: 0,
                    perfectCount: 0,
                    unlockMessage: '', // Í∏∞Ï°¥ Í∞úÎ∞© ÏïåÎ¶º
                },

                // Data & Slots
                korData: [],
                engData: [],
                completedCards: [],
                selectedData: null,
                matchedOrderIndices: [],
                isDataReady: true, 
                
                // Inventory
                inventory: [],
                inventoryMaxSize: 12,
                selectedInventoryCard: null,
                
                // Items & Shop
                amuletLevel: 0,
                assistLevel: 0,
                timePlusLevel: 0,
                scanLevel: 0,
                reloadBoost: 20, 
                reloadCount: 10, 
                currentReloadPenalty: 5,
                
               // Modals
                shopModal: { show: false, item: '', title: '', desc: '', cost: 0, isMax: false },
                // [REMOVED] unlockModal: { show: false, title: '', message: '' }, // Stage Report ModalÎ°ú ÎåÄÏ≤¥Îê®
                returnConfirmModal: { show: false },
                resetConfirmModal: { show: false, type: 'all' },
                feedback: { show: false, message: '', type: 'correct', timer: null },
                suggestionModal: { show: false, message: '', isSending: false },
                badgeSelectModal: { show: false },
                accountModalShow: false,

                // Gacha
                gachaState: 'ready', 
                gachaResultCard: null,

                // Spin & Grid
                isSpinning: false,
                spinGrid: [],
                spinResult: null,
                selectedInventoryCardForSpin: null,
                intermissionSpinCount: 0,
                isCrafting: false,
                craftingCard: null,
                isSpinGridReady: true, 
                
                // Ranking
                highScores: [],
                extraHighScores: [],
                playerName: 'SSS',
                existingRecord: null, // Stores current user's record for update
                
                // User Account (UID Management)
                inputUid: '', // For input field in settings
                currentUid: 'CONNECTING...', 
                get activeUserId() {
                    return localStorage.getItem('objektRushCustomUid') || this.currentUid;
                },
                
                userProfile: {
                    unlockedBadges: [],
                    selectedBadge: 'üëæ'
                },
                isProfileLoading: true,
                
                // Gravity Vote
                localGravityVotes: {},
                seasonGravityVotes: {},
                seasonGravityListener: null,
                
                // Audio
                sounds: {}, 
                bgm: {}, 
                currentBGM: null, 
                bgmVolume: 0.3, 
                sfxVolume: 0.5,

                // Season & Time
                currentSeason: { id: '', name: '', cycle: 0, color: '#FFFFFF', state: 'active', dDay: 0, badge: 'üëæ', frozenText: '' }, 
                seasonNames: GAME_SEASON_NAMES,
                seasonColors: GAME_SEASON_COLORS,
                baseYear: GAME_BASE_YEAR, 
                baseMonth: GAME_BASE_MONTH,

                // Language
                currentLang: 'en', 
                supportedLangs: [
                    { code: 'en', name: 'English' }, 
                    { code: 'ko', name: 'ÌïúÍµ≠Ïñ¥ (Korean)' }, 
                    { code: 'ja', name: 'Êó•Êú¨Ë™û (Japanese)' },
                    { code: 'zh-CN', name: 'ÁÆÄ‰Ωì‰∏≠Êñá (Simplified)' },
                    { code: 'zh-TW', name: 'ÁπÅÈ´î‰∏≠Êñá (Traditional)' },
                    { code: 'th', name: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (Thai)' },
                    { code: 'vi', name: 'Ti·∫øng Vi·ªát (Vietnamese)' }
                ],
                translations: {}, 

                // Banned Nicknames (Simple Blacklist)
                bannedNames: GAME_BANNED_NAMES,
                
                // --- CONSTANTS ---
                DEFAULT_BADGE: GAME_DEFAULT_BADGE,
                SEASON_BADGE_TABLE: GAME_SEASON_BADGE_TABLE,
                ITEM_INFO: GAME_ITEM_INFO, // Í∏∞Ï°¥ Ïú†ÏßÄ
                BOSS_COMMENTS: GAME_BOSS_COMMENTS,
                ENDING_MESSAGES: GAME_ENDING_MESSAGES,
                
                stageConfig: GAME_STAGE_CONFIG,
                bossPools: GAME_BOSS_POOLS,

                memberData: [],
                dimensionData: [],
                modhausData: [],
                artmsData: [],
                friendData: [],

                // --- METHODS ---
                init() { 
                    // [FIX] Firebase SDK Î°úÎìú ÎåÄÍ∏∞ (Race Condition Î∞©ÏßÄ)
                    // fbCollectionÏù¥ÎÇò fbAuthÍ∞Ä ÏóÜÏúºÎ©¥ 100ms Îí§Ïóê initÏùÑ Îã§Ïãú ÏãúÎèÑÌï©ÎãàÎã§.
                    if (!window.fbCollection || !window.fbAuth) {
                        setTimeout(() => this.init(), 100);
                        return;
                    }

                    this.loadSettings(); 
                    this.loadLanguage(); 
                    this.calculateSeasonLogic(); 
                    
                    // [FIX] Ï§ëÎ≥µ Î¶¨Ïä§ÎÑà Îì±Î°ù Î∞©ÏßÄ
                    // initÏù¥ Ïû¨Ïã§ÌñâÎêòÎçîÎùºÎèÑ Î¶¨Ïä§ÎÑàÎäî Ìïú Î≤àÎßå Îì±Î°ùÌï©ÎãàÎã§.
                    if (!window._objektRushInitDone) {
                        this.listenForAuth(); 
                        this.loadMemberData(); 
                        this.loadHighScores(); 
                        this.loadExtraHighScores(); 
                        this.setDynamicHeight(); 
                        window.addEventListener('resize', this.setDynamicHeight.bind(this)); 
                        this.initSounds(); 
                        this.$watch('gameState', (newState) => { 
                            this.switchBGM(newState);
                            if (newState === 'intermission') { this.initializeGravityVotes(); } 
                        }); 
                        this.switchBGM('start');

                        // ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî Ïãú BGM ÏùºÏãúÏ†ïÏßÄ
                        window.addEventListener('blur', () => {
                            if (this.currentBGM) this.currentBGM.pause();
                        });
                        
                        // ÌÉ≠ ÌôúÏÑ±Ìôî Ïãú BGM Ïû¨Í∞ú
                        window.addEventListener('focus', () => {
                            if (this.currentBGM) {
                                // [FIX] GAME_AUDIO_CONFIG.bgm ÏÇ¨Ïö©
                                const bgmName = GAME_AUDIO_CONFIG.bgm[this.gameState];
                                if (bgmName) {
                                    if (this.gameState === 'intermission' && this.lastStageGrade === 'F') {
                                        // Do nothing
                                    } else {
                                        this.currentBGM.play().catch(() => {});
                                    }
                                }
                            }
                        });

                        window._objektRushInitDone = true;
                    }
                },

                // [NEW] Îì±Í∏â Í≥ÑÏÇ∞ ÌÜµÌï© Ìï®Ïàò (Ï†êÏàò -> Îì±Í∏â Ï†ïÎ≥¥ Î∞òÌôò)
                calcGrade(averageScore) {
                    return GAME_GRADE_CRITERIA.find(c => averageScore >= c.min) || GAME_GRADE_CRITERIA[GAME_GRADE_CRITERIA.length - 1];
                },

                listenForAuth() {
                    if (!window.fbOnAuthStateChanged) {
                        console.warn("Auth listener not ready, retrying in 200ms...");
                        setTimeout(() => this.listenForAuth(), 200);
                        return;
                    }
                    
                    window.fbOnAuthStateChanged(window.fbAuth, (user) => {
                        if (user) {
                            // customUidÍ∞Ä ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏßÄ ÏïäÏùÑ ÎïåÎßå auth uidÎ•º ÏÇ¨Ïö©
                            if (!localStorage.getItem('objektRushCustomUid')) {
                                this.currentUid = user.uid;
                            }
                            console.log("Auth State Changed, UID set:", user.uid);
                            
                            this.loadUserProfile();
                            this.checkAndGrantSeasonBadge();

                        } else {
                            this.currentUid = 'ERROR';
                            this.isProfileLoading = false;
                            console.log("User is signed out.");
                        }
                    });
                    // ÏàòÎèô UIDÍ∞Ä Ïù¥ÎØ∏ ÏûàÎã§Î©¥ Ï¶âÏãú Î∞òÏòÅ
                    if (localStorage.getItem('objektRushCustomUid')) {
                        this.currentUid = localStorage.getItem('objektRushCustomUid');
                        this.loadUserProfile();
                        this.checkAndGrantSeasonBadge();
                    }
                },

                async loadUserProfile() {
                    if (!this.activeUserId || this.activeUserId === 'CONNECTING...') {
                        console.warn("loadUserProfile called before activeUserId is ready.");
                        return;
                    }
                    
                    this.isProfileLoading = true;
                    const docRef = window.fbDoc(window.fbDb, "userProfiles", this.activeUserId);
                    
                    try {
                        const docSnap = await window.fbGetDoc(docRef);
                        
                        if (docSnap.exists()) {
                            this.userProfile = docSnap.data();
                            if (!this.userProfile.unlockedBadges || !this.userProfile.unlockedBadges.includes(this.DEFAULT_BADGE)) {
                                this.grantBadge(this.DEFAULT_BADGE, false); // ÌîºÎìúÎ∞± ÏóÜÏù¥ Ï°∞Ïö©Ìûà Ï∂îÍ∞Ä
                            }
                        } else {
                            // This is a new user, create their profile
                            const newProfile = { 
                                unlockedBadges: [this.DEFAULT_BADGE], // Í∏∞Î≥∏ Î∞∞ÏßÄ ÏßÄÍ∏â
                                selectedBadge: this.DEFAULT_BADGE 
                            };
                            await window.fbSetDoc(docRef, newProfile);
                            this.userProfile = newProfile;
                            console.log("New user profile created with default badge.");
                        }
                    } catch (e) {
                        console.error("Error loading user profile: ", e);
                    } finally {
                        this.isProfileLoading = false;
                    }
                },

                async checkAndGrantSeasonBadge() {
                    if (!this.activeUserId || this.activeUserId === 'CONNECTING...') return;
                    // ÎπÑÏãúÏ¶å Í∏∞Í∞ÑÏù¥ ÏïÑÎãàÎ©¥ Ïã§Ìñâ Ïïà Ìï®
                    if (this.currentSeason.state !== 'frozen') return; 

                    // KST Í∏∞Ï§Ä, 'Ïò§Îäò'Ïù¥ ÏïÑÎãå 'ÏßÄÎÇú Îã¨'Ïùò ÏãúÏ¶å Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏ÏôÄÏïº Ìï®
                    const kstDate = new Date(new Date().getTime() + (new Date().getTimezoneOffset() * 60000) + (9 * 60 * 60 * 1000));
                    const lastMonthDate = new Date(kstDate.getFullYear(), kstDate.getMonth() - 1, 1);
                    
                    const prevMonthsPassed = (lastMonthDate.getFullYear() - this.baseYear) * 12 + (lastMonthDate.getMonth() - this.baseMonth);
                    
                    if (prevMonthsPassed < 0) return; // Ï≤´ ÏãúÏ¶å Ïù¥Ï†Ñ

                    const prevSeason = this.getSeasonInfo(prevMonthsPassed);
                    const badgeToGrant = prevSeason.badge;
                    const checkedKey = `badge_checked_${prevSeason.id}`;

                    // Ïù¥ÎØ∏ Ïù¥Î≤à ÎπÑÏãúÏ¶åÏóê Î≥¥ÏÉÅÏùÑ Ï≤¥ÌÅ¨ÌñàÏúºÎ©¥ Ïã§Ìñâ Ïïà Ìï®
                    if (localStorage.getItem(checkedKey)) return;

                    try {
                        // ÏßÄÎÇú ÏãúÏ¶å Îû≠ÌÇπÏóê Ïù¥ Ïú†Ï†ÄÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
                        const q = window.fbQuery(
                            window.fbCollection(window.fbDb, "ranks"),
                            window.fbWhere("season", "==", prevSeason.id),
                            window.fbWhere("userId", "==", this.activeUserId),
                            window.fbLimit(1)
                        );
                        
                        const rankSnapshot = await window.fbGetDocs(q);
                        
                        if (!rankSnapshot.empty) {
                            // Îû≠Ïª§ÏòÄÏùå! Î∞∞ÏßÄ ÏßÄÍ∏â
                            await this.grantBadge(badgeToGrant, true); // ÌîºÎìúÎ∞±Í≥º Ìï®Íªò ÏßÄÍ∏â
                        }
                        
                        // Îû≠Ïª§ÏòÄÎì† ÏïÑÎãàÎì†, Ï≤¥ÌÅ¨ ÏÇ¨Ïã§ÏùÑ Î°úÏª¨Ïóê Ï†ÄÏû• (DB Ìò∏Ï∂ú Î∞©ÏßÄ)
                        localStorage.setItem(checkedKey, 'true');

                    } catch (e) {
                        console.error("Error checking season badge reward: ", e);
                    }
                },

                async grantBadge(badgeEmoji, showFeedbackMsg = true) {
                    if (!this.activeUserId || this.activeUserId === 'CONNECTING...') return;
                    // Ï§ëÎ≥µ ÏßÄÍ∏â Î∞©ÏßÄ ( grantBadgeÍ∞Ä loadUserProfileÎ≥¥Îã§ Î®ºÏ†Ä Ìò∏Ï∂úÎê† Ïàò ÏûàÏúºÎØÄÎ°ú, userProfile.unlockedBadges ÎåÄÏã† getDocÏùÑ ÌïúÎ≤à Îçî Ìï®)
                    const docRef = window.fbDoc(window.fbDb, "userProfiles", this.activeUserId);
                    const docSnap = await window.fbGetDoc(docRef);

                    if (docSnap.exists() && docSnap.data().unlockedBadges && docSnap.data().unlockedBadges.includes(badgeEmoji)) {
                        return; // Ïù¥ÎØ∏ ÏûàÏùå
                    }
                    
                    try {
                        // setDoc(docRef, { unlockedBadges: window.fbArrayUnion(badgeEmoji) }, { merge: true }); ÏôÄ ÎèôÏùºÌïú Ìö®Í≥º
                        await window.fbUpdateDoc(docRef, {
                            unlockedBadges: window.fbArrayUnion(badgeEmoji)
                        });
                        
                        // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Ï¶âÏãú Í∞±Ïã†
                        if (!this.userProfile.unlockedBadges.includes(badgeEmoji)) {
                            this.userProfile.unlockedBadges.push(badgeEmoji);
                        }
                        
                        if (showFeedbackMsg) {
                            this.showFeedback(`REWARD: ${badgeEmoji} UNLOCKED!`, 'correct');
                        }
                    } catch (e) {
                         // userProfiles Î¨∏ÏÑúÍ∞Ä ÏïÑÏßÅ ÏóÜÎäî Í∑πÏ¥àÍ∏∞ Ïú†Ï†ÄÍ∞Ä Îû≠Ïª§Í∞Ä ÎêòÏñ¥ ÎπÑÏãúÏ¶åÏóê Ï†ëÏÜçÌïú Í≤ΩÏö∞, updateÍ∞Ä Ïã§Ìå®Ìï† Ïàò ÏûàÏùå.
                        if (e.code === 'not-found') {
                            console.warn("Profile not found on grantBadge, creating with badge...");
                            await window.fbSetDoc(docRef, {
                                unlockedBadges: [this.DEFAULT_BADGE, badgeEmoji],
                                selectedBadge: this.DEFAULT_BADGE
                            });
                            this.userProfile.unlockedBadges = [this.DEFAULT_BADGE, badgeEmoji];
                            if (showFeedbackMsg) {
                                this.showFeedback(`REWARD: ${badgeEmoji} UNLOCKED!`, 'correct');
                            }
                        } else {
                            console.error("Error granting badge: ", e);
                        }
                    }
                },

                openBadgeModal() {
                    this.playSound('click');
                    this.badgeSelectModal.show = true;
                },
                closeBadgeModal() {
                    this.playSound('click');
                    this.badgeSelectModal.show = false;
                },
                async selectBadge(badgeEmoji) {
                    this.playSound('input');
                    if (!this.activeUserId || this.activeUserId === 'CONNECTING...') return;

                    this.userProfile.selectedBadge = badgeEmoji; // UI Ï¶âÏãú Î∞òÏòÅ
                    const docRef = window.fbDoc(window.fbDb, "userProfiles", this.activeUserId);
                    
                    try {
                        await window.fbUpdateDoc(docRef, { selectedBadge: badgeEmoji });
                        this.showFeedback('BADGE SET!', 'correct');
                    } catch (e) {
                        console.error("Error setting badge: ", e);
                        this.showFeedback('SET FAILED', 'incorrect');
                        // Ïã§Ìå® Ïãú Î°§Î∞± (ÏïàÏ†Ñ Ïû•Ïπò)
                        this.loadUserProfile(); 
                    } finally {
                        this.closeBadgeModal();
                    }
                },

                getSeasonInfo(monthsPassed) {
                    if (monthsPassed < 0) monthsPassed = 0; // Ï≤´ ÏãúÏ¶å Ïù¥Ï†Ñ Î∞©ÏßÄ

                    const nameIndex = monthsPassed % this.seasonNames.length;
                    const cycleNumber = Math.floor(monthsPassed / this.seasonNames.length) + 1;
                    const seasonName = this.seasonNames[nameIndex];
                    const seasonId = `${seasonName}${String(cycleNumber).padStart(2, '0')}`;
                    
                    // Î≥¥ÏÉÅ Î∞∞ÏßÄ Î£®ÌîÑ
                    const badge = this.SEASON_BADGE_TABLE[monthsPassed % this.SEASON_BADGE_TABLE.length];
                    
                    // ÏãúÏ¶å ÏãúÏûë ÎÇ†Ïßú Í≥ÑÏÇ∞
                    const startDate = new Date(this.baseYear, this.baseMonth + monthsPassed, 1);
                    const yyyy = startDate.getFullYear();
                    const mm = String(startDate.getMonth() + 1).padStart(2, '0');
                    const dd = '01';

                    return {
                        id: seasonId,
                        name: seasonName,
                        cycle: cycleNumber,
                        color: this.seasonColors[seasonName],
                        badge: badge,
                        startDate: `${yyyy}.${mm}.${dd}`
                    };
                },

                calculateSeasonLogic() {
                    const now = new Date();
                    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                    const kstOffset = 9 * 60 * 60 * 1000;
                    const kstDate = new Date(utc + kstOffset);
                    
                    const currentYear = kstDate.getFullYear();
                    const currentMonth = kstDate.getMonth(); 
                    const currentDay = kstDate.getDate();
                    const currentHour = kstDate.getHours();

                    // ÌòÑÏû¨ KST Í∏∞Ï§Ä 'Îã¨'Ïù¥ Î™á Î≤àÏß∏ ÏãúÏ¶åÏù∏ÏßÄ Í≥ÑÏÇ∞
                    const currentMonthsPassed = (currentYear - this.baseYear) * 12 + (currentMonth - this.baseMonth);
                    
                    let seasonInfo;
                    let seasonState = 'active';
                    let dDay = 0;
                    let frozenText = '';

                    // 1. ÏãúÏ¶å ÎßàÍ∞ê (25Ïùº 00:00 ~ 27Ïùº 00:00)
                    if (currentDay >= 25 && currentDay < 27) {
                        seasonState = 'frozen';
                        seasonInfo = this.getSeasonInfo(currentMonthsPassed); // ÌòÑÏû¨ ÏãúÏ¶å Ï†ïÎ≥¥
                        frozenText = `Close the ${seasonInfo.id}`;
                    }
                    // 2. Îã§Ïùå ÏãúÏ¶å Ï§ÄÎπÑ (27Ïùº 00:00 ~ Îã§ÏùåÎã¨ 1Ïùº 10:00)
                    else if (currentDay >= 27) {
                        seasonState = 'frozen';
                        seasonInfo = this.getSeasonInfo(currentMonthsPassed); // ÌòÑÏû¨ ÏãúÏ¶å Ï†ïÎ≥¥ (ÌëúÏãúÏö©)
                        const nextSeason = this.getSeasonInfo(currentMonthsPassed + 1);
                        frozenText = `Dive into ${nextSeason.id} ${nextSeason.startDate} 10:00 KST`;
                    }
                    // 3. Îã§Ïùå ÏãúÏ¶å ÎãπÏùº Ïò§Ï†Ñ (1Ïùº 00:00 ~ 1Ïùº 10:00)
                    else if (currentDay === 1 && currentHour < 10) {
                        seasonState = 'frozen';
                        seasonInfo = this.getSeasonInfo(currentMonthsPassed - 1); // *Ïù¥Ï†Ñ* ÏãúÏ¶å Ï†ïÎ≥¥ (ÌëúÏãúÏö©)
                        const nextSeason = this.getSeasonInfo(currentMonthsPassed); // *ÌòÑÏû¨* ÏãúÏ¶åÏù¥ Îã§Ïùå ÏãúÏ¶å
                        frozenText = `Dive into ${nextSeason.id} ${nextSeason.startDate} 10:00 KST`;
                    }
                    // 4. ÏãúÏ¶å ÏßÑÌñâ Ï§ë (1Ïùº 10:00 ~ 25Ïùº 00:00)
                    else {
                        seasonState = 'active';
                        seasonInfo = this.getSeasonInfo(currentMonthsPassed);
                        dDay = 25 - currentDay; // ÎßàÍ∞êÏùº 25Ïùº 00:00 Í∏∞Ï§Ä
                    }

                    this.currentSeason = {
                        ...seasonInfo,
                        state: seasonState,
                        dDay: dDay,
                        frozenText: frozenText
                    };
                    
                    console.log(`Current Season Logic (KST): ${this.currentSeason.id} / State: ${this.currentSeason.state}`);
                },
                
                openSuggestionModal() {
                    this.playSound('click');
                    this.suggestionModal.show = true;
                    this.suggestionModal.message = '';
                    this.suggestionModal.isSending = false;
                },
                closeSuggestionModal() {
                    this.playSound('click');
                    this.suggestionModal.show = false;
                },

                openAccountModal() {
                    this.playSound('click');
                    this.accountModalShow = true;
                },
                closeAccountModal() {
                    this.playSound('click');
                    this.accountModalShow = false;
                },
                async sendSuggestion() {
                    if (!this.suggestionModal.message.trim()) return;
                    
                    this.playSound('click');
                    this.suggestionModal.isSending = true;
                    
                    try {
                        await window.fbAddDoc(window.fbCollection(window.fbDb, "suggestions"), {
                            message: this.suggestionModal.message,
                            timestamp: window.fbServerTimestamp(),
                            userAgent: navigator.userAgent,
                            lang: this.currentLang,
                            version: 'v10.311'
                        });
                        
                        this.showFeedback('MESSAGE SENT!', 'correct');
                        this.suggestionModal.message = '';
                        setTimeout(() => {
                            this.closeSuggestionModal();
                        }, 1000);
                    } catch (e) {
                        console.error("Error sending suggestion: ", e);
                        this.showFeedback('SEND FAILED', 'incorrect');
                        this.suggestionModal.isSending = false;
                    }
                },

                loadLanguage() {
                    const savedLang = localStorage.getItem('objektRushLanguage');
                    const defaultLangCode = 'en';
                    
                    if (savedLang && this.supportedLangs.some(l => l.code === savedLang)) {
                        this.currentLang = savedLang;
                    } else {
                        this.currentLang = defaultLangCode;
                    }
                    this.loadTranslationData(this.currentLang);
                },

                async loadTranslationData(langCode) {
                    // 1. ÏΩîÎìú ÎÇ¥Ïû• Îç∞Ïù¥ÌÑ∞(ÏòÅÏñ¥)Í∞Ä ÏûàÏúºÎ©¥ Ï¶âÏãú ÏÇ¨Ïö© (ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠ X)
                    if (GAME_TRANSLATIONS_FALLBACK[langCode]) {
                        this.translations = GAME_TRANSLATIONS_FALLBACK[langCode];
                        console.log(`Loaded embedded translation for: ${langCode}`);
                        return;
                    }

                    // 2. ÎÇ¥Ïû• Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Ïô∏Î∂Ä JSON ÌååÏùº Î°úÎìú ÏãúÎèÑ (ÌïúÍµ≠Ïñ¥ Îì±)
                    try {
                        const response = await fetch(`assets/locales/${langCode}.json`);
                        if (!response.ok) throw new Error('File not found');
                        const externalTranslations = await response.json();
                        this.translations = externalTranslations;
                        console.log(`Loaded external translation for: ${langCode}`);
                    } catch (error) {
                        console.warn(`Failed to load translation for ${langCode}. Using embedded English fallback.`, error);
                        // 3. Î°úÎìú Ïã§Ìå® Ïãú(Î°úÏª¨ ÌôòÍ≤Ω, ÌååÏùº ÎàÑÎùΩ Îì±) ÎÇ¥Ïû•Îêú ÏòÅÏñ¥ Îç∞Ïù¥ÌÑ∞Î°ú ÏïàÏ†ÑÌïòÍ≤å ÎåÄÏ≤¥
                        this.translations = GAME_TRANSLATIONS_FALLBACK['en']; 
                    }
                },

                translate(key) {
                    return this.translations[key] || `[${key}]`;
                },

                setLanguage(langCode) {
                    this.playSound('click');
                    this.currentLang = langCode;
                    this.loadTranslationData(langCode); 
                    localStorage.setItem('objektRushLanguage', langCode);
                },
                
                loadSettings() {
                    const savedBGMVolume = localStorage.getItem('objektRushBGMVolume');
                    const savedSFXVolume = localStorage.getItem('objektRushSFXVolume');

                    if (savedBGMVolume !== null) this.bgmVolume = parseFloat(savedBGMVolume);
                    if (savedSFXVolume !== null) this.sfxVolume = parseFloat(savedSFXVolume);
                },

                saveSettings() {
                    localStorage.setItem('objektRushBGMVolume', this.bgmVolume.toFixed(2));
                    localStorage.setItem('objektRushSFXVolume', this.sfxVolume.toFixed(2));
                },
                
                // --- User ID Management ---
                async copyUid() {
                    if (!this.activeUserId || this.activeUserId === 'CONNECTING...') return;
                    
                    // Î∏åÎùºÏö∞Ï†Ä ÏßÄÏõê Ïó¨Î∂Ä ÌôïÏù∏ (ÏïàÏ†Ñ Ïû•Ïπò)
                    if (!navigator.clipboard) {
                        this.showFeedback('NOT SUPPORTED', 'incorrect');
                        return;
                    }

                    try {
                        // Ïã†Ìòï ÎπÑÎèôÍ∏∞ Î≥µÏÇ¨ API ÏÇ¨Ïö©
                        await navigator.clipboard.writeText(this.activeUserId);
                        this.showFeedback('UID COPIED!', 'correct');
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        this.showFeedback('COPY FAILED', 'incorrect');
                    }
                },
                
                loadUid() {
                    if (!this.inputUid || this.inputUid.length < 5) {
                         this.showFeedback('INVALID UID', 'incorrect');
                         return;
                    }
                    this.playSound('click');
                    localStorage.setItem('objektRushCustomUid', this.inputUid);
                    this.showFeedback('ACCOUNT SWITCHED!', 'correct');
                    setTimeout(() => location.reload(), 1000);
                },

                resetUid() {
                    this.playSound('click');
                    localStorage.removeItem('objektRushCustomUid');
                    this.showFeedback('RESET TO DEFAULT', 'correct');
                    setTimeout(() => location.reload(), 1000);
                },
                
                switchBGM(newState) {
                    if (this.currentBGM) {
                        this.currentBGM.pause();
                    }
                    
                    // [FIX] GAME_AUDIO_CONFIG.bgm ÏßÅÏ†ë Ï∞∏Ï°∞
                    const bgmName = GAME_AUDIO_CONFIG.bgm[newState];

                    if (newState === 'intermission' && this.lastStageGrade === 'F') {
                        this.currentBGM = null;
                        return;
                    }
                    
                    if (bgmName) {
                        let audio = this.bgm[bgmName];
                        if (!audio) {
                            // [FIX] GAME_AUDIO_CONFIG.basePath ÏÇ¨Ïö©
                            audio = new Audio(`${GAME_AUDIO_CONFIG.basePath}${bgmName}`); 
                            audio.loop = true;
                            this.bgm[bgmName] = audio;
                        }
                        this.currentBGM = audio;
                        audio.volume = this.bgmVolume;
                        audio.play().catch(() => {});
                    } else {
                        this.currentBGM = null;
                    }
                },
                
                updateBGMVolume(event) {
                    this.bgmVolume = parseFloat(event.target.value);
                    if (this.currentBGM) {
                        this.currentBGM.volume = this.bgmVolume;
                    }
                    this.saveSettings();
                },

                updateSFXVolume(event) {
                    this.sfxVolume = parseFloat(event.target.value);
                    this.saveSettings();
                    this.playSound('click'); 
                },

                initSounds() {
                    // [REFACTOR] GAME_AUDIO_CONFIG ÏÉÅÏàò ÌôúÏö©
                    GAME_AUDIO_CONFIG.sfx.forEach(s => {
                        this.sounds[s] = new Audio(`${GAME_AUDIO_CONFIG.basePath}sfx_${s}.mp3`);
                        this.sounds[s].volume = this.sfxVolume;
                    });

                    this.$watch('sfxVolume', (newVolume) => {
                        for (const key in this.sounds) {
                            if (this.sounds[key] instanceof Audio) {
                                this.sounds[key].volume = newVolume;
                            }
                        }
                    });
                },
                playSound(name) {
                    let audio;
                    const soundEntry = this.sounds[name];
                    
                    if (soundEntry instanceof Audio) {
                        audio = soundEntry;
                    } else {
                        return;
                    }

                    if (audio) {
                        audio.currentTime = 0; 
                        audio.play().catch(() => {}); 
                    }
                },
                setDynamicHeight() { const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); },
                loadMemberData() {
                    this.memberData = GAME_MEMBER_DATA;
                    this.dimensionData = GAME_DIMENSION_DATA;
                    this.modhausData = GAME_MODHAUS_DATA;
                    this.artmsData = GAME_ARTMS_DATA;
                    this.friendData = GAME_FRIEND_DATA;
                },

                async loadHighScores() {
                    const q = window.fbQuery(
                        window.fbCollection(window.fbDb, "ranks"), 
                        window.fbWhere("type", "==", "main"),
                        window.fbWhere("season", "==", this.currentSeason.id),
                        window.fbOrderBy("score", "desc"), 
                        window.fbLimit(24) // 24Ïù∏ÏúºÎ°ú ÌôïÏû•
                    );
                    try {
                        const querySnapshot = await window.fbGetDocs(q);
                        this.highScores = [];
                        querySnapshot.forEach((doc) => {
                            this.highScores.push(doc.data());
                        });
                    } catch (e) {
                        console.error("Error loading main ranks: ", e);
                        this.highScores = [];
                    }
                },
                saveHighScores() { }, 

                async loadExtraHighScores() {
                    const q = window.fbQuery(
                        window.fbCollection(window.fbDb, "ranks"), 
                        window.fbWhere("type", "==", "extra"),
                        window.fbWhere("season", "==", this.currentSeason.id),
                        window.fbOrderBy("score", "desc"), 
                        window.fbLimit(24) // 24Ïù∏ÏúºÎ°ú ÌôïÏû•
                    );
                    try {
                        const querySnapshot = await window.fbGetDocs(q);
                        this.extraHighScores = [];
                        querySnapshot.forEach((doc) => {
                            this.extraHighScores.push(doc.data());
                        });
                    } catch (e) {
                         console.error("Error loading extra ranks: ", e);
                         this.extraHighScores = [];
                    }
                },
                saveExtraHighScores() { },

                showRanking() { this.playSound('click'); this.previousGameState = this.gameState; this.loadHighScores(); this.loadExtraHighScores(); this.rankingTab = 'main'; this.gameState = 'ranking'; },
                showSettings() { this.playSound('click'); this.previousGameState = this.gameState; this.gameState = 'settings'; }, 
                startGame(isContinuing = false) {
                    this.playSound('click');
                    if (!isContinuing) {
                        this.stage = 1; 
                        this.como = 5; 
                        this.totalScore = 0; 
                        this.amuletLevel = 0; this.assistLevel = 0; this.timePlusLevel = 0; this.scanLevel = 0; 
                        this.reloadBoost = 20; 
                        this.inventory = []; 
                        
                        for (let i = 0; i < 3; i++) {
                            const randomMember = this.memberData[Math.floor(Math.random() * this.memberData.length)];
                            this.inventory.push({
                                ...randomMember,
                                inventoryId: Date.now() + Math.random(),
                                isSpecial: false,
                                type: 'member_card'
                            });
                        }

                        this.gravityVotes = {}; 
                        this.stageGrades = []; 
                        this.gameState = 'intro'; this.introStep = 1;
                    } else {
                        this.gameState = 'intermission';
                        this.startStageLogic(); 
                    }
                },
                nextIntroStep() { this.playSound('click'); this.introStep++; },
                startActualGame() { 
                    this.playSound('click'); 
                    this.gameState = 'playing'; 
                    this.startStageLogic(); 
                },
                handleIntermissionNext() {
                    this.playSound('click');
                    // [MODIFIED] Î™®Îã¨Ïù¥ Îã´Ìûå ÌõÑ Îã§Ïùå Îã®Í≥ÑÎ°ú ÏßÑÌñâ (goToIntermissionÏùò proceedToNextState Î°úÏßÅÍ≥º Ïó∞Í≥Ñ)
                    this.report.show = false; // ÌòπÏãú Î™®Î•º Í≤ΩÏö∞Î•º ÎåÄÎπÑÌï¥ ÌôïÏã§Ìûà Îã´Ïùå
                    this.nextStage();
                },
                nextStage() {
                    this.currentBlock = null; 
                    this.completedCards = [];
                    this.matchedOrderIndices = []; 
                    this.gameState = 'transition'; 
                    setTimeout(() => {
                        this.gameState = 'playing'; 
                        this.startStageLogic(); 
                    }, 0); 
                },
                startStageLogic() {
                    const configIndex = Math.min(this.stage - 1, this.stageConfig.length - 1); 
                    const config = this.stageConfig[configIndex]; 
                    if (!config) { console.error(`Stage config for stage ${this.stage} not found.`); return; }
                    this.targetScore = 0; 
                    this.totalBlocksPerStage = config.blocks + config.bosses.length; 
                    this.decoyRatio = config.decoy;
                    
                    this.reloadCount = 10 + this.reloadBoost; 
                    this.currentReloadPenalty = 5; 
                    
                    this.score = 0; 
                    this.blocksCompleted = 0; 
                    this.chainCount = 0; 
                    this.consecutivePerfects = 0;

                    this.stageNormalBlockScore = 0;
                    this.stageNormalBlockCount = 0;

                    this.currentStageBlockDetails = [];
                    this.reloadPenaltyTotal = 0;

                    this.nextBlockWillBeBoss = false; 
                    this.currentBlock = null; 
                    this.completedCards = []; 
                    this.selectedData = null; 
                    this.selectedInventoryCard = null; 
                    
                    this.startCountdownSequence(); 
                },
                startCountdownSequence() {
                    this.isStarting = true; 
                    this.startCountdown = this.stage >= 11 ? 'OVERTIME' : `STAGE ${this.stage}`;
                    clearTimeout(this.startTimer); 
                    this.startTimer = setTimeout(() => {
                        if (this.gameState !== 'playing') { clearTimeout(this.startTimer); return; }
                        this.startCountdown = 'START!';
                        this.startTimer = setTimeout(() => {
                            if (this.gameState !== 'playing') { clearTimeout(this.startTimer); return; }
                            this.isStarting = false; 
                            this.generateNewBlock(); 
                            this.refillData(true); 
                        }, 500); 
                    }, 1000); 
                },
                startBlockTimer() {
                    clearInterval(this.orderTimer);
                    this.orderTimer = setInterval(() => {
                        if (this.gameState !== 'playing' || this.isStarting || !this.currentBlock) { clearInterval(this.orderTimer); return; }
                        this.currentBlock.timer = Math.max(0, this.currentBlock.timer - 100);
                        if (this.currentBlock.timer <= 0) { this.processBlockFailure(); }
                    }, 100);
                },
                getStageBaseComo() {
                    if (this.stage >= 10 && this.stage <= 11) return 5; 
                    if (this.stage >= 7) return 4; 
                    if (this.stage >= 4) return 3; 
                    if (this.stage >= 1) return 2; 
                    return 0; 
                },
                // game.goToIntermission() Ìï®Ïàò (Ï†ÑÏ≤¥ ÍµêÏ≤¥)
                goToIntermission() { 
                    clearInterval(this.orderTimer); 
                    
                    // Ïù¥Ï†Ñ Ïä§ÌÖåÏù¥ÏßÄÏùò Ï¥ù Ï†êÏàòÏôÄ ÌòÑÏû¨ Ïä§ÏΩîÏñ¥Î•º ÎçîÌï¥ ÎàÑÏ†Å Ï¥ùÏ†ê Í≥ÑÏÇ∞
                    this.totalScore += this.score; 
                    this.lastStageScore = this.score; 
                    this.selectedInventoryCard = null; 
                    
                    // Î¶¨Î°úÎìú ÏûîÏó¨ Î∂ÄÏä§Ìä∏ Í≥ÑÏÇ∞
                    const remainingBoost = Math.max(0, this.reloadCount - 10);
                    this.reloadBoost = remainingBoost;
                    
                    this.comoEarned = this.getStageBaseComo();
                    this.intermissionSpinCount = 0; 
                    
                    // [UPDATE] ÌèâÍ∑† Ï†êÏàò Í≥ÑÏÇ∞
                    const averageScore = (this.stageNormalBlockCount > 0) ? (this.stageNormalBlockScore / this.stageNormalBlockCount) : 0; 
                    
                    const gradeInfo = this.calcGrade(averageScore);
                    const grade = gradeInfo.grade;
                    this.bonusComo = gradeInfo.bonus;
                    
                    this.lastStageGrade = grade; 
                    this.como += this.comoEarned + this.bonusComo;
                    
                    // Î∞©Í∏à ÌÅ¥Î¶¨Ïñ¥Ìïú Ïä§ÌÖåÏù¥ÏßÄ Î≤àÌò∏
                    const clearedStage = this.stage;

                    // [MODIFIED] StageGradesÎäî ÏµúÏ¢Ö Grade Í∏∞Î°ùÏö©ÏúºÎ°úÎßå ÏÇ¨Ïö© (S1~S10)
                    if (clearedStage <= 10) {
                        this.stageGrades.push({ 
                            stage: clearedStage, 
                            grade: grade, 
                            score: this.score,
                            maxBlocks: this.totalBlocksPerStage,
                            avgScore: averageScore 
                        });
                    }
                    
                    const comments = this.BOSS_COMMENTS[grade]; 
                    const commentKey = comments[Math.floor(Math.random() * comments.length)];
                    this.bossJComment = this.translate(commentKey);
                    
                    this.consecutivePerfects = 0; 
                    this.chainCount = 0;
                    
                    const isOvertimeSubmit = clearedStage === 11; // S11ÏùÑ ÌÅ¥Î¶¨Ïñ¥Ìïú Í≤ΩÏö∞
                    const isEndingStage = clearedStage === 10; // S10ÏùÑ ÌÅ¥Î¶¨Ïñ¥Ìïú Í≤ΩÏö∞

                    // 1. Î¶¨Ìè¨Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (ÌòÑÏû¨ Ïä§ÌÖåÏù¥ÏßÄ Î≤àÌò∏Î•º Ï†ÑÎã¨)
                    const reportData = this.generateReportData(clearedStage, this.score, this.currentStageBlockDetails); 

                    // 2. Î™®Îã¨ ÌëúÏãú
                    this.showStageReport(reportData);

                    let nextIsEnding = false;
                    if (isEndingStage) { 
                        nextIsEnding = true;
                    } else if (clearedStage < 10 || isOvertimeSubmit) {
                        // [FIX] Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄÎ°úÏùò Ïù¥ÎèôÏùÄ Ïù∏ÌÑ∞ÎØ∏ÏÖò Î°úÏßÅÏù¥ ÎÅùÎÇú ÌõÑ, Îã§Ïùå Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå ÏßÑÌñâÌï¥Ïïº ÌïòÎØÄÎ°ú,
                        // Ïù¥ Í≥≥ÏóêÏÑú this.stage++Î•º Ìò∏Ï∂úÌïòÏßÄ ÏïäÏäµÎãàÎã§. (Stage ReportÎ•º ÎùÑÏö∞Îäî ÎèôÏïàÏùÄ clearedStageÎ•º Ïú†ÏßÄÌï¥Ïïº Ìï®)
                    }
                    
                    const proceedToNextState = async () => {
                        // [FIX] Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄ Î≤àÌò∏ ÏóÖÎç∞Ïù¥Ìä∏Îäî Ïó¨Í∏∞ÏÑú ÏàòÌñâ (Î™®Îã¨ÏùÑ Îã´Îäî Î≤ÑÌäºÏùò @click Ïù¥Î≤§Ìä∏ÏóêÏÑú Ìò∏Ï∂ú)
                        if (!isEndingStage && !isOvertimeSubmit) {
                            this.stage++;
                        }
                        
                        // ... (Ïù¥Ìïò Ï†úÏ∂ú Î°úÏßÅ Ïú†ÏßÄ) ...
                        if (nextIsEnding) {
                            this.finalScore = this.totalScore; 
                            await this.loadHighScores();
                            const totalBlocksInGame = GAME_STAGE_CONFIG.slice(0, 10).reduce((sum, stage) => sum + stage.blocks + stage.bosses.length, 0);
                            const finalAverage = this.totalScore / totalBlocksInGame;
                            const finalGradeInfo = this.calcGrade(finalAverage);
                            this.endingType = finalGradeInfo.endingType;
                            this.gameState = 'ending';
                            const lowestHighScore = (this.highScores.length < 24) ? 0 : this.highScores[23]?.score || 0;
                            const hasExisting = await this.checkExistingRecord('main', this.totalScore);
                            if (this.totalScore > lowestHighScore || hasExisting || (this.playerName !== 'SSS' && this.playerName)) { 
                                this.previousGameState = 'ending'; 
                                this.gameState = 'submitScore'; 
                            }

                        } else if (isOvertimeSubmit) { 
                            await this.loadExtraHighScores();
                            const lowestExtraScore = (this.extraHighScores.length < 24) ? 0 : this.extraHighScores[23].score;
                            const hasExisting = await this.checkExistingRecord('extra', this.lastStageScore);
                            if (this.lastStageScore > lowestExtraScore || hasExisting || (this.playerName !== 'SSS' && this.playerName)) {
                                this.previousGameState = 'intermission'; 
                                this.gameState = 'submitScore'; 
                            } else { 
                                this.gameState = 'intermission'; 
                            }
                        } else { 
                            // S1-S9 Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄ (stage++Îäî Ïù¥ÎØ∏ ÏúÑÏóêÏÑú Ï≤òÎ¶¨Îê®)
                            this.gameState = 'intermission'; 
                        }
                        
                        // F Îì±Í∏â Ïãú BGM Ï§ëÎã® Î°úÏßÅ
                        if (this.gameState === 'intermission' && this.lastStageGrade === 'F') {
                            if (this.currentBGM) {
                                this.currentBGM.pause();
                                this.currentBGM = null;
                            }
                        }
                    };
                    
                    // [MODIFIED] Î™®Îã¨Ïù¥ Îã´ÌûàÎ©¥ Îã§Ïùå ÏÉÅÌÉúÎ°ú ÏßÑÌñâÎêòÎèÑÎ°ù Î°úÏßÅ ÏàòÏ†ï (closeStageReportÏóêÏÑú Ìò∏Ï∂ú)
                    window.closeStageReportAndProceed = proceedToNextState.bind(this);
                },

                // [MODIFIED] Stage Report Data ÏßëÍ≥Ñ Ìï®Ïàò (clearedStageÎ•º Ïù∏ÏûêÎ°ú Î∞õÏùå)
                generateReportData(clearedStage, totalScore, blockDetails) {
                    
                    const configIndex = Math.min(clearedStage - 1, this.stageConfig.length - 1); 
                    const config = this.stageConfig[configIndex]; 
                    const maxBlocks = config ? (config.blocks + config.bosses.length) : blockDetails.length;
                    
                    // StageGradesÏóêÏÑú Ìï¥Îãπ Ïä§ÌÖåÏù¥ÏßÄÏùò ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞Î•º Ìï©ÏÇ∞
                    const summary = blockDetails.reduce((acc, detail) => {
                        acc.baseScore += detail.baseScore;
                        acc.perfectBonusScore += detail.perfectBonusScore;
                        acc.chainBonusScore += detail.chainBonusScore;
                        acc.failPenalty += detail.failPenalty;
                        acc.timeOverPenalty += detail.timeOverPenalty;
                        if (detail.isCompleted) acc.clearedBlocks++;
                        if (detail.isPerfect) acc.perfectCount++;
                        acc.maxChain = Math.max(acc.maxChain, detail.maxChain);
                        return acc;
                    }, { 
                        clearedBlocks: 0, 
                        baseScore: 0, 
                        perfectBonusScore: 0, 
                        chainBonusScore: 0, 
                        failPenalty: 0, 
                        timeOverPenalty: 0, 
                        perfectCount: 0, 
                        maxChain: 0 
                    });
                    
                    // [FIXED] Í∞úÎ∞© ÏïåÎ¶º Î©îÏãúÏßÄ ÏÉùÏÑ±: Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄ Î≤àÌò∏Í∞Ä ÏïÑÎãå ÌÅ¥Î¶¨Ïñ¥ Ïä§ÌÖåÏù¥ÏßÄ Î≤àÌò∏ Í∏∞Ï§ÄÏúºÎ°ú ÏÑ§Ï†ï
                    const nextStage = clearedStage + 1;
                    let unlockMsg = '';
                    
                    if (nextStage === 2) unlockMsg = 'SHOP OPEN!, RELOAD CHARGE'; 
                    else if (nextStage === 4) unlockMsg = 'SYSTEM UNLOCKED!, SPIN, GRID';
                    else if (nextStage === 5) unlockMsg = 'NEW ITEM!, TIME+, SCAN';
                    else if (nextStage === 6) unlockMsg = 'SYSTEM UNLOCKED!, GRAVITY SYSTEM READY';
                    else if (nextStage === 7) unlockMsg = 'NEW ITEM!, AMULET, ASSIST'; 
                    
                    // S11 ÌÅ¥Î¶¨Ïñ¥ ÌõÑ
                    if (clearedStage === 11) unlockMsg = 'OVERTIME REKORD SUBMIT';

                    return {
                        show: true, // Î™®Îã¨ ÌëúÏãú ÏÉÅÌÉúÎ•º Ïó¨Í∏∞ÏÑú ÏÑ§Ï†ï
                        stage: clearedStage,
                        score: totalScore,
                        maxBlocks: maxBlocks,
                        clearedBlocks: summary.clearedBlocks,
                        baseScore: summary.baseScore,
                        perfectBonusScore: summary.perfectBonusScore,
                        chainBonusScore: summary.chainBonusScore,
                        failPenalty: summary.failPenalty,
                        timeOverPenalty: summary.timeOverPenalty,
                        // [MODIFIED] ÎàÑÏ†ÅÎêú Î¶¨Î°úÎìú Í∞êÏ†êÏï°ÏùÑ ÌëúÏãú
                        reloadPenalty: this.reloadPenaltyTotal, 
                        maxChain: summary.maxChain,
                        perfectCount: summary.perfectCount,
                        unlockMessage: unlockMsg
                    };
                },

                // [NEW] Stage Report Modal Ïó¥Í∏∞ Ìï®Ïàò (Í∞ÑÏÜåÌôî)
                showStageReport(reportData) { 
                    this.playSound('stage_clear'); // Stage Clear Ìö®Í≥ºÏùå ÏÇ¨Ïö©
                    this.report = { 
                        ...reportData, 
                        show: true 
                    };
                },
                // [MODIFIED] Î™®Îã¨ Îã´Í∏∞ Ïãú Îã§Ïùå ÏÉÅÌÉúÎ°ú ÏßÑÌñâ
                closeStageReport() { 
                    this.playSound('click'); 
                    this.report.show = false; 
                    // goToIntermissionÏóêÏÑú Î∞îÏù∏Îî©Ìïú Ìï®ÏàòÎ•º Ìò∏Ï∂úÌïòÏó¨ Îã§Ïùå ÏÉÅÌÉúÎ°ú Ï†ÑÌôò Î°úÏßÅ Ïã§Ìñâ
                    if (window.closeStageReportAndProceed) {
                        window.closeStageReportAndProceed();
                        window.closeStageReportAndProceed = null; 
                    }
                },

                async checkExistingRecord(type, currentScore) {
                    if (!this.activeUserId || this.activeUserId === 'CONNECTING...') {
                        this.existingRecord = null;
                        return null;
                    }

                    // 1. Ïù¥ Ïú†Ï†ÄÍ∞Ä Ïù¥Î≤à ÏãúÏ¶åÏóê Îì±Î°ùÌïú *Î™®Îì†* Í∏∞Î°ùÏùÑ Ï∞æÏäµÎãàÎã§ (main, extra Îëò Îã§)
                    const allRecordsQuery = window.fbQuery(
                        window.fbCollection(window.fbDb, "ranks"),
                        window.fbWhere("season", "==", this.currentSeason.id),
                        window.fbWhere("userId", "==", this.activeUserId)
                    );
                    
                    const snapshot = await window.fbGetDocs(allRecordsQuery);
                    
                    if (snapshot.empty) {
                        // 1A. Ïù¥ Ïú†Ï†ÄÎäî Ïù¥Î≤à ÏãúÏ¶å *ÏôÑÏ†Ñ* Ïã†Í∑ú Îû≠Ïª§ÏûÖÎãàÎã§.
                        this.existingRecord = null;
                        this.playerName = 'SSS'; // Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã
                        return null;
                    }

                    // 1B. Ïù¥ Ïú†Ï†ÄÎäî 'main' ÎòêÎäî 'extra'Ïóê *ÏµúÏÜå ÌïòÎÇò*Ïùò Í∏∞Î°ùÏù¥ ÏûàÏäµÎãàÎã§.
                    // *Í∞ÄÏû• Î®ºÏ†Ä* Ï∞æÏùÄ Í∏∞Î°ùÏóêÏÑú ÎãâÎÑ§ÏûÑÏùÑ Í∞ÄÏ†∏ÏôÄ ÏÑ§Ï†ïÌï©ÎãàÎã§ (ÎãâÎÑ§ÏûÑ Í≥†Ï†ï)
                    this.playerName = snapshot.docs[0].data().name;

                    // 2. Ïù¥Ï†ú *ÌòÑÏû¨ ÌîåÎ†àÏù¥Ìïú 'type'*Ïóê Ìï¥ÎãπÌïòÎäî Í∏∞Î°ùÏù¥ ÏûàÎäîÏßÄ, Í∞±Ïã† Í∞ÄÎä•ÌïúÏßÄ ÌôïÏù∏Ìï©ÎãàÎã§.
                    const specificDoc = snapshot.docs.find(doc => doc.data().type === type);
                    
                    if (specificDoc) {
                        // 2A. Ïù¥ 'type'Ïóê ÎåÄÌïú Í∏∞Î°ùÏù¥ Ïù¥ÎØ∏ ÏûàÏäµÎãàÎã§.
                        const data = specificDoc.data();
                        // Í∞±Ïã† Í∞ÄÎä•ÌïúÏßÄ Ï†êÏàò Ï≤¥ÌÅ¨
                        if (currentScore > data.score) {
                            this.existingRecord = { id: specificDoc.id, ...data };
                            return data; // Í∞±Ïã† Í∞ÄÎä•
                        } else {
                            // Ï†êÏàòÍ∞Ä Îçî ÎÇÆÏúºÎØÄÎ°ú Í∞±Ïã†ÏùÄ ÏïÑÎãàÏßÄÎßå, Í∏∞Î°ùÏùÄ Ï°¥Ïû¨Ìï® (ÌëúÏãúÏö©)
                            this.existingRecord = { id: specificDoc.id, ...data };
                            return data; // (goToIntermissionÏóêÏÑú 'hasExisting'ÏúºÎ°ú ÏÇ¨Ïö©)
                        }
                    } else {
                        // 2B. Ïù¥ 'type'Ïóê ÎåÄÌïú Í∏∞Î°ùÏùÄ ÏóÜÏäµÎãàÎã§ (Ïòà: 'main'ÏùÄ ÏûàÎäîÎç∞ 'extra'Îäî Ï≤òÏùå).
                        // ÎãâÎÑ§ÏûÑÏùÄ Ïù¥ÎØ∏ ÏÑ§Ï†ïÎêòÏóàÏúºÎØÄÎ°ú, 'Ïã†Í∑ú Îì±Î°ù'ÏúºÎ°ú Ï≤òÎ¶¨Ìï©ÎãàÎã§.
                        this.existingRecord = null;
                        return null;
                    }
                },

                confirmReturn() { this.playSound('click'); this.returnConfirmModal.show = true; },
                cancelReturn() { this.playSound('click'); this.returnConfirmModal.show = false; },
                
                confirmReset(type) {
                    this.playSound('click');
                    this.resetConfirmModal = { show: true, type: type };
                },

                executeReset() {
                    this.playSound('fail'); 
                    localStorage.clear(); 
                    location.reload(); 
                },
                cancelReset() {
                    this.playSound('click');
                    this.resetConfirmModal.show = false;
                },

                async submitScore() {
                    if (this.currentSeason.state === 'frozen') {
                        this.showFeedback('SEASON CLOSED', 'incorrect');
                        this.playSound('fail');
                        return;
                    }

                    if (!this.existingRecord) {
                        if (this.playerName.length !== 3) {
                             this.showFeedback('MUST BE 3 CHARS', 'incorrect');
                             this.playSound('fail');
                             return;
                        }
                        
                        // Í∏àÏßÄÏñ¥ Ï≤¥ÌÅ¨ (Ï†ïÌôïÌûà ÏùºÏπòÌïòÎäîÏßÄ ÌôïÏù∏)
                        if (this.bannedNames.includes(this.playerName)) {
                             this.showFeedback('INVALID NICKNAME', 'incorrect');
                             this.playSound('fail');
                             return;
                        }

                        // Ï§ëÎ≥µ ÎãâÎÑ§ÏûÑ Ï≤¥ÌÅ¨ (Í∞ôÏùÄ ÏãúÏ¶å ÎÇ¥)
                        const q = window.fbQuery(
                            window.fbCollection(window.fbDb, "ranks"),
                            window.fbWhere("season", "==", this.currentSeason.id),
                            window.fbWhere("name", "==", this.playerName)
                        );
                        const snapshot = await window.fbGetDocs(q);
                        if (!snapshot.empty) {
                             this.showFeedback('NAME ALREADY TAKEN', 'incorrect');
                             this.playSound('fail');
                             return;
                        }
                    }

                    this.playSound('click');
                    
                    const itemsSnapshot = {
                        amulet: this.amuletLevel,
                        assist: this.assistLevel,
                        time: this.timePlusLevel,
                        scan: this.scanLevel,
                        reload: this.reloadBoost 
                    };
                    
                    const specialCardsSnapshot = this.inventory
                        .filter(c => c.isSpecial)
                        .sort((a, b) => {
                            const numA = parseInt(a.sNumber.slice(1));
                            const numB = parseInt(b.sNumber.slice(1));
                            return numA - numB;
                        });
                    
                    const scoreData = {
                        name: this.playerName, 
                        score: (this.stage === 11) ? this.lastStageScore : this.totalScore, 
                        stage: this.stage,
                        items: itemsSnapshot, 
                        specialCards: specialCardsSnapshot, 
                        season: this.currentSeason.id, 
                        userId: this.activeUserId, // [IMPORTANT] User ID Ï†ÄÏû•
                        timestamp: window.fbServerTimestamp(),
                        type: (this.stage === 11) ? 'extra' : 'main',
                        profileBadge: this.userProfile.selectedBadge || this.DEFAULT_BADGE
                    };

                    try {
                        if (this.existingRecord) {
                            // Update Existing
                            const docRef = window.fbDoc(window.fbDb, "ranks", this.existingRecord.id);
                            await window.fbUpdateDoc(docRef, scoreData);
                            this.showFeedback('RECORD UPDATED!', 'correct');
                        } else {
                            // Create New
                            await window.fbAddDoc(window.fbCollection(window.fbDb, "ranks"), scoreData);
                        }
                        
                        // Î°úÏª¨ UI Î∞òÏòÅ Î°úÏßÅÏùÄ ÏÉùÎûµ (ÏÑúÎ≤ÑÏóêÏÑú Îã§Ïãú Î∂àÎü¨Ïò§ÎèÑÎ°ù Ïú†ÎèÑÌïòÍ±∞ÎÇò Îã®Ïàú Ï¢ÖÎ£å)
                        setTimeout(() => {
                            if (this.stage === 11) {
                                this.gameState = 'intermission';
                            } else {
                                this.gameState = 'ending';
                            }
                        }, 1000);

                    } catch (e) {
                        console.error("Submit Error: ", e);
                        this.showFeedback('SEND FAILED', 'incorrect');
                    }
                },
                restartGame() { 
                    this.playSound('click'); 
                    this.returnConfirmModal.show = false; 
                    if (this.seasonGravityListener) {
                        this.seasonGravityListener(); // Unsubscribe
                        this.seasonGravityListener = null;
                        console.log("Season Gravity listener stopped.");
                    }
                    this.gameState = 'start'; 
                },
                continueOvertime() { this.playSound('click'); this.stage = 11; this.gameState = 'intermission'; },

                generateNewBlock() {
                    if (this.currentBlock) return;
                    this.blocksCompleted++;
                    const configIndex = Math.min(this.stage - 1, this.stageConfig.length - 1); 
                    const config = this.stageConfig[configIndex]; 
                    if (!config) { console.error(`Stage config for stage ${this.stage} not found.`); return; }
                    const normalBlockCount = config.blocks;
                    const isBossBlockTime = this.blocksCompleted > normalBlockCount && config.bosses.length > 0;
                    let chosenType = 'sNumber'; let isBoss = false; let blockLabel = '';

                    if (isBossBlockTime) {
                        chosenType = 'dimension'; isBoss = true; 
                        const bossIndex = this.blocksCompleted - normalBlockCount - 1;
                        const poolKeyIndex = Math.min(bossIndex, config.bosses.length - 1);
                        let poolKey = config.bosses[poolKeyIndex]; 
                        if (this.bossPools[poolKey]) {
                            const pool = this.bossPools[poolKey];
                            
                            let gravityPool;
                            if (this.stage === 11) {
                                gravityPool = this.seasonGravityVotes;
                            } else {
                                gravityPool = this.localGravityVotes;
                            }
                            
                            const totalVotes = pool.reduce((acc, name) => acc + (gravityPool[name] || 0), 0) + pool.length;
                            
                            if (totalVotes > 0) {
                                let weightSum = 0;
                                const weightedPool = pool.map(name => { const weight = 1 + (gravityPool[name] || 0); weightSum += weight; return { name, weight }; });
                                let randomWeight = Math.random() * weightSum;
                                for (const boss of weightedPool) { if (randomWeight < boss.weight) { blockLabel = boss.name; break; } randomWeight -= boss.weight; }
                            } else { blockLabel = pool[Math.floor(Math.random() * pool.length)]; }
                        } else { blockLabel = poolKey; }
                    } else {
                        const rand = Math.random();
                        if (rand < config.birthdayChance) chosenType = 'birthday'; else chosenType = 'sNumber';
                    }
                    let members = []; let blockSize = 1; let blockTime = 15000; let memberPool = [...this.memberData];
                    if (chosenType === 'dimension') {
                        members = this.memberData.filter(m => m.dimensions.includes(blockLabel));
                        blockSize = members.length; 
                        blockTime = 15000 + (blockSize * 5000); 
                    } else {
                        blockSize = Math.floor(Math.random() * 4) + 1; blockTime = 10000 + (blockSize * 5000); 
                        for (let i = 0; i < blockSize; i++) { if (memberPool.length === 0) break; const index = Math.floor(Math.random() * memberPool.length); members.push(memberPool.splice(index, 1)[0]); }
                    }
                    
                    blockTime += config.timeBonus || 0; 
                    
                    if (this.timePlusLevel > 0) blockTime += 2000; 
                    
                    this.currentBlock = { id: Date.now() + Math.random(), members: members, bundleType: chosenType, bundleLabel: blockLabel, timeLimit: blockTime, timer: blockTime, isBoss: isBoss };
                    this.completedCards = []; this.selectedData = null; this.selectedInventoryCard = null; this.updateMatchedOrders(); this.startBlockTimer(); 
                    
                    if (isBoss) {
                        this.isBossBlockActive = true;
                        this.switchBGM('boss_playing');
                    } else {
                        this.isBossBlockActive = false;
                        this.switchBGM('playing'); 
                    }
                },
                checkStageCompletion() {
                    const block = this.currentBlock; 
                    this.currentBlock = null; 
                    
                    const config = this.stageConfig[Math.min(this.stage - 1, this.stageConfig.length - 1)];
                    
                    const isStageComplete = this.blocksCompleted >= this.totalBlocksPerStage; 
                    const isLastBlockOfStage = this.blocksCompleted === this.totalBlocksPerStage;
                    const hasBosses = config.bosses.length > 0;
                    const isLastNormalBlockBeforeBoss = this.blocksCompleted === config.blocks && hasBosses;

                    if (isStageComplete || isLastNormalBlockBeforeBoss) { 
                        this.consecutivePerfects = 0; this.chainCount = 0;
                        this.isBossBlockActive = false; 
                    }

                    if (isStageComplete) {
                        this.playSound('stage_clear'); 
                        this.showFeedback('STAGE CLEAR!', 'correct'); 

                        setTimeout(() => { 
                            this.goToIntermission(); 
                        }, 2000); 
                        
                    } else {
                        if (isLastNormalBlockBeforeBoss) {
                            this.playSound('warn'); 
                            this.nextBlockWillBeBoss = true;
                            this.switchBGM('playing'); 
                            setTimeout(() => { this.nextBlockWillBeBoss = false; this.generateNewBlock(); }, 3000); 
                        } else { 
                            this.isBossBlockActive = false; 
                            this.switchBGM('playing'); 
                            setTimeout(() => { this.generateNewBlock(); }, 1500); 
                        }
                    }
                },
                processBlockComplete() { clearInterval(this.orderTimer); this.calculateAndApplyScore(false); },
                processBlockFailure() { clearInterval(this.orderTimer); this.calculateAndApplyScore(true); },
                calculateAndApplyScore(isTimeOver) {
                    const block = this.currentBlock; 
                    if (!block) return; 
                    
                    // 1. Í∏∞Î≥∏ Ï†êÏàò Í≥ÑÏÇ∞
                    let baseScore = 0; 
                    let correctCount = 0; 
                    let wrongCount = 0; 
                    let penalty = 0; 
                    
                    // [NEW] Î¶¨Ìè¨Ìä∏Ïö© Ï†êÏàò ÏöîÏÜå Ï¥àÍ∏∞Ìôî (Ïù¥ Î∏îÎ°ùÏóêÏÑú Î∞úÏÉùÌïú Í≤ÉÎßå)
                    let blockFailPenalty = 0;
                    let blockTimeOverPenalty = 0;

                    let blockChecklist = [];
                    if (block.bundleType === 'birthday') { 
                        blockChecklist = block.members.map((member) => member.birthday); 
                    } else { 
                        blockChecklist = block.members.map((member) => member.sNumber); 
                    }
                    
                    for (const card of this.completedCards) {
                        let isMatch = false;
                        let matchIndex = -1;

                        if (block.bundleType === 'birthday') {
                            if (card.type === 'member_card') {
                                matchIndex = blockChecklist.indexOf(card.birthday);
                            }
                        } else {
                            matchIndex = blockChecklist.indexOf(card.sNumber);
                        }

                        if (matchIndex > -1) {
                            isMatch = true;
                            blockChecklist.splice(matchIndex, 1); 
                        }
                        
                        if (isMatch) { 
                            baseScore += GAME_SCORING.CORRECT_CARD; 
                            correctCount++; 
                        }
                        else if (card.type === 'joker_card' && blockChecklist.length > 0) { 
                            baseScore += GAME_SCORING.CORRECT_CARD; 
                            correctCount++; 
                            blockChecklist.splice(0, 1); 
                        }
                        else {
                            wrongCount++;
                            if (card.type === 'fail_card') { 
                                penalty += GAME_SCORING.FAIL_PENALTY; 
                                blockFailPenalty += GAME_SCORING.FAIL_PENALTY; // [NEW] ÏßëÍ≥Ñ
                            }
                        }
                    }
                    
                    baseScore -= penalty;
                    
                    // 2. Î≥¥ÎÑàÏä§ Ï†êÏàò Í≥ÑÏÇ∞
                    let perfectBonusScore = 0;
                    let chainBonusScore = 0;
                    
                    const isPerfect = !isTimeOver && wrongCount === 0 && this.completedCards.length === block.members.length;
                    
                    if (isPerfect) {
                        if (block.isBoss) {
                            perfectBonusScore = GAME_SCORING.BOSS_PERFECT_MULTIPLIER * block.members.length; 
                        } else {
                            perfectBonusScore = GAME_SCORING.PERFECT_BASE_MULTIPLIER * block.members.length;
                        }
                        
                        this.consecutivePerfects++;
                        this.chainCount = Math.max(0, this.consecutivePerfects - 1); 
                        if (this.chainCount > 0) { 
                            chainBonusScore = this.chainCount * 5; 
                            this.playSound('chain'); 
                        }
                        this.playSound('perfect');
                    } else { 
                        this.consecutivePerfects = 0; 
                        this.chainCount = 0; 
                        if (!isTimeOver) this.playSound('clear');
                    }
                    
                    // 3. ÏµúÏ¢Ö Ï†êÏàò Ìï©ÏÇ∞
                    let finalBlockScore = baseScore + perfectBonusScore + chainBonusScore;

                    if (isTimeOver) {
                        finalBlockScore -= GAME_SCORING.TIME_OVER_PENALTY;
                        blockTimeOverPenalty = GAME_SCORING.TIME_OVER_PENALTY; // [NEW] ÏßëÍ≥Ñ
                        this.playSound('fail'); 
                    }

                    if (!block.isBoss) {
                        this.stageNormalBlockScore = (this.stageNormalBlockScore || 0) + finalBlockScore;
                        this.stageNormalBlockCount = (this.stageNormalBlockCount || 0) + 1;
                    }

                    this.score = Math.max(0, this.score + finalBlockScore);

                    // [NEW] 4. Stage GradesÏóê ÏÉÅÏÑ∏ Ï†êÏàò Ï∂îÍ∞Ä (Î¶¨Ìè¨Ìä∏Ïö©)
                    this.currentStageBlockDetails.push({
                         baseScore: baseScore,
                         perfectBonusScore: perfectBonusScore,
                         chainBonusScore: chainBonusScore,
                         failPenalty: blockFailPenalty,
                         timeOverPenalty: blockTimeOverPenalty,
                         isPerfect: isPerfect,
                         isTimeOver: isTimeOver,
                         isCompleted: !isTimeOver,
                         finalScore: finalBlockScore,
                         maxChain: this.chainCount
                    });
                    
                    // 5. ÌîºÎìúÎ∞± Î©îÏãúÏßÄ ÏÉùÏÑ± (Í∞ÑÍ≤∞Ìòï: +Ï¥ùÏ†ê (üéØÍ∏∞Î≥∏ ‚ú®ÌçºÌéôÌä∏ ‚õìÔ∏èÏ≤¥Ïù∏))
                    let feedbackMsg = '';
                    
                    if (isTimeOver) {
                         feedbackMsg = `TIME OVER -${GAME_SCORING.TIME_OVER_PENALTY}`;
                    } else {
                         const sign = finalBlockScore >= 0 ? '+' : '';
                         feedbackMsg = `${sign}${finalBlockScore}`;
                         
                         let details = [];
                         
                         // Î≥¥ÎÑàÏä§Í∞Ä ÌïòÎÇòÎùºÎèÑ ÏûàÏúºÎ©¥ ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ ÌëúÏãú (Í∏∞Î≥∏ Ï†êÏàò Ìè¨Ìï®)
                         if (perfectBonusScore > 0 || chainBonusScore > 0) {
                             details.push(`üéØ${baseScore}`); // Í∏∞Î≥∏ Ï†êÏàò (Ïù¥Î™®ÏßÄ Ï∂îÍ∞Ä)
                             if (perfectBonusScore > 0) details.push(`‚ú®${perfectBonusScore}`);
                             if (chainBonusScore > 0) details.push(`‚õìÔ∏è${chainBonusScore}`);
                             
                             // Í¥ÑÌò∏Î°ú Í∞êÏã∏Í≥† Í≥µÎ∞±ÏúºÎ°ú Íµ¨Î∂Ñ: +155 (üéØ80 ‚ú®50 ‚õìÔ∏è25)
                             feedbackMsg += ` (${details.join(' ')})`;
                         }
                    }

                    this.showFeedback(feedbackMsg, isTimeOver || wrongCount > 0 ? 'incorrect' : 'correct'); 
                    
                    this.checkStageCompletion(); 
                },
               
                selectData(type, dataName, id) { 
                    this.playSound('data_select'); 
                    this.selectedData = (this.selectedData && this.selectedData.id === id) ? null : { id, name: dataName, type }; 
                    this.selectedInventoryCard = null; 
                },
                selectInventoryCard(card) { 
                    this.playSound('select'); 
                    this.selectedInventoryCard = (this.selectedInventoryCard && this.selectedInventoryCard.inventoryId === card.inventoryId) ? null : card; 
                    if (this.gameState === 'playing') this.selectedData = null; 
                },
                async inputData() {
                    if (!this.inputEnabled() || !this.currentBlock) return;
                    this.playSound('input'); 
                    let newCardData;
                    if (this.selectedData) {
                    const dataName = this.selectedData.name;
                    const member = this.memberData.find(m => m.kor === dataName || m.eng === dataName);

                    if (member) { 
                        newCardData = member;
                    } else { 
                        newCardData = this.modhausData.find(m => m.sNumber === 'X'); 
                    }

                    if (newCardData.type === 'fail_card' && this.amuletLevel > 0 && Math.random() < 0.2) {
                            newCardData = this.artmsData[Math.floor(Math.random() * this.artmsData.length)]; 
                            this.showFeedback(this.translate('feedback_amulet_activated'), 'correct');
                        }

                        this.clearSelectedData(true); 
                    } else if (this.selectedInventoryCard) {
                        newCardData = this.selectedInventoryCard;
                        if (!newCardData.isSpecial) { 
                            const index = this.inventory.findIndex(item => item.inventoryId === newCardData.inventoryId); 
                            if (index > -1) this.inventory.splice(index, 1); 
                        }
                        this.selectedInventoryCard = null;
                    }
                    
                    const newCard = { 
                        ...newCardData, 
                        id: Date.now() + Math.random(), 
                        isSpecial: false 
                    };
                    
                    if (this.completedCards.length < 8) this.completedCards.push(newCard);
                    else { this.completedCards.shift(); this.completedCards.push(newCard); }
                    
                    this.updateMatchedOrders(); 
                    
                    if (this.completedCards.length === this.currentBlock.members.length) {
                        this.processBlockComplete(); 
                    }
                },
                updateMatchedOrders() {
                    if (!this.currentBlock) { this.matchedOrderIndices = []; return; }
                    
                    this.matchedOrderIndices = new Array(this.currentBlock.members.length).fill(false);
                    let slotCards = [...this.completedCards]; 
                    let remainingSlotCards = slotCards.map((card, index) => ({ card, index })); 
                    
                    for (let i = 0; i < this.currentBlock.members.length; i++) {
                        if (this.matchedOrderIndices[i]) continue;
                        
                        const order = this.currentBlock.members[i];
                        let matchIndexInRemaining = -1;
                        
                        if (this.currentBlock.bundleType === 'birthday') {
                            matchIndexInRemaining = remainingSlotCards.findIndex(item => item.card && item.card.type === 'member_card' && item.card.birthday === order.birthday);
                        } else {
                            matchIndexInRemaining = remainingSlotCards.findIndex(item => item.card && item.card.sNumber === order.sNumber);
                        }
                        
                        if (matchIndexInRemaining !== -1) {
                            this.matchedOrderIndices[i] = true;
                            remainingSlotCards.splice(matchIndexInRemaining, 1); 
                            continue; 
                        }

                        const jokerIndexInRemaining = remainingSlotCards.findIndex(item => item.card && item.card.type === 'joker_card');
                        if (jokerIndexInRemaining !== -1) {
                            this.matchedOrderIndices[i] = true;
                            remainingSlotCards.splice(jokerIndexInRemaining, 1); 
                        }
                    }
                },
                reloadData() {
                    this.playSound('refresh'); 
                    
                    if (this.reloadCount > 0) {
                        this.reloadCount--;
                    } 
                    else {
                        const penaltyAmount = this.currentReloadPenalty;
                        this.score = Math.max(0, this.score - penaltyAmount);
                        this.showFeedback('SCORE -' + penaltyAmount, 'incorrect');
                        this.currentReloadPenalty = Math.min(20, this.currentReloadPenalty + 5);
                        
                        this.reloadPenaltyTotal += penaltyAmount;
                    }

                    this.refillData(true); 
                    this.selectedInventoryCard = null; this.selectedData = null;
                },
                getReloadDisplayCount() {
                    if (this.reloadCount > 0) {
                        return this.reloadCount; 
                    }
                    return -this.currentReloadPenalty; 
                },
                getReloadDisplayColor() {
                    if (this.reloadCount > 10) {
                        return 'text-cyan-400';
                    }
                    if (this.reloadCount > 0) {
                        return 'text-white';
                    }
                    return 'text-red-400'; 
                },
                clearSelectedData(isInput) {
                    if (!this.selectedData) return;
                    const selected = this.selectedData;
                    
                    this.isDataReady = false; 

                    const newData = this.getNewData(selected.type); 
                    
                    if (selected.type === 'kor') {
                        const index = this.korData.findIndex(k => k.id === selected.id);
                        if (index > -1) {
                            this.korData.splice(index, 1, newData); 
                        }
                    } else {
                        const index = this.engData.findIndex(k => k.id === selected.id);
                        if (index > -1) {
                            this.engData.splice(index, 1, newData);
                        }
                    }
                    this.selectedData = null;
                    
                    setTimeout(() => {
                        this.isDataReady = true;
                    }, 10); 
                },
                shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
                ,
                refillData(isSafeMode = false) {
                    this.isDataReady = false; 

                    let memberPool = [...this.memberData];
                    this.shuffleArray(memberPool);
                    const selectedTwelve = memberPool.slice(0, 12);
                    
                    const newKorData = [];
                    const newEngData = [];

                    for (let i = 0; i < 6; i++) {
                        newKorData.push(this.generateDataItem(selectedTwelve[i], 'kor', isSafeMode)); 
                    }
                    for (let i = 6; i < 12; i++) {
                        newEngData.push(this.generateDataItem(selectedTwelve[i], 'eng', isSafeMode));
                    }
                    
                    this.korData.splice(0, this.korData.length, ...newKorData);
                    this.engData.splice(0, this.engData.length, ...newEngData);
                    
                    setTimeout(() => {
                        this.isDataReady = true;
                    }, 10); 
                },
                getNewData(type) {
                    const currentDisplayedSNumbers = [...this.korData, ...this.engData].map(d => d.originSNumber).filter(Boolean);
                    let availableMembers = this.memberData.filter(m => !currentDisplayedSNumbers.includes(m.sNumber));
                    
                    if (availableMembers.length === 0) { 
                        availableMembers = [...this.memberData]; 
                    }
                    
                    const randomMember = availableMembers[Math.floor(Math.random() * availableMembers.length)];
                    return this.generateDataItem(randomMember, type, false); 
                },
                generateDataItem(member, type, isSafeMode = false) {
                    let dataName = (type === 'kor') ? member.kor : member.eng;
                    let originSNumber = member.sNumber; 
                    
                    if (!isSafeMode && this.stage > 1 && Math.random() < this.decoyRatio) { 
                        if (this.assistLevel > 0 && Math.random() < 0.2) { 
                            const friend = this.friendData[Math.floor(Math.random() * this.friendData.length)];
                            dataName = (type === 'kor') ? friend.kor : (friend.eng || friend.kor);
                            originSNumber = friend.sNumber; 
                        } else {
                            const decoys = (type === 'kor') ? member.decoysKor : member.decoysEng;
                            if (decoys && decoys.length > 0) {
                                dataName = decoys[Math.floor(Math.random() * decoys.length)];
                            }
                        }
                    }
                    
                    let id = Date.now() + Math.random(); 
                    
                    return { id: id, name: dataName, type: type, originSNumber: originSNumber };
                },
                inputEnabled() { return this.selectedData !== null || this.selectedInventoryCard !== null; },
                isSelectedData(id) { return this.selectedData?.id === id; },
                isSelectedInventory(inventoryId) { return this.selectedInventoryCard?.inventoryId === inventoryId; },
                showFeedback(message, type) { clearTimeout(this.feedback.timer); this.feedback.message = message; this.feedback.type = type; this.feedback.show = true; this.feedback.timer = setTimeout(() => { this.feedback.show = false; }, 1500); },
                openShopModal(item) {
                    this.playSound('click');
                    if (item === 'objekt') { 
                        if (this.inventory.length >= this.inventoryMaxSize) { this.showFeedback(this.translate('feedback_collect_full'), 'incorrect'); return; }
                        this.openGachaModal(); 
                        return; 
                    }
                    
                    const info = this.ITEM_INFO[item];
                    if (!info) return;
                    
                    // [REFACTOR] ÎèôÏ†Å Î†àÎ≤® Ï≤¥ÌÅ¨ (stateKey ÌôúÏö©)
                    const currentLevel = this[info.stateKey];
                    const isMax = (info.maxLevel > 0 && currentLevel >= info.maxLevel);

                    this.shopModal = { 
                        show: true, 
                        item: item, 
                        title: info.title, 
                        desc: this.translate(info.desc), 
                        cost: info.cost, 
                        isMax: isMax 
                    };
                },
                closeShopModal() { this.playSound('click'); this.shopModal.show = false; },
                confirmBuyItem() {
                    if (this.shopModal.item && !this.shopModal.isMax) { 
                        this.executePurchase(this.shopModal.item); 
                        
                        // [REFACTOR] Íµ¨Îß§ ÌõÑ Ï¶âÏãú Max Ïó¨Î∂Ä Ïû¨ÌôïÏù∏
                        const info = this.ITEM_INFO[this.shopModal.item];
                        if (info && info.maxLevel > 0 && this[info.stateKey] >= info.maxLevel) {
                            this.shopModal.isMax = true;
                        } else {
                            // [MODIFIED] Reload ÏïÑÏù¥ÌÖúÏù¥ ÏïÑÎãàÍ±∞ÎÇò, Reload ÏïÑÏù¥ÌÖúÏù¥ MAXÍ∞Ä ÏïÑÎãê Í≤ΩÏö∞ÏóêÎßå Îã´ÏßÄ ÏïäÏùå.
                            // Reload ÏïÑÏù¥ÌÖúÏù¥ MAXÏóê ÎèÑÎã¨ÌñàÍ±∞ÎÇò, ReloadÍ∞Ä ÏïÑÎãå ÏùºÎ∞ò ÏïÑÏù¥ÌÖúÏù∏ Í≤ΩÏö∞ Îã´Ïùå.
                            if (this.shopModal.item !== 'reload') {
                                this.closeShopModal();
                            }
                        }
                    } else {
                        this.closeShopModal(); 
                    }
                },
                openGachaModal() {
                    this.gachaState = 'ready'; this.gachaResultCard = null; this.gameState = 'gacha';
                },
                closeGachaModal() { this.playSound('click'); this.gameState = 'intermission'; },
                startGachaAnimation() {
                    // v10.197 FIX: ITEM_INFO.objekt.costÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Í∞ÄÍ≤© ÎèôÍ∏∞Ìôî (ÌïòÎìúÏΩîÎî© 1 Ï†úÍ±∞)
                    const cost = this.ITEM_INFO.objekt.cost;
                    if (this.como < cost) { this.showFeedback('NOT ENOUGH COMO!', 'incorrect'); return; }
                    this.como -= cost;
                    this.playSound('gacha'); 
                    this.gachaState = 'opening';
                    
                    setTimeout(() => {
                        if (this.inventory.length >= this.inventoryMaxSize) {
                             this.como += cost; // v10.197 FIX: ÌôòÎ∂à ÏãúÏóêÎèÑ cost Î≥ÄÏàò ÏÇ¨Ïö©
                             this.showFeedback(this.translate('feedback_collect_full'), 'incorrect');
                             this.closeGachaModal();
                             return;
                        }
                        if (Math.random() < 0.005) { 
                            this.gachaResultCard = { ...this.modhausData.find(m => m.sNumber === 'MH'), inventoryId: Date.now() + Math.random(), isSpecial: false, type: 'joker_card' };
                             setTimeout(() => { this.gachaState = 'joker_flash'; setTimeout(() => { this.gachaState = 'result'; }, 1500); }, 2000);
                        } else {
                            const randomMember = this.memberData[Math.floor(Math.random() * this.memberData.length)];
                            this.gachaResultCard = { ...randomMember, inventoryId: Date.now() + Math.random(), isSpecial: false, type: 'member_card' };
                            setTimeout(() => { this.gachaState = 'result'; }, 2000);
                        }
                    }, 0); 
                },
                confirmGachaResult() {
                    // v10.197 FIX: ITEM_INFO.objekt.cost ÏÇ¨Ïö©
                    const cost = this.ITEM_INFO.objekt.cost;
                    if (this.gachaResultCard) {
                         if (this.inventory.length >= this.inventoryMaxSize) {
                              this.como += cost; // v10.197 FIX: ÌôòÎ∂à ÏãúÏóêÎèÑ cost Î≥ÄÏàò ÏÇ¨Ïö©
                              this.showFeedback(this.translate('feedback_collect_full'), 'incorrect'); 
                              this.closeGachaModal(); 
                              return;
                         }
                        this.inventory.push(this.gachaResultCard);
                        if (this.gachaResultCard.type === 'joker_card') { this.showFeedback(this.translate('feedback_joker_acquired'), 'correct'); }
                        else { this.showFeedback(`${this.gachaResultCard.sNumber} ${this.translate('feedback_card_acquired')}`, 'correct'); this.checkCraftingAvailability(this.gachaResultCard); }
                    }
                    this.closeGachaModal();
                },
                executePurchase(item) {
                    const info = this.ITEM_INFO[item];
                    if (!info) return;
                    
                    if (this.como >= info.cost) {
                         this.como -= info.cost;
                         this.playSound('buy'); 
                         
                         // [REFACTOR] stateKeyÎ•º Ïù¥Ïö©Ìï¥ ÎèôÏ†Å ÏóÖÎç∞Ïù¥Ìä∏ (switchÎ¨∏ Ï†úÍ±∞ Í∞ÄÎä•)
                         if (info.stateKey) {
                             if (item === 'reload') {
                                 this[info.stateKey] = Math.min(info.maxLevel, this[info.stateKey] + 1);
                             } else {
                                 this[info.stateKey]++; 
                             }
                         }
                    } else { 
                        this.showFeedback('NOT ENOUGH COMO!', 'incorrect'); 
                    }
                },
                startSpin() { 
                    if (this.isCrafting) return; 
                    if (!this.selectedInventoryCard) { this.showFeedback('SPIN FAILED...', 'incorrect'); return; }
                    if (this.intermissionSpinCount >= 3) {
                         return;
                    }
                    this.playSound('click');
                    this.intermissionSpinCount++; 
                    this.selectedInventoryCardForSpin = this.selectedInventoryCard; this.selectedInventoryCard = null; this.spinResult = null; this.generateSpinGrid(); this.isSpinning = true; 
                },
                generateSpinGrid() {
                    this.isSpinGridReady = false; 

                    const newSpinGrid = [];
                    newSpinGrid.push({ ...this.memberData[Math.floor(Math.random() * this.memberData.length)], inventoryId: Date.now() + Math.random(), isSpecial: true, type: 'member_card' });
                    for (let i = 0; i < 2; i++) newSpinGrid.push({ ...(this.modhausData.find(m => m.sNumber === 'X')), inventoryId: Date.now() + Math.random(), isSpecial: false });
                    for (let i = 0; i < 13; i++) newSpinGrid.push({ ...this.memberData[Math.floor(Math.random() * this.memberData.length)], inventoryId: Date.now() + Math.random(), isSpecial: false, type: 'member_card' });
                    this.shuffleArray(newSpinGrid);
                    
                    this.spinGrid.splice(0, this.spinGrid.length, ...newSpinGrid); 
                    
                    setTimeout(() => {
                        this.isSpinGridReady = true;
                    }, 10); 
                },
                selectSpinCard(card) {
                    if (this.spinResult) return; 
                    this.playSound('input'); 
                    this.spinResult = card; 
                    const index = this.inventory.findIndex(c => c.inventoryId === this.selectedInventoryCardForSpin.inventoryId);
                    
                    setTimeout(() => {
                        if (index > -1) {
                            if (card.type !== 'fail_card') { 
                                this.inventory.splice(index, 1, card); 
                                this.showFeedback(`${card.sNumber} ${this.translate('feedback_card_acquired')}`, 'correct'); 
                                if (!card.isSpecial) this.checkCraftingAvailability(card); 
                            }
                            else { 
                                this.inventory.splice(index, 1); 
                                this.showFeedback(this.translate('feedback_spin_failed'), 'incorrect'); 
                            }
                        }
                        setTimeout(() => { 
                            this.isSpinning = false; 
                            this.isSpinGridReady = false; 
                            setTimeout(() => { this.selectedInventoryCardForSpin = null; this.spinResult = null; }, 300); 
                        }, 2000); 
                    }, 10); 
                },
                canCraft() { if (!this.selectedInventoryCard || this.selectedInventoryCard.isSpecial) return false; return this.inventory.filter(c => c.sNumber === this.selectedInventoryCard.sNumber && !c.isSpecial).length >= 4; },
                startGridCraft() {
                    if (this.isSpinning) return; 
                    if (!this.canCraft()) { this.showFeedback(this.translate('feedback_need_four_cards'), 'incorrect'); return; }
                    this.playSound('gacha'); 
                    this.craftingCard = this.selectedInventoryCard; this.isCrafting = true; this.selectedInventoryCard = null;
                    setTimeout(() => {
                        let removedCount = 0; 
                        for (let i = this.inventory.length - 1; i >= 0; i--) { 
                            if (this.inventory[i].sNumber === this.craftingCard.sNumber && !this.inventory[i].isSpecial && removedCount < 4) { 
                                this.inventory.splice(i, 1); removedCount++; 
                            } 
                        }
                        const specialCard = { ...this.craftingCard, inventoryId: Date.now() + Math.random(), isSpecial: true }; 
                        this.inventory.push(specialCard); 
                        this.showFeedback(`‚ú® ${specialCard.sNumber} ${this.translate('feedback_grid_complete')}`, 'correct');
                        
                        setTimeout(() => { 
                            this.isCrafting = false; 
                            this.craftingCard = null; 
                        }, 500);
                    }, 2500); 
                },
                checkCraftingAvailability(card) { 
                    if (card && this.inventory.filter(c => c.sNumber === card.sNumber && !c.isSpecial).length >= 4) this.showFeedback(`${card.sNumber} ${this.translate('feedback_grid_available')}`, 'correct'); 
                },
                getGravityVotes(poolKey) { return this.bossPools[poolKey] || []; },
                
                initializeGravityVotes() {
                    // this.stageÎäî 'Îã§Ïùå' Ïä§ÌÖåÏù¥ÏßÄÎ•º ÏùòÎØ∏Ìï®
                    
                    // 1. S11 (Overtime) - Í∏ÄÎ°úÎ≤å/ÏãúÏ¶å Ìà¨Ìëú (Firestore)
                    if (this.stage === 11) {
                        // S1-S10ÏóêÏÑú ÏÇ¨Ïö©ÌïòÎçò Î°úÏª¨ Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
                        this.localGravityVotes = {}; 
                        
                        // Ïù¥ÎØ∏ Î¶¨Ïä§ÎÑàÍ∞Ä Ïó∞Í≤∞ÎêòÏñ¥ ÏûàÎã§Î©¥ Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ
                        if (this.seasonGravityListener) {
                            console.log("Season Gravity listener already active.");
                            return;
                        }

                        console.log(`Connecting to Season Gravity: ${this.currentSeason.id}`);
                        const docRef = window.fbDoc(window.fbDb, "seasonGravity", this.currentSeason.id);
                        
                        this.seasonGravityListener = window.fbOnSnapshot(docRef, (doc) => {
                            if (doc.exists()) {
                                this.seasonGravityVotes = doc.data();
                                console.log("Season Gravity data updated:", this.seasonGravityVotes);
                            } else {
                                // ÏïÑÏßÅ ÏïÑÎ¨¥ÎèÑ Ìà¨Ìëú Ïïà Ìï® (ÏãúÏ¶å Ï≤´ Ìà¨Ìëú)
                                console.log("Season Gravity doc not found, initializing locally.");
                                // MSNZ Î≥¥Ïä§ ÌíÄÎ°ú Ï¥àÍ∏∞Ìôî
                                this.seasonGravityVotes = { 'Moon': 0, 'Sun': 0, 'Neptune': 0, 'Zenith': 0 };
                            }
                        }, (error) => {
                            console.error("Error listening to Season Gravity: ", error);
                            // ÏóêÎü¨ Ïãú Î°úÏª¨ 0ÏúºÎ°ú Ï¥àÍ∏∞Ìôî
                            this.seasonGravityVotes = { 'Moon': 0, 'Sun': 0, 'Neptune': 0, 'Zenith': 0 };
                        });

                    // 2. S1-S10 (Standard) - Î°úÏª¨ Ìà¨Ìëú
                    } else {
                        // Overtime(S11)ÏùÑ ÌîåÎ†àÏù¥ÌïòÎã§Í∞Ä ÌÉÄÏù¥ÌãÄÎ°ú ÎèåÏïÑÍ∞Ä StandardÎ•º ÏãúÏûëÌï† Í≤ΩÏö∞,
                        // S11Ïùò Î¶¨Ïä§ÎÑàÎ•º Î∞òÎìúÏãú Íµ¨ÎèÖ Ìï¥Ï†úÌï¥Ïïº Ìï®.
                        if (this.seasonGravityListener) {
                            this.seasonGravityListener(); // Unsubscribe
                            this.seasonGravityListener = null;
                            this.seasonGravityVotes = {}; // Í∏ÄÎ°úÎ≤å Ìà¨Ìëú Îç∞Ïù¥ÌÑ∞ ÎπÑÏö∞Í∏∞
                            console.log("Season Gravity listener stopped (Switched to Standard).");
                        }

                        // Í∏∞Ï°¥ Î°úÏª¨ Ìà¨Ìëú Î°úÏßÅ (S1-S10)
                        const configIndex = (this.stage === 10) ? this.stage : Math.min(this.stage - 1, this.stageConfig.length - 1);
                        const nextConfig = this.stageConfig[configIndex];
                        
                        if (!nextConfig || nextConfig.bosses.length === 0 || !this.bossPools[nextConfig.bosses[0]]) { 
                            this.localGravityVotes = {}; 
                            return; 
                        }
                        const pool = this.bossPools[nextConfig.bosses[0]];
                        if (pool.some(name => this.localGravityVotes[name] === undefined)) {
                            pool.forEach(name => { this.localGravityVotes[name] = 0; });
                        }
                    }
                },

                voteForBoss(bossName) { 
                    if (this.como < 1) {
                        this.showFeedback('NOT ENOUGH COMO!', 'incorrect');
                        return;
                    }
                    
                    this.como--;
                    this.playSound('buy');

                    // 1. S11 (Overtime) - Í∏ÄÎ°úÎ≤å/ÏãúÏ¶å Ìà¨Ìëú (Firestore)
                    if (this.stage === 11) {
                        if (this.currentSeason.state === 'frozen') {
                             this.showFeedback('SEASON CLOSED', 'incorrect');
                             this.como++; // ÏΩîÎ™® ÌôòÎ∂à
                             return;
                        }
                        
                        const docRef = window.fbDoc(window.fbDb, "seasonGravity", this.currentSeason.id);
                        const updateData = {};
                        updateData[bossName] = window.fbIncrement(1);
                        
                        // setDoc (merge: true)Îäî Î¨∏ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±, ÏûàÏúºÎ©¥ ÌïÑÎìúÎßå ÏóÖÎç∞Ïù¥Ìä∏/Ï∂îÍ∞Ä. (ÏïàÏ†ÑÌï®)
                        window.fbSetDoc(docRef, updateData, { merge: true }).catch((e) => {
                            console.error("Failed to vote (Season Gravity): ", e);
                            this.showFeedback('VOTE FAILED', 'incorrect');
                            this.como++; // ÏΩîÎ™® ÌôòÎ∂à
                        });

                    // 2. S1-S10 (Standard) - Î°úÏª¨ Ìà¨Ìëú
                    } else {
                        this.localGravityVotes[bossName] = (this.localGravityVotes[bossName] || 0) + 1;
                    }
                },

                getBossProbability(bossName, poolKey) {
                    const pool = this.bossPools[poolKey]; 
                    if (!pool) return 0;
                    
                    let activeVotes;
                    if (this.stage === 11) {
                        activeVotes = this.seasonGravityVotes; // S11ÏùÄ Í∏ÄÎ°úÎ≤å Ìà¨Ìëú
                    } else {
                        activeVotes = this.localGravityVotes; // S1-S10ÏùÄ Î°úÏª¨ Ìà¨Ìëú
                    }

                    const totalWeight = pool.reduce((acc, name) => acc + (activeVotes[name] || 0), 0) + pool.length;
                    return totalWeight === 0 ? (100 / pool.length).toFixed(1) : (((activeVotes[bossName] || 0) + 1) / totalWeight * 100).toFixed(1);
                },
                
                isMatchingOrder(card, indexInStall) {
                    if (!this.currentBlock) return false;
                    if (!card) return false; 
                    
                    if (card.type === 'joker_card') return true;
                    
                    if (this.currentBlock.bundleType === 'birthday') { 
                        if (card.type !== 'member_card') return false;
                        const requiredCount = this.currentBlock.members.filter(m => m.birthday === card.birthday).length;
                        if (requiredCount === 0) return false;
                        let previousCount = 0;
                        for (let i = 0; i < indexInStall; i++) { 
                            if (this.completedCards[i]?.birthday === card.birthday) previousCount++; 
                        }
                        return previousCount < requiredCount;
                    }
                    
                    const requiredCount = this.currentBlock.members.filter(m => m.sNumber === card.sNumber).length;
                    if (requiredCount === 0) return false;
                    
                    let previousCount = 0;
                    for (let i = 0; i < indexInStall; i++) { 
                        if (this.completedCards[i]?.sNumber === card.sNumber) previousCount++; 
                    }
                    return previousCount < requiredCount;
                },
                // --- SMART GUIDE LOGIC (STAGE 1 ONLY) ---
                checkSmartGuide(item) {
                    if (this.stage !== 1 || !this.currentBlock || !item) return false;
                    
                    const itemSNumber = item.originSNumber || item.sNumber;
                    if (!itemSNumber) return false; // Not a member card

                    // 1. How many are required in the current block?
                    const requiredCount = this.currentBlock.members.filter(m => m.sNumber === itemSNumber).length;
                    
                    if (requiredCount === 0) return false; // This card isn't needed at all

                    // 2. How many are already in the slot?
                    const slottedCount = this.completedCards.filter(c => c.sNumber === itemSNumber).length;

                    // 3. Highlight only if required > slotted
                    return requiredCount > slottedCount;
                },
                checkSmartReload() {
                     if (this.stage !== 1 || !this.currentBlock) return false;
                     const poolHasMatch = [...this.korData, ...this.engData].some(d => this.checkSmartGuide(d));
                     const invHasMatch = this.inventory.some(c => !c.isSpecial && this.checkSmartGuide(c));
                     return !poolHasMatch && !invHasMatch;
                },
                getBirthdayBackground(member) {
                    if (this.scanLevel === 0) return 'background-color: #F5F5F5; border-color: #A0A0A0;';
                    const twins = this.memberData.filter(m => m.birthday === member.birthday).sort((a, b) => parseInt(a.sNumber.slice(1)) - parseInt(b.sNumber.slice(1)));
                    if (twins.length === 2) {
                        return `background: linear-gradient(to right, ${twins[0].color} 50%, ${twins[1].color} 50%); border-color: #A0A0A0;`;
                    }
                    return `background-color: ${member.color}; border-color: #A0A0A0;`;
                },
                getMembersByDimension(dimName) { return this.memberData.filter(m => m.dimensions.includes(dimName)); },
                getCurrentSeasonColor() {
                    return this.currentSeason.color;
                }
            }
        }
    </script>
</head>
<body class="bg-[#09090b] text-white font-sans antialiased overflow-hidden premium-bg">
    <div id="game-container" class="w-full max-w-md mx-auto flex flex-col items-center justify-start bg-transparent" style="height: 100vh; height: calc(var(--vh, 1vh) * 100);">
        <div x-data="game()" x-init="init()" x-cloak class="w-full h-full flex flex-col relative">
            
            <div x-show="gameState === 'start'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center z-50 title-bg-effect overflow-hidden">
                <template x-for="i in 8"><div class="floating-objekt" :style="`top: ${Math.random() * 80 + 10}%; left: ${Math.random() * 80 + 10}%; animation-delay: -${Math.random() * 20}s; animation-duration: ${20 + Math.random() * 10}s`"></div></template>
                
                <div class="z-10 text-center p-8 flex flex-col items-center w-full">
                    <h1 class="text-7xl font-black mb-2 tracking-tighter leading-none"><span class="holo-text">OBJEKT</span><br><span class="text-white">RUSH</span></h1>
                    <p class="text-xl text-gray-300 font-semibold tracking-widest mb-12 opacity-80">MH AGENT: RECRUIT</p>
                    
                    <button @click="startGame(false)" class="glass-button w-full py-4 px-6 mb-4 rounded-xl text-2xl font-bold text-white">WORK START</button>
                    <div class="grid grid-cols-2 gap-4 w-full">
                        <button @click="showRanking()" class="glass-button w-full py-4 px-6 rounded-xl text-xl font-bold text-gray-300 hover:text-white">REKORD</button>
                        <button @click="showSettings()" class="glass-button w-full py-4 px-6 rounded-xl text-xl font-bold text-gray-300 hover:text-white">CONFIG</button>
                    </div>
                </div>
            </div>
            
             <div x-show="gameState === 'intro'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center p-6 z-50 bg-black/80 backdrop-blur-md">
                <div class="glass-panel briefing-panel p-6 rounded-3xl w-full h-full flex flex-col" x-show="introStep === 1" x-transition:enter="transition ease-out duration-500" x-transition:enter-start="opacity-0 translate-x-10" x-transition:enter-end="opacity-100 translate-x-0">
                    <div class="text-center mb-8 mt-4 flex-grow flex flex-col justify-center relative z-10 overflow-hidden">
                        <div class="h-full overflow-y-auto scrollbar-thin px-2">
                            <h2 class="text-3xl font-black text-yellow-300 mb-6 tracking-widest uppercase sticky top-0 bg-[#09090b]/80 backdrop-blur-md py-2 z-10" x-text="'MISSION ORDER'"></h2>
                            <div class="space-y-6 text-lg text-gray-200 pb-4">
                                <p class="italic" x-text="translate('intro_line_0')"></p>
                                <div class="bg-white/5 p-5 rounded-xl border border-white/10 text-left space-y-3 shadow-inner">
                                    <p x-text="`1. ${translate('intro_line_1_a')}`"></p>
                                    <p x-text="`2. ${translate('intro_line_1_b')}`"></p>
                                    <p x-text="`3. ${translate('intro_line_1_c')}`"></p>
                                    <p x-text="`4. ${translate('intro_line_1_d')}`"></p> 
                                </div>
                                <p class="italic" x-text="translate('intro_line_prompt')"></p> 
                            </div>
                        </div>
                    </div>
                    <button @click="nextIntroStep()" class="glass-button w-full py-4 text-2xl font-bold rounded-2xl text-white relative z-10 hover:border-gray-300/50">DATA ACCESS</button>
                </div>

                <div class="glass-panel p-6 rounded-3xl w-full h-full flex flex-col" x-show="introStep === 2" x-transition:enter="transition ease-out duration-500" x-transition:enter-start="opacity-0 translate-x-10" x-transition:enter-end="opacity-100 translate-x-0">
                    <div class="text-center mb-4 flex-shrink-0">
                        <h2 class="text-2xl font-black text-cyan-300 mb-1 tracking-widest" x-text="'S-CLASS LIST'"></h2>
                        <p class="text-gray-400 text-sm tracking-wider font-mono">// CONFIDENTIAL DATA //</p>
                    </div>
                    <div class="flex w-full mb-4 rounded-xl glass-panel p-1 flex-shrink-0">
                        <button @click="introTab = 'members'" class="w-1/2 py-2 rounded-lg text-sm font-bold transition-all" :class="introTab === 'members' ? 'bg-cyan-600/80 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'">S-CLASS</button>
                        <button @click="introTab = 'dimensions'" class="w-1/2 py-2 rounded-lg text-sm font-bold transition-all" :class="introTab === 'dimensions' ? 'bg-purple-600/80 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'">DIMENSION</button>
                    </div>
                    <div class="flex-grow overflow-y-auto scrollbar-thin bg-black/40 rounded-xl p-4 mb-6 border border-white/10 font-mono">
                        <div x-show="introTab === 'members'" class="grid grid-cols-1 gap-2">
                            <template x-for="member in memberData" :key="member.sNumber">
                                <div class="flex items-center p-3 rounded-lg border border-white/5 bg-white/5">
                                    <div class="w-12 h-12 flex items-center justify-center rounded-md mr-4 font-black text-xl border-2" :style="`background-color: ${member.color}; border-color: #A0A0A0; color: #000;`" x-text="member.sNumber"></div>
                                    <div class="flex flex-col">
                                        <span class="text-white font-bold text-lg" x-text="member.kor"></span>
                                        <span class="text-gray-400 text-xs uppercase tracking-wider" x-text="member.eng"></span>
                                    </div>
                                    <div class="ml-auto text-right">
                                        <span class="text-cyan-300 font-bold" x-text="member.birthday"></span>
                                        <span class="text-gray-500 text-xs block">BIRTHDAY</span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="introTab === 'dimensions'" class="space-y-4">
                             <template x-for="dim in dimensionData" :key="dim.sNumber">
                                <div class="glass-panel p-3 rounded-xl border border-white/5 bg-white/5">
                                    <div class="flex items-center mb-3">
                                        <div class="px-3 py-1 rounded-lg font-black text-lg mr-2 border" :style="`background-color: ${dim.color}; color: ${dim.textColor}; border-color: #A0A0A0;`" x-text="dim.sNumber"></div>
                                        <span class="text-gray-400 text-xs tracking-widest" x-text="`${getMembersByDimension(dim.sNumber).length} Members`"></span>
                                    </div>
                                    <div class="grid grid-cols-5 gap-2">
                                         <template x-for="member in getMembersByDimension(dim.sNumber)" :key="member.sNumber">
                                             <div class="flex flex-col items-center p-1 bg-black/30 rounded-lg border border-white/10">
                                                 <div class="w-8 h-8 flex items-center justify-center rounded-md font-bold text-sm border" :style="`background-color: ${member.color}; border-color: #A0A0A0; color: #000;`" x-text="member.sNumber"></div>
                                                 <span class="text-gray-300 text-xs mt-1" x-text="member.kor"></span>
                                             </div>
                                         </template>
                                    </div>
                                </div>
                             </template>
                        </div>
                    </div>
                    <button @click="startActualGame()" class="glass-button btn-green-glow w-full py-4 text-2xl font-bold rounded-2xl text-green-400">CONFIRM</button>
                </div>
            </div>

            <div x-show="gameState === 'playing'" x-transition.opacity.duration.300ms class="w-full h-full flex flex-col relative z-10">
                <header id="dashboard" class="w-full p-3 glass-panel shadow-lg z-20 border-t-0 rounded-b-2xl mb-1">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-left flex-shrink-0"><span class="text-xs text-gray-400 font-bold tracking-widest" id="score-anchor">SCORE</span><span class="text-2xl font-bold text-yellow-300 ml-2 text-glow-sm" x-text="score"></span></div>
                        <div class="text-center flex-grow px-2"><div class="flex justify-center items-center space-x-2">
                            <template x-if="timePlusLevel > 0"><span class="text-lg filter drop-shadow-lg" title="TIME+ (ÏãúÍ∞Ñ Ïó∞Ïû•)" x-text="ITEM_INFO.timePlus.icon"></span></template>
                            <template x-if="scanLevel > 0"><span class="text-lg filter drop-shadow-lg" title="SCAN (ÏÉùÏùº ÌûåÌä∏)" x-text="ITEM_INFO.scan.icon"></span></template>
                            <template x-if="amuletLevel > 0"><span class="text-lg filter drop-shadow-lg" title="AMULET (Îã¨Ïùò Î∂ÄÏ†Å)" x-text="ITEM_INFO.amulet.icon"></span></template>
                            <template x-if="assistLevel > 0"><span class="text-lg filter drop-shadow-lg" title="ASSIST (ÏπúÍµ¨ Ìò∏Ï∂ú)" x-text="ITEM_INFO.assist.icon"></span></template>
                        </div></div>
                        <div class="text-right flex-shrink-0">
                            <span class="text-xs text-gray-400 mr-2 font-bold tracking-widest" x-text="stage >= 11 ? 'OVERTIME' : `STAGE ${stage}`"></span>
                            <span class="text-xl font-bold text-cyan-300 text-glow-sm" x-text="`${blocksCompleted} / ${totalBlocksPerStage}`"></span>
                        </div>
                    </div>
                    <div class="flex items-center w-full space-x-3">
                        <div class="flex-grow bg-black/50 rounded-full h-2 border border-white/10 overflow-hidden"><div class="bg-gradient-to-r from-red-600 to-pink-500 h-full rounded-full transition-all duration-100 ease-linear" :style="currentBlock ? `width: ${(currentBlock.timer / currentBlock.timeLimit) * 100}%` : 'width: 100%'"></div></div>
                        <span class="text-lg font-bold text-pink-400 text-glow-sm w-8 text-right" x-text="currentBlock ? Math.ceil(currentBlock.timer / 1000) : '..'"></span>
                    </div>
                </header>

                <div id="order-area" class="w-full flex-shrink-0 p-2 glass-panel my-1 rounded-2xl relative">
                    <template x-if="chainCount > 0">
                        <div class="absolute top-2 right-3 flex flex-col items-end z-10">
                            <span class="text-cyan-400 text-xs font-bold tracking-widest animate-pulse mb-1 leading-none">CHAIN</span>
                            <div class="flex items-center">
                                <span class="text-lg mr-1 animate-pulse">‚õìÔ∏è</span>
                                <span class="text-yellow-300 text-2xl font-black text-glow-sm leading-none" x-text="chainCount"></span>
                            </div>
                        </div>
                    </template>
                    <div class="flex items-center justify-center space-x-2 h-16" id="boss-block-anchor">
                        <template x-if="!currentBlock && blocksCompleted < totalBlocksPerStage"><div>
                            <span x-show="nextBlockWillBeBoss" class="text-red-400 font-bold animate-pulse text-xl font-mono text-glow-sm" x-text="translate('playing_next_block_boss')"></span>
                            <span x-show="!nextBlockWillBeBoss" class="text-xl text-gray-400 tracking-widest animate-pulse font-mono text-glow-sm" x-text="translate('playing_next_block_normal')"></span>
                        </div></template>
                        <template x-if="currentBlock?.bundleType === 'sNumber'">
                            <template x-for="(member, index) in currentBlock?.members" :key="currentBlock.id + '_' + index">
                                <div x-data="objektCard(member)" class="flex-shrink-0 w-14 h-16 rounded-lg flex flex-col items-center justify-center p-1 shadow-lg border-2" 
                                     :class="[borderStyles, matchedOrderIndices[index] ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-green-400' : '']" 
                                     :style="cardStyles.background">
                                    <span class="text-xl font-extrabold" :style="cardStyles.text" x-text="member.sNumber"></span>
                                </div>
                            </template>
                        </template>
                        <template x-if="currentBlock?.bundleType === 'birthday'">
                            <template x-for="(member, index) in currentBlock?.members" :key="currentBlock.id + '_' + index">
                                <div class="flex-shrink-0 w-14 h-16 rounded-lg flex flex-col items-center justify-center p-1 shadow-lg border-2" 
                                     :class="matchedOrderIndices[index] ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-green-400' : ''" 
                                     :style="getBirthdayBackground(member)">
                                    <span class="font-extrabold" style="color: #000000;" :class="member.birthday.length > 4 ? 'text-base' : 'text-lg'" x-text="member.birthday"></span>
                                </div>
                            </template>
                        </template>
                        <template x-if="currentBlock?.bundleType === 'dimension'">
                            <div x-data="{ 
                                 dimension: dimensionData.find(d => d.sNumber === currentBlock?.bundleLabel), 
                                 cardData: { 
                                     color: dimensionData.find(d => d.sNumber === currentBlock?.bundleLabel)?.color, 
                                     sNumber: currentBlock?.bundleLabel, 
                                     customTextColor: dimensionData.find(d => d.sNumber === currentBlock?.bundleLabel)?.textColor 
                                 } 
                             }" 
                                 class="flex-shrink-0 w-32 h-16 rounded-lg flex flex-col items-center justify-center p-1 shadow-lg border-2" 
                                 :class="{ 'boss-border': currentBlock?.isBoss }" 
                                 :style="`background-color: ${dimension?.color || '#FFFFFF'}; ${!currentBlock?.isBoss ? 'border-color: #A0A0A0' : ''}`">
                                <div x-data="objektCard(cardData)" class="flex flex-col items-center justify-center h-full">
                                    <span class="text-2xl font-extrabold" :style="cardStyles.text" x-text="currentBlock?.bundleLabel"></span>
                                    <span class="text-xs font-bold" :style="cardStyles.text" x-text="currentBlock?.members?.length ? `${currentBlock?.members?.length} Members` : ''"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div id="slot-line" class="w-full flex-shrink-0 p-2 mb-1 rounded-2xl glass-panel" style="background: rgba(0,0,0,0.5);">
                    <div class="flex space-x-2 overflow-x-auto scrollbar-thin h-24 items-center px-1">
                        <template x-if="completedCards.length === 0 && currentBlock">
                            <div class="flex-shrink-0 w-16 h-20 bg-white/5 rounded-lg flex items-center justify-center border-2 border-dashed border-white/20">
                                <span class="text-gray-500 text-xs text-center p-1" x-text="'SLOTS: ' + (currentBlock?.members?.length || 0)"></span>
                            </div>
                        </template>
                        <template x-for="(card, index) in completedCards" :key="card.id">
                            <div x-data="objektCard(card, false)">
                                <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" 
                                     :class="[borderStyles, isMatchingOrder(card, index) ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-green-400' : '']" 
                                     :style="cardStyles.background">
                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-1">
                                        <span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span>
                                        <span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span>
                                    </div>
                                    <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'">
                                        <span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div id="collect-area" class="w-full flex-shrink-0 glass-panel p-2 mb-1 rounded-2xl">
                    <div class="flex space-x-2 overflow-x-auto scrollbar-thin h-24 items-center px-1">
                        <template x-if="inventory.length === 0"><span class="text-gray-500 text-sm px-4 tracking-widest opacity-50">EMPTY COLLECT</span></template>
                        <template x-for="card in inventory" :key="card.inventoryId">
                            <button @click="selectInventoryCard(card)" class="relative transition-transform active:scale-95" 
                                        :class="{'ring-2 ring-offset-2 ring-offset-gray-900 ring-purple-500 rounded-lg': isSelectedInventory(card.inventoryId)}">
                                <div x-data="objektCard(card)">
                                    <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" 
                                        :class="[borderStyles, checkSmartGuide(card) ? 'guide-pulse' : '']" 
                                        :style="cardStyles.background">
                                        <div class="flex-grow h-full flex flex-col items-center justify-center p-1">
                                            <span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span>
                                            <span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span>
                                        </div>
                                        <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'">
                                            <span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </template>
                    </div>
                </div>

                <div class="w-full px-1 py-2 grid grid-cols-2 gap-3">
                    <button @click="reloadData()" class="glass-button w-full py-4 text-xl font-bold rounded-2xl transition-all active:scale-95" :class="{'guide-pulse': checkSmartReload()}">
                        RELOAD
                        <span :class="getReloadDisplayColor()" x-text="`(${getReloadDisplayCount()})`"></span>
                    </button>
                    <button @click="inputData()" :disabled="!inputEnabled()" 
                            :class="{ 'opacity-50 cursor-not-allowed': !inputEnabled(), 'btn-green-glow text-green-400': inputEnabled() }" 
                            class="glass-button w-full py-4 text-xl font-bold rounded-2xl transition-all active:scale-95">INPUT</button>
                </div>

                <div id="data-pool" class="w-full flex-grow grid grid-cols-2 gap-2 p-2 glass-panel rounded-t-2xl overflow-hidden border-b-0 md:max-h-80">
                    <template x-if="isDataReady">
                        <div class="grid grid-cols-2 grid-rows-3 gap-2 h-full">
                            <template x-for="(data, index) in korData" :key="data.id">
                                <button @click="selectData('kor', data.name, data.id)" 
                                        :class="[
                                            isSelectedData(data.id) ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-purple-500' : 'bg-white/5 hover:bg-white/10',
                                            checkSmartGuide(data) ? 'guide-pulse' : ''
                                        ]" 
                                        class="w-full h-full flex items-center justify-center text-base font-medium rounded-xl shadow-sm transition-all transform active:scale-95 text-center p-1 border border-white/5 backdrop-blur-sm text-gray-200">
                                    <span x-text="data.name"></span>
                                </button>
                            </template>
                        </div>
                    </template>
                    <template x-if="isDataReady">
                        <div class="grid grid-cols-2 grid-rows-3 gap-2 h-full">
                            <template x-for="(data, index) in engData" :key="data.id">
                                <button @click="selectData('eng', data.name, data.id)" 
                                        :class="[
                                            isSelectedData(data.id) ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-purple-500' : 'bg-white/5 hover:bg-white/10',
                                            checkSmartGuide(data) ? 'guide-pulse' : ''
                                        ]" 
                                        class="w-full h-full flex items-center justify-center text-base font-medium rounded-xl shadow-sm transition-all transform active:scale-95 text-center p-1 border border-white/5 backdrop-blur-sm text-gray-200">
                                    <span x-text="data.name"></span>
                                </button>
                            </template>
                        </div>
                    </template>
                </div>
            </div> 
            
             <div x-show="isStarting" x-transition.opacity.duration.300ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/60 backdrop-blur-sm z-40">
                <span class="text-6xl font-black text-gray-100" :class="startCountdown === 'START!' ? 'countdown-zoom' : ''" x-text="startCountdown"></span>
            </div>
            
            <div x-show="gameState === 'transition'" x-transition.opacity.duration.50ms class="absolute inset-0 w-full h-full bg-black z-50"></div>

            <div x-show="gameState === 'submitScore'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center p-8 z-50 bg-black/80 backdrop-blur-md">
                <div class="glass-panel p-8 rounded-3xl w-full flex flex-col items-center">
                    <h2 class="text-4xl font-bold text-yellow-300 text-glow-sm text-center mb-4">NEW HIGH SCORE!</h2>
                    
                    <template x-if="existingRecord || (playerName !== 'SSS' && playerName)">
                        <div class="text-center mb-6">
                            <p class="text-gray-400 text-lg tracking-widest mb-2">AGENT CONFIRMED</p>
                            <div class="text-3xl font-black text-white border border-white/20 bg-white/5 px-6 py-3 rounded-xl inline-block">
                                <span x-text="playerName"></span> </div>
                            <p x-show="existingRecord" class="text-green-400 text-sm font-bold mt-2">RECORD UPDATE AVAILABLE</p>
                        </div>
                    </template>

                    <template x-if="!existingRecord && (playerName === 'SSS' || !playerName)">
                        <div class="w-full flex flex-col items-center">
                            <label for="playerNameInput" class="text-lg text-gray-400 mb-2 tracking-widest">CODENAME (3 CHARS)</label>
                            <input type="text" id="playerNameInput" x-model="playerName" @input="playerName = playerName.toUpperCase().replace(/[^A-Z0-9]/g, '')" maxlength="3" class="w-40 h-20 bg-black/50 border-2 border-white/20 text-white text-5xl font-bold text-center rounded-2xl focus:outline-none focus:border-purple-500 mb-8 tracking-widest">
                        </div>
                    </template>

                    <div class="mb-6 text-center">
                         <p class="text-sm text-gray-500 font-bold tracking-widest mb-1">NEW SCORE</p>
                         <p class="text-5xl font-black text-white text-glow" x-text="(stage === 11) ? lastStageScore : totalScore"></p>
                    </div>

                    <button @click="submitScore()" 
                            :disabled="currentSeason.state === 'frozen'"
                            class="glass-button w-full py-4 text-2xl font-bold rounded-2xl"
                            :class="currentSeason.state === 'frozen' ? 'opacity-50 cursor-not-allowed text-gray-500' : 'btn-green-glow text-green-400'">
                        <span x-text="currentSeason.state === 'frozen' ? 'SEASON CLOSED' : (existingRecord ? 'UPDATE RECORD' : 'REGISTER AGENT')"></span>
                    </button>
                    <p x-show="currentSeason.state === 'frozen'" class="text-red-400 mt-2 text-sm font-bold">Rankings are frozen (25th ~ End of Month)</p>
                </div>
            </div>

            <div x-show="gameState === 'intermission'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col p-4 z-50 bg-black/80 backdrop-blur-md" x-cloak>
                <div class="flex-grow overflow-y-auto scrollbar-thin space-y-6 pb-4">
                    <div id="report" class="glass-panel p-5 rounded-3xl relative overflow-hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold" :class="lastStageGrade === 'F' ? 'text-red-400 text-glow-sm' : 'text-green-400 text-glow-sm'">
                                <span x-show="stage < 11" x-text="`STAGE ${stage - 1} CLEAR!`"></span>
                                <span x-show="stage === 11" x-text="'OVERTIME CLEAR!'"></span>
                            </h2>
                            <div class="flex space-x-1.5">
                                <button @click="showRanking()" class="glass-button p-1 rounded-full" title="REKORD">üèÜ</button>
                                <button @click="showSettings()" class="glass-button p-1 rounded-full" title="CONFIG">‚öôÔ∏è</button>
                            </div>
                        </div>
                        <div class="flex justify-around items-center text-gray-300 mb-6">
                            <div class="flex flex-col items-center"><span class="text-xs text-gray-500 font-bold tracking-widest mb-1">TOTAL SCORE</span><span class="text-xl font-bold text-yellow-300" x-text="totalScore"></span></div>
                            <div class="flex flex-col items-center mx-2"><span class="text-xs text-gray-500 font-bold tracking-widest mb-1">RANK</span><span class="text-5xl font-black" :class="{'text-yellow-300 text-glow': lastStageGrade === 'S', 'text-green-400 text-glow-sm': lastStageGrade === 'A', 'text-blue-400 text-glow-sm': lastStageGrade === 'B', 'text-gray-500': lastStageGrade === 'C', 'text-red-500 text-glow': lastStageGrade === 'F'}" x-text="lastStageGrade"></span></div>
                            <div class="flex flex-col items-center"><span class="text-xs text-gray-500 font-bold tracking-widest mb-1">STAGE SCORE</span><span class="text-xl font-bold text-white" x-text="lastStageScore"></span></div>
                        </div>
                        <hr class="border-white/10 my-4">
                        <div class="relative pl-3">
                            <div class="absolute top-0 left-0 w-1 h-full" :class="lastStageGrade === 'F' ? 'bg-white' : 'bg-yellow-500'" rounded-full></div>
                            <p class="text-sm font-bold tracking-widest mb-1 flex items-center" :class="lastStageGrade === 'F' ? 'text-white' : 'text-yellow-500'">
                                <span x-text="lastStageGrade === 'F' ? 'MH MESSAGE' : 'BOSS J\'S COMMENT'"></span>
                                <span class="ml-2 text-xl" x-text="lastStageGrade === 'S' ? 'üòè' : (lastStageGrade === 'A' ? 'üôÇ' : (lastStageGrade === 'B' ? 'üòê' : (lastStageGrade === 'C' ? 'üò†' : '‚úâÔ∏è')))"></span>
                                <span class="ml-auto font-bold" x-show="lastStageGrade !== 'F'"><span class="text-purple-300">EARNED:</span><span class="text-white" x-text="comoEarned"></span><span x-show="bonusComo > 0" class="text-green-400" x-text="`+${bonusComo}`"></span></span>
                            </p>
                            <template x-if="lastStageGrade === 'F'">
                                <p class="text-lg text-gray-200 italic font-bold" x-text="bossJComment"></p>
                            </template>
                            <template x-if="lastStageGrade !== 'F'">
                                <p class="text-lg text-gray-200 italic" x-text="`&quot;${bossJComment}&quot;`"></p>
                            </template>
                        </div>
                    </div>
                    <div id="shop" class="relative">
                        <div class="flex justify-between items-center mb-3 px-2">
                            <h3 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">SHOP</h3>
                            <div class="glass-panel px-4 py-1 rounded-full flex items-center"><span class="text-lg font-black text-purple-300 mr-2">COMO</span><span class="text-lg font-bold text-white" x-text="como"></span></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button @click="openShopModal('objekt')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < ITEM_INFO.objekt.cost}">
                                <span class="text-3xl" x-text="ITEM_INFO.objekt.icon"></span>
                                <div class="flex flex-col">
                                    <span class="font-bold text-sm text-gray-200 leading-none mb-1">OBJEKT</span>
                                    <span class="text-xs font-bold" :class="como < ITEM_INFO.objekt.cost ? 'text-red-400' : 'text-purple-300'" x-text="`${ITEM_INFO.objekt.cost} COMO`"></span>
                                </div>
                            </button>
                            
                            <button @click="openShopModal('reload')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < ITEM_INFO.reload.cost, 'border-yellow-500/50': reloadBoost >= 20}">
                                <span class="text-3xl" x-text="ITEM_INFO.reload.icon"></span>
                                <div class="flex flex-col">
                                    <span class="font-bold text-sm text-gray-200 leading-none mb-1">RELOAD</span>
                                    <span class="text-xs font-bold" :class="reloadBoost >= 20 ? 'text-yellow-500' : 'text-purple-300'" x-text="reloadBoost >= 20 ? 'MAX' : `${ITEM_INFO.reload.cost} COMO`"></span>
                                </div>
                            </button>
                            
                            <template x-if="stage >= 5">
                                <button @click="openShopModal('timePlus')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < ITEM_INFO.timePlus.cost, 'border-green-500/50': timePlusLevel >= 1}">
                                    <span class="text-3xl" x-text="ITEM_INFO.timePlus.icon"></span>
                                    <div class="flex flex-col">
                                        <span class="font-bold text-sm text-gray-200 leading-none mb-1">TIME+</span>
                                        <span class="text-xs font-bold" :class="timePlusLevel >= 1 ? 'text-green-500' : 'text-purple-300'" x-text="timePlusLevel >= 1 ? 'MAX' : `${ITEM_INFO.timePlus.cost} COMO`"></span>
                                    </div>
                                </button>
                            </template>
                            <template x-if="stage >= 5">
                                <button @click="openShopModal('scan')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < ITEM_INFO.scan.cost, 'border-orange-500/50': scanLevel >= 1}">
                                    <span class="text-3xl" x-text="ITEM_INFO.scan.icon"></span>
                                    <div class="flex flex-col">
                                        <span class="font-bold text-sm text-gray-200 leading-none mb-1">SCAN</span>
                                        <span class="text-xs font-bold" :class="scanLevel >= 1 ? 'text-orange-500' : 'text-purple-300'" x-text="scanLevel >= 1 ? 'MAX' : `${ITEM_INFO.scan.cost} COMO`"></span>
                                    </div>
                                </button>
                            </template>
                            
                            <template x-if="stage >= 7">
                                <button @click="openShopModal('amulet')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < ITEM_INFO.amulet.cost, 'border-purple-500/50': amuletLevel >= 1}">
                                    <span class="text-3xl" x-text="ITEM_INFO.amulet.icon"></span>
                                    <div class="flex flex-col">
                                        <span class="font-bold text-sm text-gray-200 leading-none mb-1">AMULET</span>
                                        <span class="text-xs font-bold" :class="amuletLevel >= 1 ? 'text-purple-500' : 'text-purple-300'" x-text="amuletLevel >= 1 ? 'MAX' : `${ITEM_INFO.amulet.cost} COMO`"></span>
                                    </div>
                                </button>
                            </template>
                            <template x-if="stage >= 7">
                                <button @click="openShopModal('assist')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < ITEM_INFO.assist.cost, 'border-cyan-500/50': assistLevel >= 1}">
                                    <span class="text-3xl" x-text="ITEM_INFO.assist.icon"></span>
                                    <div class="flex flex-col">
                                        <span class="font-bold text-sm text-gray-200 leading-none mb-1">ASSIST</span>
                                        <span class="text-xs font-bold" :class="assistLevel >= 1 ? 'text-cyan-500' : 'text-purple-300'" x-text="assistLevel >= 1 ? 'MAX' : `${ITEM_INFO.assist.cost} COMO`"></span>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </div>
                    <div id="collect" class="glass-panel p-3 rounded-2xl">
                        <div class="flex justify-between items-center mb-3 px-1">
                            <h3 class="text-lg font-bold text-gray-300 tracking-wider">COLLECT (<span x-text="inventory.length"></span>/<span x-text="inventoryMaxSize"></span>)</h3>
                             <div class="flex justify-center items-center space-x-2 opacity-80">
                                <template x-if="timePlusLevel > 0"><span class="text-lg filter drop-shadow-lg" title="TIME+" x-text="ITEM_INFO.timePlus.icon"></span></template>
                                <template x-if="scanLevel > 0"><span class="text-lg filter drop-shadow-lg" title="SCAN" x-text="ITEM_INFO.scan.icon"></span></template>
                                <template x-if="amuletLevel > 0"><span class="text-lg filter drop-shadow-lg" title="AMULET" x-text="ITEM_INFO.amulet.icon"></span></template>
                                <template x-if="assistLevel > 0"><span class="text-lg filter drop-shadow-lg" title="ASSIST" x-text="ITEM_INFO.assist.icon"></span></template>
                             </div>
                        </div>
                        <div class="flex space-x-2 overflow-x-auto scrollbar-thin h-24 items-center mb-3 px-1">
                            <template x-if="inventory.length === 0"><span class="text-gray-500 text-sm px-4 tracking-widest opacity-50">EMPTY COLLECT</span></template>
                            <template x-for="card in inventory" :key="card.inventoryId">
                                <button @click="selectInventoryCard(card)" class="relative transition-transform active:scale-95" 
                                        :class="{'ring-2 ring-offset-2 ring-offset-gray-900 ring-purple-500 rounded-lg': isSelectedInventory(card.inventoryId)}">
                                    <div x-data="objektCard(card)">
                                        <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" 
                                            :class="borderStyles" 
                                            :style="cardStyles.background">
                                            <div class="flex-grow h-full flex flex-col items-center justify-center p-1">
                                                <span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span>
                                                <span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span>
                                            </div>
                                            <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'">
                                                <span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span>
                                            </div>
                                        </div>
                                    </div>
                                </button>
                            </template>
                        </div>
                        <template x-if="stage >= 4">
                            <div class="grid grid-cols-2 gap-3">
                                <button @click="startSpin()" :disabled="!selectedInventoryCard || intermissionSpinCount >= 3" 
                                        class="glass-button py-3 text-pink-400 font-bold rounded-xl" 
                                        :class="{'opacity-50': !selectedInventoryCard || intermissionSpinCount >= 3, 'btn-red-glow': selectedInventoryCard && intermissionSpinCount < 3}">
                                    SPIN üéüÔ∏è<span x-text="3 - intermissionSpinCount"></span>
                                </button>
                                <button @click="startGridCraft()" :disabled="!canCraft()" 
                                        class="glass-button py-3 text-teal-400 font-bold rounded-xl" 
                                        :class="{'opacity-50': !canCraft(), 'btn-green-glow': canCraft()}">
                                    GRID
                                </button>
                            </div>
                        </template>
                    </div>
                    <template x-if="stage >= 6 && stageConfig[Math.min(stage - 1, stageConfig.length - 1)].bosses.length > 0 && bossPools[stageConfig[Math.min(stage - 1, stageConfig.length - 1)].bosses[0]]">
                        <div id="gravity" class="glass-panel p-4 rounded-2xl relative">
                            <h3 class="text-lg font-bold text-cyan-400 mb-2 tracking-wider">GRAVITY</h3>
                            <p class="text-sm text-gray-400 mb-3">
                                <span x-show="stage === 11" x-text="`[GLOBAL] ${translate('gravity_desc_stage')} ${stage} ${translate('gravity_desc_suffix')}`"></span>
                                <span x-show="stage < 11" x-text="`[LOCAL] ${translate('gravity_desc_stage')} ${stage} ${translate('gravity_desc_suffix')}`"></span>
                            </p>
                            <div class="grid grid-cols-2 gap-2">
                                <template x-for="bossName in getGravityVotes(stageConfig[Math.min(stage - 1, stageConfig.length - 1)].bosses[0])" :key="bossName">
                                    <button @click="voteForBoss(bossName)" class="glass-button p-3 rounded-xl flex flex-col justify-center items-center space-y-1">
                                        <span class="text-lg font-bold text-white" x-text="bossName"></span>
                                        <span class="font-bold text-cyan-300 text-sm">
                                            <span x-show="stage === 11" x-text="`${(seasonGravityVotes[bossName] || 0)} VOTES`"></span>
                                            <span x-show="stage < 11" x-text="`${(localGravityVotes[bossName] || 0)} VOTES`"></span>
                                            
                                            <span class="text-gray-400 ml-1" x-text="`(${getBossProbability(bossName, stageConfig[Math.min(stage - 1, stageConfig.length - 1)].bosses[0])}%)`"></span>
                                        </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="flex-shrink-0 pt-2 bg-black/20 backdrop-blur-md -mx-4 px-4 -mb-4 pb-2 rounded-t-xl z-20">
                    <div class="grid grid-cols-2 gap-4">
                        <button @click="confirmReturn()" class="glass-button w-full py-4 text-2xl font-bold rounded-2xl text-gray-400 hover:text-white">RETURN</button>
                        <button @click="handleIntermissionNext()" 
                                :disabled="lastStageGrade === 'F'"
                                class="glass-button w-full py-4 text-2xl font-bold rounded-2xl relative" 
                                :class="{
                                    'opacity-50 cursor-not-allowed text-gray-400 hover:text-gray-400': lastStageGrade === 'F', 
                                    'btn-green-glow text-green-400': lastStageGrade !== 'F'
                                }">
                            NEXT
                            <template x-if="lastStageGrade === 'F'">
                                <span class="absolute inset-0 flex items-center justify-center z-10">
                                    <span class="text-4xl filter drop-shadow-xl">üîí</span>
                                </span>
                            </template>
                        </button>
                    </div>
                </div>
            </div>

            <div x-show="report.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[60] p-6" @click="closeStageReport()">
                <div class="glass-panel p-6 rounded-3xl text-center border border-purple-500/50 shadow-[0_0_30px_rgba(168,85,247,0.3)] unlock-bounce max-w-sm w-full" @click.stop>
                    
                    <template x-if="report.unlockMessage">
                        <div class="mb-4 p-2 rounded-xl bg-purple-600/50 border border-purple-500/80">
                            <h3 class="text-lg font-black text-yellow-300" x-text="report.unlockMessage"></h3>
                        </div>
                    </template>
                    
                    <h3 class="text-3xl font-black text-white mb-4 tracking-widest">
                        <span x-show="report.stage <= 10">STAGE <span x-text="report.stage"></span> REPORT</span>
                        <span x-show="report.stage === 11">OVERTIME REPORT</span>
                    </h3>
                    
                    <div class="text-left space-y-3 bg-black/30 p-4 rounded-xl mb-6">
                        <div class="text-2xl font-bold text-yellow-300 border-b border-white/10 pb-2 flex justify-between">
                            <span>TOTAL SCORE</span>
                            <span x-text="report.score"></span>
                        </div>
                        
                        <div class="text-sm font-bold text-gray-400 flex justify-between">
                            <span>CLEARED BLOCKS (NO TIME-OUT)</span>
                            <span class="text-white"><span x-text="report.clearedBlocks"></span> / <span x-text="report.maxBlocks"></span></span>
                        </div>
                        
                        <hr class="border-white/10">

                        <h4 class="text-base font-bold text-green-400 mb-1">SCORE BREAKDOWN (+)</h4>
                        <div class="pl-3 space-y-1">
                            <div class="text-sm font-medium text-gray-300 flex justify-between"><span>BASE SCORE üéØ</span><span x-text="report.baseScore"></span></div>
                            <div class="text-sm font-medium text-gray-300 flex justify-between"><span>PERFECT BONUS ‚ú®</span><span x-text="report.perfectBonusScore"></span></div>
                            <div class="text-sm font-medium text-gray-300 flex justify-between"><span>CHAIN BONUS ‚õìÔ∏è</span><span x-text="report.chainBonusScore"></span></div>
                        </div>
                        
                        <hr class="border-white/10">

                        <h4 class="text-base font-bold text-red-400 mb-1">PENALTY (-)</h4>
                        <div class="pl-3 space-y-1">
                            <div class="text-sm font-medium text-gray-300 flex justify-between"><span>FAIL PENALTY ‚ùå</span><span x-text="report.failPenalty"></span></div>
                            <div class="text-sm font-medium text-gray-300 flex justify-between"><span>TIME OVER PENALTY ‚è≥</span><span x-text="report.timeOverPenalty"></span></div>
                            <div class="text-sm font-medium text-gray-300 flex justify-between"><span>RELOAD COST üîÑ</span><span x-text="report.reloadPenalty"></span></div>
                        </div>

                        <hr class="border-white/10">

                        <h4 class="text-base font-bold text-cyan-400 mb-1">STATISTICS</h4>
                        <div class="pl-3 grid grid-cols-2 gap-2 text-sm font-medium text-gray-300">
                            <div class="flex justify-between"><span>MAX CHAIN</span><span x-text="report.maxChain"></span></div>
                            <div class="flex justify-between"><span>PERFECT BLOCKS</span><span x-text="report.perfectCount"></span></div>
                        </div>
                    </div>
                    
                    <button @click="closeStageReport()" class="glass-button px-8 py-3 text-purple-300 text-xl font-bold rounded-xl hover:text-white hover:border-purple-400">NEXT</button>
                </div>
            </div>

            <div x-show="returnConfirmModal.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[65] p-6" @click="cancelReturn()">
                <div class="glass-panel p-6 rounded-3xl text-center border border-red-500/50 shadow-2xl max-w-sm w-full" @click.stop>
                    <h3 class="text-2xl font-black text-red-400 mb-4" x-text="translate('confirm_return_title')"></h3>
                    <p class="text-lg text-gray-200 mb-8 whitespace-pre-line" x-text="translate('confirm_return_msg')"></p>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="cancelReturn()" class="glass-button py-3 text-gray-300 font-bold rounded-xl">BACK</button>
                        <button @click="restartGame()" class="glass-button py-3 font-bold rounded-xl text-red-400 border-red-500/50">RETURN</button>
                    </div>
                </div>
            </div>
            
            <div x-show="resetConfirmModal.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[65] p-6" @click="cancelReset()">
                <div class="glass-panel p-6 rounded-3xl text-center border border-red-500/50 shadow-2xl max-w-sm w-full" @click.stop>
                    <h3 class="text-2xl font-black text-red-400 mb-4">‚ö†Ô∏è DATA RESET WARNING</h3>
                    <template x-if="resetConfirmModal.type === 'ranking'">
                        <p class="text-lg text-gray-200 mb-8">All ranking data will be deleted. Continue?</p>
                    </template>
                    <template x-if="resetConfirmModal.type === 'all'">
                        <p class="text-lg text-gray-200 mb-8">All saved data (Rankings, Items, Settings) will be permanently deleted. Continue?</p>
                    </template>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="cancelReset()" class="glass-button py-3 text-gray-300 font-bold rounded-xl">BACK</button>
                        <button @click="executeReset()" class="glass-button py-3 font-bold rounded-xl text-red-400 border-red-500/50">RESET</button>
                    </div>
                </div>
            </div>

            <div x-show="gameState === 'ranking'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-between p-4 z-50 bg-black/80 backdrop-blur-md">
                <div class="flex-grow overflow-y-auto scrollbar-thin -mr-4 pr-4">
                    <h2 class="text-4xl font-black text-center mt-6 mb-2 text-white">REKORD ARCHIVE</h2>
                    <div class="text-center mb-6">
                        <span class="text-xl font-black tracking-widest text-glow-sm" 
                              :style="`color: ${currentSeason.state === 'frozen' ? '#9CA3AF' : currentSeason.color}; text-shadow: 0 0 10px ${currentSeason.state === 'frozen' ? '#9CA3AF' : currentSeason.color}80;`">
                              
                            <span x-text="currentSeason.id"></span>
                            
                            <span x-show="currentSeason.state === 'active'" 
                                  title="Season Reward"
                                  class="ml-2 inline-flex items-center justify-center w-7 h-7 bg-black/30 rounded-full border border-yellow-300/30 align-middle"
                                  style="transform: translateY(-3px);"> <span class="text-sm" x-text="currentSeason.badge"></span>
                            </span>
                            
                            <span x-show="currentSeason.state === 'active'" 
                                  class="ml-2 font-bold text-cyan-400"
                                  :class="currentSeason.dDay === 1 ? 'animate-pulse' : ''"
                                  x-text="`D-${currentSeason.dDay}`">
                            </span>
                              
                            <span x-show="currentSeason.state === 'frozen'" 
                                  class="ml-2 text-sm font-bold text-gray-500"
                                  x-text="currentSeason.frozenText">
                            </span>
                        </span>
                    </div>
                    <div class="flex w-full mb-4 rounded-xl glass-panel p-1">
                        <button @click="rankingTab = 'main'" class="w-1/2 py-3 rounded-xl text-lg font-bold transition-all" :class="rankingTab === 'main' ? 'bg-purple-600/80 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'">STANDARD</button>
                        <button @click="rankingTab = 'extra'" class="w-1/2 py-3 rounded-xl text-lg font-bold transition-all" :class="rankingTab === 'extra' ? 'bg-teal-600/80 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'">OVERTIME</button>
                    </div>

                    <div class="space-y-1">
                        <template x-if="(rankingTab === 'main' && highScores.length === 0) || (rankingTab === 'extra' && extraHighScores.length === 0)">
                            <div class="text-center py-8">
                                <p class="text-gray-500 text-lg mb-2">NO REKORD</p>
                                <p class="text-xs text-gray-600">Be the first to register in <span x-text="currentSeason.id"></span>!</p>
                            </div>
                        </template>
                        
                        <template x-for="(entry, index) in (rankingTab === 'main' ? highScores : extraHighScores)" :key="entry.name + entry.score + index + rankingTab">
                            <div>
                                <div class="flex items-center justify-between glass-panel p-4 rounded-2xl text-lg z-10 relative" 
                                     :class="{'bg-yellow-500/10 border-yellow-500/30': index === 0, 'bg-gray-400/10 border-gray-400/30': index === 1, 'bg-yellow-700/10 border-yellow-700/30': index === 2}">
                                    
                                    <div class="flex items-center min-w-0">
                                        <span class="font-bold w-8 text-left flex-shrink-0" :class="{'text-yellow-300 text-glow-sm': index === 0, 'text-gray-300': index === 1, 'text-yellow-700': index === 2, 'text-gray-600': index > 2}" x-text="`${index + 1}.`"></span>
                                        
                                        <span class="text-2xl mr-2 flex-shrink-0" x-text="entry.profileBadge || DEFAULT_BADGE"></span>
                                        
                                        <span class="font-bold text-xl text-white truncate" x-text="entry.name"></span>
                                    </div>

                                    <div class="text-right flex-shrink-0 pl-2">
                                        <span class="font-bold text-xl text-yellow-300" x-text="entry.score"></span>
                                        <span class="text-xs text-gray-500 block" x-text="entry.season ? `SEASON: ${entry.season}` : ''"></span>
                                    </div>
                                </div>
                                <div x-show="(entry.items && (entry.items.reload > 0 || entry.items.time > 0 || entry.items.scan > 0 || entry.items.amulet > 0 || entry.items.assist > 0)) || (entry.specialCards && entry.specialCards.length > 0)"
                                     class="glass-panel p-3 rounded-b-2xl -mt-2 z-0 bg-black/30 border-t-0 border-white/10">
                                    <div class="flex items-center space-x-2 mb-2 px-1" x-show="entry.items && (entry.items.reload > 0 || entry.items.time > 0 || entry.items.scan > 0 || entry.items.amulet > 0 || entry.items.assist > 0)">
                                        <template x-if="entry.items.reload > 0"><span class="text-base" :title="ITEM_INFO.reload.title"><span x-text="ITEM_INFO.reload.icon"></span>(<span x-text="entry.items.reload"></span>)</span></template>
                                        <template x-if="entry.items.time > 0"><span class="text-base" :title="ITEM_INFO.timePlus.title" x-text="ITEM_INFO.timePlus.icon"></span></template>
                                        <template x-if="entry.items.scan > 0"><span class="text-base" :title="ITEM_INFO.scan.title" x-text="ITEM_INFO.scan.icon"></span></template>
                                        <template x-if="entry.items.amulet > 0"><span class="text-base" :title="ITEM_INFO.amulet.title" x-text="ITEM_INFO.amulet.icon"></span></template>
                                        <template x-if="entry.items.assist > 0"><span class="text-base" :title="ITEM_INFO.assist.title" x-text="ITEM_INFO.assist.icon"></span></template>
                                    </div>
                                    <div x-show="entry.specialCards && entry.specialCards.length > 0" class="flex flex-wrap gap-1 px-1">
                                        <template x-for="card in entry.specialCards" :key="card.inventoryId || card.sNumber">
                                            <div x-data="objektCard(card, false)">
                                                <div class="w-8 h-10 rounded-md flex shadow-sm border" :class="borderStyles" :style="`${cardStyles.background}; border-width: 1px;`">
                                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-0">
                                                        <span class="text-xs font-extrabold" style="color: #000;" x-text="card.sNumber.replace('S', '')"></span>
                                                    </div>
                                                    <div class="flex-shrink-0 w-1/5 h-full flex items-center justify-center rounded-r-sm holo-bg">
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    </div>
                <div class="flex-shrink-0 pt-2 bg-black/20 backdrop-blur-md -mx-4 px-4 -mb-4 pb-2 rounded-t-xl z-20">
                    <button @click="gameState = previousGameState; saveSettings()" class="glass-button w-full py-4 text-2xl font-bold rounded-2xl text-white">BACK
                    </button>
                </div>
            </div>
            <div x-show="gameState === 'settings'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-between p-4 z-50 bg-black/80 backdrop-blur-md">
                <div class="flex-grow overflow-y-auto scrollbar-thin -mr-4 pr-4">
                    <h2 class="text-4xl font-black text-center mt-6 mb-8 text-cyan-400 text-glow-sm">SYSTEM CONFIG</h2>
                    
                    <div class="glass-panel p-5 rounded-2xl mb-6 border-l-4 border-l-cyan-500">
                        <h3 class="text-xl font-bold text-gray-300 mb-4">AGENT PROFILE</h3>

                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="text-lg font-bold text-gray-300">AGENT BADGE</h4>
                                <p class="text-sm text-gray-400 mt-1">Your selected icon for the Rekord.</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center justify-center bg-black/50 border border-white/10 rounded-full w-16 h-16">
                                    <span class="text-4xl" x-text="userProfile.selectedBadge || DEFAULT_BADGE"></span>
                                </div>
                                <button @click="openBadgeModal()" class="glass-button px-4 py-2 rounded-xl text-sm font-bold text-cyan-300">Change</button>
                            </div>
                        </div>

                        <hr class="border-white/10 my-4">

                        <div>
                            <div class="flex justify-between items-center mb-4">
                                 <h4 class="text-lg font-bold text-gray-300">ACCOUNT KEY (UID)</h4>
                                 <button @click="openAccountModal()" class="glass-button px-2 py-1 rounded-lg text-sm" title="Manage Account">üîë Manage</button>
                            </div>
                            
                            <p class="text-xs text-yellow-400/70 mb-4 font-bold">WARNING: This is your secret key. Do not share it with anyone!</p>
                            
                            <div class="flex items-center space-x-2">
                                <div class="flex-grow bg-black/50 p-3 rounded-xl font-mono text-xs text-gray-300 truncate border border-white/10" x-text="activeUserId"></div>
                                <button @click="copyUid()" class="glass-button px-4 py-3 rounded-xl font-bold text-cyan-300">COPY</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-5 rounded-2xl mb-6 border-l-4 border-l-cyan-500">
                        <h3 class="text-xl font-bold text-gray-300 mb-4" x-text="translate('lang_select')"></h3>
                        <p class="text-sm text-gray-400 mb-4" x-text="translate('lang_desc')"></p>
                        <select x-model="currentLang" @change="setLanguage($event.target.value)" 
                                class="w-full bg-black/70 border border-purple-500/50 text-white py-3 px-4 rounded-xl text-lg font-bold appearance-none pr-10 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <template x-for="lang in supportedLangs" :key="lang.code">
                                <option :value="lang.code" x-text="lang.name" :selected="currentLang === lang.code"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div class="glass-panel p-5 rounded-2xl mb-6 border-l-4 border-l-cyan-500">
                        <h3 class="text-xl font-bold text-gray-300 mb-4 flex items-center">VOLUME CONTROL</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-base font-bold text-gray-400 mb-2 flex items-center">BGM VOLUME <span class="ml-auto text-cyan-300" x-text="`${Math.round(bgmVolume * 100)}%`"></span></h4>
                                <input type="range" min="0" max="1" step="0.05" :value="bgmVolume" @input="updateBGMVolume" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50">
                            </div>
                            <div>
                                <h4 class="text-base font-bold text-gray-400 mb-2 flex items-center">SFX VOLUME <span class="ml-auto text-cyan-300" x-text="`${Math.round(sfxVolume * 100)}%`"></span></h4>
                                <input type="range" min="0" max="1" step="0.05" :value="sfxVolume" @input="updateSFXVolume" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50">
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <button @click="openSuggestionModal()" class="glass-button w-full py-3 font-bold rounded-xl text-yellow-300 border-yellow-500/50 hover:bg-yellow-500/10">SEND SUGGESTION</button>
                    </div>

                    <div class="mb-6">
                        <button @click="confirmReset('all')" class="glass-button w-full py-3 font-bold rounded-xl text-red-400 border-red-500/50 hover:bg-red-500/10">RESET ALL DATA</button>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl mb-6 border border-white/10">
                        <h3 class="text-xl font-bold text-gray-300 mb-4 flex items-center">ABOUT</h3>
                        <div class="space-y-3 text-sm text-gray-400">
                            <div class="flex justify-between border-b border-white/5 pb-2">
                                <span>VERSION</span>
                                <span class="text-white font-mono">v10.311 (Badge System Refactor)</span>
                            </div>
                            <div class="flex justify-between border-b border-white/5 pb-2">
                                <span>DEVELOPER</span>
                                <span class="text-white">Kalsaver (2025)</span>
                            </div>
                            <div class="pt-2 text-xs text-gray-500 leading-relaxed text-center">
                                This is an unofficial fan game.<br>
                                All original IPs belong to MODHAUS.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex-shrink-0 pt-2 bg-black/20 backdrop-blur-md -mx-4 px-4 -mb-4 pb-2 rounded-t-xl z-20">
                    <button @click="gameState = previousGameState; saveSettings()" class="glass-button w-full py-4 text-2xl font-bold rounded-2xl text-white">BACK
                    </button>
                </div>
            </div>

            <div x-show="suggestionModal.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[65] p-6" @click="closeSuggestionModal()">
                <div class="glass-panel p-6 rounded-3xl w-full max-w-md" @click.stop>
                    <h3 class="text-2xl font-bold text-yellow-300 mb-4">SEND SUGGESTION</h3>
                    <p class="text-gray-400 text-sm mb-4">Bug reports, suggestions, or just a hello!<br>Messages are sent anonymously.</p>
                    
                    <textarea x-model="suggestionModal.message" placeholder="Type your message here..." class="w-full h-32 bg-black/50 border border-white/20 rounded-xl p-3 text-white focus:outline-none focus:border-yellow-300 mb-4 resize-none"></textarea>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="closeSuggestionModal()" class="glass-button py-3 text-gray-300 font-bold rounded-xl">BACK</button>
                        <button @click="sendSuggestion()" :disabled="suggestionModal.isSending || !suggestionModal.message.trim()" 
                                class="glass-button py-3 font-bold rounded-xl text-yellow-300 border-yellow-500/50"
                                :class="{'opacity-50 cursor-not-allowed': suggestionModal.isSending || !suggestionModal.message.trim()}">
                            <span x-show="!suggestionModal.isSending">SEND</span>
                            <span x-show="suggestionModal.isSending">SENDING...</span>
                        </button>
                    </div>
                </div>
            </div>

            <div x-show="badgeSelectModal.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[65] p-6" @click="closeBadgeModal()">
                <div class="glass-panel p-6 rounded-3xl w-full max-w-md" @click.stop>
                    <h3 class="text-2xl font-bold text-cyan-300 mb-4">SELECT AGENT BADGE</h3>
                    <p class="text-gray-400 text-sm mb-6">Select a badge to represent you on the Rekord.</p>
                    
                    <div x-show="isProfileLoading" class="text-center text-gray-400">Loading Badges...</div>
                    
                    <div x-show="!isProfileLoading" class="max-h-64 overflow-y-auto scrollbar-thin bg-black/30 rounded-xl p-4 border border-white/10 mb-6">
                        <div class="grid grid-cols-5 gap-3">
                            <button @click="selectBadge(DEFAULT_BADGE)" 
                                    class="glass-button w-full aspect-square flex items-center justify-center rounded-xl text-4xl transition-transform hover:scale-110"
                                    :class="userProfile.selectedBadge === DEFAULT_BADGE ? 'ring-2 ring-cyan-400' : 'opacity-70'">
                                <span x-text="DEFAULT_BADGE"></span>
                            </button>
                            
                            <template x-for="badge in userProfile.unlockedBadges.filter(b => b !== DEFAULT_BADGE)" :key="badge">
                                <button @click="selectBadge(badge)" 
                                        class="glass-button w-full aspect-square flex items-center justify-center rounded-xl text-4xl transition-transform hover:scale-110"
                                        :class="userProfile.selectedBadge === badge ? 'ring-2 ring-cyan-400' : 'opacity-70'">
                                    <span x-text="badge"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <button @click="closeBadgeModal()" class="glass-button w-full py-3 text-gray-300 font-bold rounded-xl">BACK</button>
                </div>
            </div>

            <div x-show="accountModalShow" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[65] p-6" @click="closeAccountModal()">
                <div class="glass-panel p-6 rounded-3xl w-full max-w-md" @click.stop>
                    <h3 class="text-2xl font-bold text-cyan-300 mb-4">ACCOUNT MANAGEMENT</h3>
                    
                    <div class="border-b border-white/10 pb-4">
                        <p class="text-sm text-gray-400 mb-2 font-bold">IMPORT ACCOUNT KEY</p>
                        <p class="text-xs text-yellow-400/70 mb-3">Paste a previously copied UID to load your account.</p>
                        <div class="flex items-center space-x-2">
                            <input type="text" x-model="inputUid" placeholder="Paste UID here..." class="flex-grow bg-black/50 border border-white/20 text-white py-3 px-4 rounded-xl text-sm focus:outline-none focus:border-cyan-500">
                            <button @click="loadUid()" class="glass-button px-4 py-3 rounded-xl font-bold text-yellow-300 border-yellow-500/50">APPLY</button>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-400 mb-2 font-bold">RESET ACCOUNT</p>
                        <p class="text-xs text-gray-500 mb-3">This will log you out of the current UID and return to a new guest account.</p>
                        <button @click="resetUid()" class="glass-button w-full py-3 font-bold rounded-xl text-red-400 border-red-500/50 hover:bg-red-500/10">Reset to Guest Account</button>
                    </div>

                    <hr class="border-white/10 my-6">
                    
                    <button @click="closeAccountModal()" class="glass-button w-full py-3 text-gray-300 font-bold rounded-xl">BACK</button>
                </div>
            </div>

            <div x-show="gameState === 'ending'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-start items-center p-4 z-50 text-center bg-black/80 backdrop-blur-md relative ending-screen-overlay overflow-y-auto scrollbar-thin">
                <div class="flex-grow w-full max-w-lg pt-4 pb-2">
                    <div class="glass-panel p-6 rounded-3xl mb-4 w-full border-4 transition-colors duration-500" 
                         :class="{
                             'border-yellow-300 shadow-[0_0_25px_rgba(253,224,71,0.5)]': endingType === 'S',
                             'border-green-400 shadow-[0_0_20px_rgba(52,211,153,0.4)]': endingType === 'A',
                             'border-blue-400 shadow-[0_0_15px_rgba(96,165,250,0.3)]': endingType === 'B',
                             'border-gray-500 shadow-none': endingType === 'C'
                         }">
                        <h2 class="text-5xl font-black text-glow mb-2 ending-rank-glow" 
                            :class="[ENDING_MESSAGES[endingType]?.theme || 'text-white', 'ending-rank-glow']" 
                            x-text="translate(ENDING_MESSAGES[endingType]?.title)">
                        </h2>
                        <p class="text-xl text-gray-300 whitespace-pre-line mb-6" x-text="translate(ENDING_MESSAGES[endingType]?.desc)"></p>
                        <p class="text-sm text-gray-500 font-bold tracking-widest mb-1">FINAL TOTAL SCORE</p>
                        <p class="text-7xl font-black text-yellow-300 text-glow" x-text="finalScore"></p>
                    </div>

                    <div class="glass-panel p-4 rounded-3xl w-full text-left space-y-4">
                        <h3 class="text-2xl font-bold text-cyan-300 tracking-widest border-b border-cyan-300/30 pb-2 mb-4">DETAILED MISSION REPORT</h3>
                        
                        <div class="p-3 bg-white/5 rounded-xl">
                            <h4 class="text-lg font-bold text-gray-300 mb-2">PERMANENT UPGRADES</h4>
                            <div class="flex flex-wrap gap-3 text-2xl">
                                <template x-if="timePlusLevel > 0"><span class="bg-gray-700/50 p-2 rounded-lg" :title="ITEM_INFO.timePlus.title"><span x-text="ITEM_INFO.timePlus.icon"></span> TIME+ Lv.1</span></template>
                                <template x-if="scanLevel > 0"><span class="bg-gray-700/50 p-2 rounded-lg" :title="ITEM_INFO.scan.title"><span x-text="ITEM_INFO.scan.icon"></span> SCAN Lv.1</span></template>
                                <template x-if="amuletLevel > 0"><span class="bg-gray-700/50 p-2 rounded-lg" :title="ITEM_INFO.amulet.title"><span x-text="ITEM_INFO.amulet.icon"></span> AMULET Lv.1</span></template>
                                <template x-if="assistLevel > 0"><span class="bg-gray-700/50 p-2 rounded-lg" :title="ITEM_INFO.assist.title"><span x-text="ITEM_INFO.assist.icon"></span> ASSIST Lv.1</span></template>
                                <template x-if="reloadBoost > 0"><span class="bg-gray-700/50 p-2 rounded-lg" :title="ITEM_INFO.reload.title"><span x-text="ITEM_INFO.reload.icon"></span> RELOAD +<span x-text="reloadBoost"></span></span></template>
                                <template x-if="timePlusLevel === 0 && scanLevel === 0 && amuletLevel === 0 && assistLevel === 0 && reloadBoost === 0"><span class="text-gray-500 text-sm italic">NO UPGRADES ACQUIRED</span></template>
                            </div>
                        </div>

                        <div class="p-3 bg-white/5 rounded-xl">
                            <h4 class="text-lg font-bold text-gray-300 mb-2">SPECIAL CARDS COLLECTED (<span x-text="inventory.filter(c => c.isSpecial).length"></span>)</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-if="inventory.filter(c => c.isSpecial).length === 0"><span class="text-gray-500 text-sm italic">NO SPECIAL CARDS ACQUIRED</span></template>
                                <template x-for="card in inventory.filter(c => c.isSpecial)" :key="card.inventoryId || card.sNumber">
                                    <div x-data="objektCard(card)">
                                        <div class="w-16 h-20 rounded-lg flex shadow-md border-2" :class="borderStyles" :style="cardStyles.background">
                                            <div class="flex-grow h-full flex flex-col items-center justify-center p-1"><span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span></div>
                                            <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md holo-bg"></div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="p-3 bg-white/5 rounded-xl">
                            <h4 class="text-lg font-bold text-gray-300 mb-2">STAGE GRADES (ST1 - ST10)</h4>
                            <div class="grid grid-cols-5 gap-2 text-center">
                                <template x-for="entry in stageGrades" :key="entry.stage">
                                    <div class="flex flex-col p-1 rounded-lg bg-black/30 border border-white/10">
                                        <span class="text-xs text-gray-400 font-bold">ST<span x-text="entry.stage"></span></span>
                                        <span class="text-2xl font-black" 
                                            :class="{
                                                'text-yellow-300': entry.grade === 'S',
                                                'text-green-400': entry.grade === 'A',
                                                'text-blue-400': entry.grade === 'B',
                                                'text-gray-500': entry.grade === 'C',
                                                'text-red-500': entry.grade === 'F'
                                            }" 
                                            x-text="entry.grade">
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="flex-shrink-0 pt-4 bg-black/40 backdrop-blur-md -mx-4 px-4 pb-4 rounded-t-xl z-20 w-full max-w-lg mx-auto">
                    <template x-if="endingType !== 'F'">
                        <button @click="continueOvertime()" class="glass-button btn-green-glow w-full py-4 text-2xl font-bold rounded-2xl text-green-400 mb-4">CONTINUE (OVERTIME)</button>
                    </template>
                    <button @click="restartGame()" class="glass-button w-full py-3 text-xl font-bold rounded-2xl text-white mb-4">RETURN</button>
                    <button @click="showRanking()" class="glass-button btn-yellow-glow w-full py-3 text-xl font-bold rounded-2xl text-yellow-300">VIEW REKORD</button>
                </div>
            </div>

            <div x-show="isSpinning" x-transition.opacity.duration.300ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center p-4 z-50 bg-black/70 backdrop-blur-sm">
                <h2 class="text-3xl font-bold text-pink-400 text-glow-sm mb-8" x-text="spinResult ? 'SPIN COMPLETE!' : (selectedInventoryCardForSpin ? `SPIN TARGET: ${selectedInventoryCardForSpin.sNumber}` : 'SPINNING...')"></h2>
                
                <template x-if="isSpinGridReady">
                    <div class="grid grid-cols-4 gap-3 p-4 glass-panel rounded-3xl">
                        <template x-for="card in spinGrid" :key="card.inventoryId">
                            <div class="w-16 h-20 perspective">
                                <div class="card-flip cursor-pointer" :class="{'is-flipped': spinResult}" @click="!spinResult ? selectSpinCard(card) : null">
                                    <div class="card-face card-back rounded-lg border-2 border-gray-400">
                                        <div class="w-full h-full bg-gradient-to-bl from-[#0a0e17] via-[#0c1445] to-[#0a0e17] flex items-center justify-center">
                                            <span class="text-gray-300 text-3xl font-black opacity-50">//</span>
                                        </div>
                                    </div>
                                    <div class="card-face card-front" :class="{'ring-2 ring-offset-2 ring-offset-black ring-purple-500 rounded-lg': spinResult && spinResult.inventoryId === card.inventoryId}">
                                        <template x-if="card">
                                            <div x-data="objektCard(card)">
                                                <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" :class="borderStyles" :style="cardStyles.background">
                                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-1"><span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span><span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span></div>
                                                    <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'"><span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span></div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>

            <div x-show="isCrafting" x-transition.opacity.duration.300ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center p-4 z-50 bg-black/70 backdrop-blur-sm">
                <h2 class="text-3xl font-bold text-teal-400 text-glow-sm mb-8" x-text="craftingCard ? `GRID: ${craftingCard?.sNumber}` : 'GRIDDING...'"></h2>
                <div class="craft-grid-container p-8 glass-panel rounded-full">
                    <template x-if="craftingCard">
                        <template x-for="i in 4" :key="i">
                            <div class="craft-card" :class="`craft-card-${i}`" x-data="objektCard(craftingCard)">
                                <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" :class="borderStyles" :style="cardStyles.background">
                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-1"><span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span><span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span></div>
                                    <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md"><span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span></div>
                                </div>
                            </div>
                        </template>
                    </template>
                    <template x-if="craftingCard">
                        <div class="craft-special-card">
                            <div x-data="objektCard({ ...craftingCard, isSpecial: true })">
                                <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" :class="borderStyles" :style="cardStyles.background">
                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-1"><span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span><span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span></div>
                                    <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'"><span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <div x-show="feedback.show" 
                 x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" 
                 x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-4" 
                 class="absolute top-8 left-1/2 -translate-x-1/2 w-auto px-6 py-3 rounded-full shadow-2xl text-lg font-black z-[70] whitespace-nowrap backdrop-blur-md border-2" 
                 :class="{'bg-green-500/80 text-white border-green-400': feedback.type === 'correct', 'bg-red-500/80 text-white border-red-400': feedback.type === 'incorrect'}">
                <span x-text="feedback.message"></span>
            </div>

            <div x-show="shopModal.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[60] p-6" @click="closeShopModal()">
                <div class="glass-panel p-6 rounded-3xl text-center border border-white/10 shadow-2xl max-w-sm w-full" @click.stop>
                    <h3 class="text-2xl font-bold text-white mb-4" x-text="shopModal.title"></h3>
                    <p class="text-lg text-gray-300 mb-2 whitespace-pre-line" x-text="shopModal.desc"></p>
                    <template x-if="shopModal.item === 'reload'"><p class="text-base font-bold text-cyan-300 mb-4" x-text="`CURRENT CHARGE: +${reloadBoost}`"></p></template>
                    <div class="flex justify-center items-center mb-8" x-show="!shopModal.isMax">
                        <span class="text-gray-400 mr-2 text-2xl font-bold">COST:</span>
                        <span class="text-2xl font-bold" :class="como >= shopModal.cost ? 'text-purple-300' : 'text-red-400'" x-text="`${shopModal.cost} COMO`"></span>
                    </div>
                    <div class="flex justify-center items-center mb-8" x-show="shopModal.isMax">
                        <span class="text-2xl font-bold text-yellow-500">MAX LEVEL REACHED</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="closeShopModal()" class="glass-button py-3 text-white font-bold rounded-xl">BACK</button>
                        <button @click="confirmBuyItem()" :disabled="como < shopModal.cost || shopModal.isMax" class="glass-button py-3 font-bold rounded-xl" :class="!shopModal.isMax && como >= shopModal.cost ? 'text-green-400 border-green-500/50' : 'opacity-50 cursor-not-allowed'">BUY</button>
                    </div>
                </div>
            </div>

            <div x-show="gameState === 'gacha'" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/80 backdrop-blur-md z-[60]">
                <div class="relative flex flex-col items-center">
                    <h2 class="text-3xl font-bold mb-8" x-show="gachaState === 'ready'">
                        <span class="holo-text">OBJEKT</span><span class="text-white"> PACK</span>
                    </h2>
                    <div class="booster-pack-container flex flex-col items-center">
                        <template x-if="gachaState === 'ready' || gachaState === 'opening'">
                             <button @click="startGachaAnimation()" :disabled="gachaState !== 'ready'" class="booster-pack cursor-pointer" :class="gachaState === 'opening' ? 'pack-shaking' : ''">
                                <span class="text-purple-300 font-black" x-text="ITEM_INFO.objekt.icon"></span>
                            </button>
                        </template>
                        <div x-show="gachaState === 'joker_flash'" class="absolute inset-0 z-10 w-full h-full flash-overlay-purple rounded-3xl"></div>
                        <div x-show="gachaState === 'opening'" class="absolute inset-0 z-10 w-full h-full flash-overlay rounded-3xl"></div>

                        <template x-if="gachaState === 'ready'">
                            <p class="text-gray-400 mt-4 text-xl font-bold" :class="como < 1 ? 'text-red-400' : 'text-purple-300'" x-text="`1 COMO`"></p>
                        </template>
                        
                        <template x-if="gachaState === 'result'">
                            <div class="card-reveal transform scale-150 origin-bottom-center">
                                <div x-data="objektCard(gachaResultCard)">
                                    <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" 
                                        :class="borderStyles" 
                                        :style="cardStyles.background">
                                        <div class="flex-grow h-full flex flex-col items-center justify-center p-1">
                                            <span class="text-lg font-extrabold" :style="cardStyles.text" x-text="gachaResultCard.sNumber"></span>
                                            <span class="text-xs font-bold" :style="cardStyles.text" x-text="gachaResultCard.kor"></span>
                                        </div>
                                        <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="gachaResultCard.isSpecial || gachaResultCard.type === 'joker_card' ? 'holo-bg' : 'bg-black/30'">
                                            <span class="text-xs font-bold text-white writing-mode-v-rl" x-text="gachaResultCard.eng"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <template x-if="gachaState === 'result'">
                        <div class="flex flex-col items-center mt-12">
                            <h3 class="text-3xl font-black mb-2 text-glow-sm" 
                                :class="gachaResultCard.type === 'joker_card' ? 'text-purple-400' : 'text-cyan-400'"
                                x-text="gachaResultCard.type === 'joker_card' ? 'SUPER RARE!' : 'NEW OBJEKT!'">
                            </h3>
                            <p class="text-xl font-bold mb-8 text-glow-sm"
                               :style="gachaResultCard.type === 'joker_card' ? 'color: #D8B4FE' : `color: ${gachaResultCard.color}`"
                               x-text="`${gachaResultCard.sNumber} / ${gachaResultCard.kor}`">
                            </p>
                            <button @click="confirmGachaResult()" class="glass-button btn-green-glow py-4 px-12 text-2xl font-bold rounded-2xl text-green-400">OK</button>
                        </div>
                    </template>
                    
                    <template x-if="gachaState === 'ready'">
                        <div class="mt-8 w-64">
                            <button @click="closeGachaModal()" class="glass-button w-full py-3 text-lg font-bold rounded-xl text-white">BACK</button>
                        </div>
                    </template>

                </div>
            </div>

        </div>
    </div>
</body>
</html>
