<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- v10.139: 핵심 UI 텍스트(SCORE, RELOAD, NEXT 등) 영문 하드코딩으로 안정화 -->
    <title>OBJEKT Rush (v10.139)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js" defer></script>
    <style>
        /* --- 기본 레이아웃 & 스크롤바 --- */
        /* v10.130: x-cloak 사용을 위한 CSS 추가 */
        [x-cloak] { display: none !important; }
        
        body, #game-container { height: 100vh; height: -webkit-fill-available; background-color: #000; }
        .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #4a5568 #1a202c; }
        .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1a202c00; border-radius: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #4a556880; border-radius: 4px; }

        /* --- 유틸리티 --- */
        .writing-mode-v-rl { writing-mode: vertical-rl; text-orientation: mixed; }
        .perspective { perspective: 1000px; }
        
        /* --- 애니메이션 --- */
        .countdown-zoom { animation: zoom-in-out 0.5s ease-in-out infinite; }
        @keyframes zoom-in-out { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7); } }
        
        /* v10.108 Fix: 보스 이펙트 정의 */
        .boss-border { border-color: #f56565; box-shadow: 0 0 15px 5px rgba(245, 101, 101, 0.5); animation: pulse-red 2s infinite; position: relative; overflow: hidden; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 15px 5px rgba(245, 101, 101, 0.4); } 50% { box-shadow: 0 0 20px 8px rgba(245, 101, 101, 0.7); } }
        .boss-border::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.3) 50%, rgba(255, 255, 255, 0) 100%); transform: rotate(30deg); animation: shine 3s infinite linear; }
        @keyframes shine { 0% { transform: rotate(30deg) translateX(-150%); } 100% { transform: rotate(30deg) translateX(150%); } }
        
        .unlock-bounce { animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounce-in { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* --- 카드 플립 --- */
        .card-flip { transform-style: preserve-3d; transition: transform 0.6s; position: relative; width: 100%; height: 100%; }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 0.5rem; overflow: hidden; }
        .card-back { background: linear-gradient(225deg, #0a0e17 0%, #0c1445 50%, #0a0e17 100%); display: flex; align-items: center; justify-content: center; transform: rotateY(0deg); border: 2px solid #9ca3af; cursor: pointer; }
        .card-front { transform: rotateY(180deg); }
        .card-flip.is-flipped { transform: rotateY(180deg); }

        /* --- Premium Hologram 테마 스타일 --- */
        .premium-bg {
            background-color: #0f0f13;
            background-image: 
                radial-gradient(at 50% 0%, rgba(88, 28, 135, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(219, 39, 119, 0.2) 0px, transparent 50%),
                linear-gradient(to bottom, #0f0f13, #000);
            background-attachment: fixed;
        }
        .title-bg-effect {
             background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 5px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 4px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            animation: bg-drift 60s linear infinite;
        }
        @keyframes bg-drift { from { background-position: 0 0, 40px 60px, 130px 270px; } to { background-position: 550px 550px, 390px 410px, 680px 820px; } }

        .glass-panel {
            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .glass-button {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.2s ease-out;
        }
        .glass-button:hover:not(:disabled) {
            background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.1));
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1); transform: translateY(-1px);
            /* v10.120: hover 시 텍스트 색상 white로 변경 */
            color: white !important;
        }
        .glass-button:active:not(:disabled) { transform: scale(0.98) translateY(0px); }
        .glass-button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* v10.129 FIX: 홀로그램 복구 (단순 구조) */
        .holo-bg {
            /* 복잡한 mix-blend-mode 제거 */
            background: rgba(255, 255, 255, 0.05); /* 투명한 배경색 */
            position: relative;
            overflow: hidden;
            border-right: 1px solid #ffffff33;
            /* 무지갯빛 그라데이션을 배경으로 직접 적용 */
            background-image: linear-gradient(135deg, rgba(255, 0, 255, 1.0), rgba(0, 255, 255, 1.0), rgba(255, 255, 0, 1.0));
            background-size: 100% 200%;
            /* v10.136 FIX: 애니메이션 속도 5s로 조정, 키프레임 0%->200%로 변경하여 흐르는 효과 명확화 */
            animation: holo-color 5s linear infinite; 
        }
        /* v10.129 FIX: 복잡했던 before/after 애니메이션 제거 */
        .holo-bg::before, .holo-bg::after { content: none; }
        
        @keyframes holo-color {
            0% { background-position: 50% 100%; } /* 수직 시작 위치 */
            100% { background-position: 50% 0%; }  /* 수직 끝 위치 */
        }

        .btn-green-glow { box-shadow: 0 0 10px rgba(34, 197, 94, 0.3); border-color: rgba(34, 197, 94, 0.5); }
        .btn-red-glow { box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); border-color: rgba(239, 68, 68, 0.5); }
        .btn-yellow-glow { box-shadow: 0 0 10px rgba(234, 179, 8, 0.3); border-color: rgba(234, 179, 8, 0.5); }
        .btn-blue-glow { box-shadow: 0 0 10px rgba(96, 165, 250, 0.3); border-color: rgba(96, 165, 250, 0.5); }
        .btn-gold-glow { box-shadow: 0 0 15px rgba(234, 179, 8, 0.5); border-color: rgba(253, 224, 71, 0.7); }

        /* REKORD ARCHIVE HOLO REMOVED: WHITE TEXT */
        .rekord-archive-text {
            color: white; 
            background: none;
            -webkit-text-fill-color: initial;
            animation: none;
        }
        
        .holo-text {
            background: linear-gradient(90deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            background-size: 200% auto; color: #000; background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: holo-text-shine 5s linear infinite;
        }
        @keyframes holo-text-shine { to { background-position: 200% center; } }

        .text-glow { text-shadow: 0 0 8px currentColor; }
        .text-glow-sm { text-shadow: 0 0 4px currentColor; }

        .floating-objekt {
            position: absolute; width: 60px; height: 80px; border-radius: 6px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            backdrop-filter: blur(2px); 
            border: 1px solid rgba(255,255,255,0.3);
            animation: float-rotate 20s infinite linear; 
            opacity: 0.5; 
        }
        @keyframes float-rotate {
            0% { transform: translateY(0) rotate(0deg) scale(1); }
            50% { transform: translateY(-20px) rotate(180deg) scale(1.1); }
            100% { transform: translateY(0) rotate(360deg) scale(1); }
        }
        
        .craft-grid-container { position: relative; width: 24rem; height: 24rem; display: flex; justify-content: center; align-items: center; }
        .craft-card { position: absolute; width: 4rem; height: 5rem; animation-duration: 1.0s; animation-fill-mode: forwards; animation-timing-function: ease-in-out; }
        .craft-card-1 { top: 50%; left: 50%; margin-top: -8.5rem; margin-left: -2rem; animation-name: merge-down; }   
        .craft-card-2 { top: 50%; left: 50%; margin-top: -2.5rem; margin-left: -8rem; animation-name: merge-right; }  
        .craft-card-3 { top: 50%; left: 50%; margin-top: -2.5rem; margin-left: 4rem;  animation-name: merge-left; }   
        .craft-card-4 { top: 50%; left: 50%; margin-top: 3.5rem;  margin-left: -2rem; animation-name: merge-up; }     
        .craft-special-card { position: absolute; top: 50%; left: 50%; width: 4rem; height: 5rem; margin-top: -2.5rem; margin-left: -2rem; z-index: 10; opacity: 0; transform: scale(0.9); animation: appear-center-light 1.5s 1.0s forwards ease-out; }
        @keyframes merge-down { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(6rem) scale(0.5); } }
        @keyframes merge-right{ 0% { opacity: 1; transform: translateX(0) scale(1); } 100% { opacity: 0; transform: translateX(6rem) scale(0.5); } }
        @keyframes merge-left { 0% { opacity: 1; transform: translateX(0) scale(1); } 100% { opacity: 0; transform: translateX(-6rem) scale(0.5); } }
        @keyframes merge-up   { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-6rem) scale(0.5); } }
        @keyframes appear-center-light { 0% { opacity: 0; transform: scale(0.9); filter: brightness(10) blur(5px); } 100% { opacity: 1; transform: scale(1); filter: brightness(1) blur(0px); } }

        /* --- Gacha Animation Styles --- */
        .booster-pack-container { perspective: 1000px; }
        .booster-pack {
            width: 140px; height: 190px; background: linear-gradient(135deg, #4f46e5, #9333ea, #db2777);
            border-radius: 12px; box-shadow: 0 0 30px rgba(168, 85, 247, 0.6);
            display: flex; align-items: center; justify-content: center; font-size: 5rem;
            position: relative; overflow: hidden; animation: pack-hover 3s ease-in-out infinite;
        }
        .booster-pack::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: rotate(30deg); animation: holo-shine 4s infinite linear;
        }
        .pack-shaking { animation: pack-shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes pack-hover { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-10px) rotate(2deg); } }
        @keyframes pack-shake { 10%, 90% { transform: translate3d(-2px, 0, 0) rotate(-2deg); } 20%, 80% { transform: translate3d(3px, 0, 0) rotate(3deg); } 30%, 50%, 70% { transform: translate3d(-5px, 0, 0) rotate(-5deg); } 40%, 60% { transform: translate3d(5px, 0, 0) rotate(5deg); } }
        .flash-overlay { animation: flash-bang 0.8s ease-out forwards; }
        @keyframes flash-bang { 0% { opacity: 0; } 50% { opacity: 0.6; background: white; } 100% { opacity: 0; } }
        .flash-overlay-purple { animation: flash-bang-purple 1.2s ease-out forwards; }
        @keyframes flash-bang-purple { 0% { opacity: 0; } 30% { opacity: 0.8; background: #d8b4fe; } 100% { opacity: 0; } }
        .card-reveal { animation: card-appear-scale 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes card-appear-scale { 0% { opacity: 0; transform: scale(0.1) rotate(-10deg); } 100% { transform: scale(1.5) rotate(0deg); } }

        /* --- Mission Briefing Styles --- */
        .briefing-panel {
            background: linear-gradient(180deg, rgba(20, 20, 30, 0.9) 0%, rgba(10, 10, 15, 0.95) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8), 0 0 30px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        .briefing-panel::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, transparent, #ef4444, transparent);
            animation: scan-line 3s ease-in-out infinite; opacity: 0.7;
        }
        .briefing-panel::after {
            content: 'TOP SECRET // CLASSIFIED'; position: absolute; top: 1rem; right: 1.5rem;
            font-size: 0.7rem; font-weight: 900; color: #ef4444; letter-spacing: 0.2em; opacity: 0.6;
            border: 2px solid #ef4444; padding: 0.2rem 0.5rem; transform: rotate(-5deg);
            z-index: 50; pointer-events: none;
        }
        @keyframes scan-line { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        
        /* v10.111: ORDER AREA SCANLINE EFFECT */
        #order-area { position: relative; overflow: hidden; }
        #order-area::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            /* 1px 검은색 선, 1px 투명 공간으로 스캔라인 생성 */
            background: repeating-linear-gradient(
                to bottom,
                rgba(0, 0, 0, 0.2),
                rgba(0, 0, 0, 0.3) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none; /* 클릭을 막지 않음 */
            z-index: 10;
            opacity: 0.8;
            animation: monitor-flicker 0.1s infinite step-end;
        }
        @keyframes monitor-flicker {
            0% { opacity: 0.8; }
            50% { opacity: 0.75; }
            100% { opacity: 0.8; }
        }

        /* v10.112: 엔딩 화면 효과 */
        .ending-screen-overlay::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            /* Subtle scanline effect for the final report screen */
            background: repeating-linear-gradient(
                to bottom,
                rgba(0, 0, 0, 0.4),
                rgba(0, 0, 0, 0.4) 1px,
                transparent 1px,
                transparent 3px
            );
            z-index: 50;
            opacity: 0.1;
            pointer-events: none;
        }
        .ending-rank-glow {
            animation: rank-pulse 2s infinite alternate;
        }
        @keyframes rank-pulse {
            0% { filter: drop-shadow(0 0 5px currentColor); }
            100% { filter: drop-shadow(0 0 15px currentColor); }
        }

    </style>
    <script>
        // v10.138: 다국어 텍스트 정의
        // v10.139: 핵심 UI는 제거하고 문장형/동적 텍스트만 유지
        const GAME_TEXTS = {
            ko: {
                lang_select: "언어 선택", lang_desc: "게임 내 텍스트 표시 언어를 설정합니다.",
                
                // Intro Script
                intro_line_0: "MH에 온 걸 환영하네, 신입.\n자네 임무는 다음과 같다.",
                intro_line_1_a: "작업 지시(Order)에 맞는 올바른 Objekt를 제작하여 고객(Client)에게 전달할 것.",
                intro_line_1_b: "하단의 데이터(Data)를 정확히 짝지어 슬롯(Slot)에 입력(Input)할 것.",
                intro_line_1_c: "모든 주문 블록(Order Block) 처리에는 마감 기한이 있다는 걸 명심하게.",
                intro_line_1_d: "본격적인 투입 전, 다음 장의 기밀 데이터를 완벽히 숙지하도록.",
                intro_line_prompt: "...실수는 용납하지 않네. 할 수 있겠나?",

                // Item Descriptions
                item_reload_desc: '다음 스테이지의 RELOAD 횟수를 1회 추가합니다.\n(최대 +20회)',
                item_timePlus_desc: '블록의 제한 시간을 2초 늘려줍니다.\n(최대 1레벨)',
                item_scan_desc: '생일 블록에 멤버 색상 힌트를 표시합니다.\n(최대 1레벨)',
                item_amulet_desc: '불량/친구 카드 입력 시 20% 확률로 ARTMS 카드로 변경됩니다.\n(최대 1레벨)',
                item_assist_desc: 'Data 풀에 친구 카드가 20% 확률로 등장합니다.\n(최대 1레벨)',
                
                // Boss Comments
                boss_S_0: "자네, 꽤 하는군. 이 정도는 해야 내 파트너가 될 수 있지.", boss_S_1: "완벽한 작업이었네. S는 아무나 받는게 아니야.", boss_S_2: "흠... 이 정도면 만족스럽군. 다음에도 부탁하지.",
                boss_A_0: "A... 나쁘지 않아. 하지만 S를 노리도록.", boss_A_1: "훌륭하군. 하지만 방심은 금물이야.", boss_A_2: "잘했네. 이 감각을 잊지 말게.",
                boss_B_0: "B... 평균은 했군. 분발하게.", boss_B_1: "아직 부족한 점이 보이는군. 더 노력하게.", boss_B_2: "이봐, 신입. 다음엔 오늘보다 나은 모습을 보여주게.",
                boss_C_0: "C? ...내일 면담일세.", boss_C_1: "...이게 자네 최선인가?", boss_C_2: "신입. 내일은 오늘보다 나은 모습을 보여주게.",
                boss_F_0: "계약 만료. 실적 미달로 인한 보안 접근 권한 회수. 즉시 관리 본부 복귀를 명령합니다.", boss_F_1: "경고: 임무 실패. 다음 스테이지 진행은 시스템에 의해 보류 처리되었습니다.", boss_F_2: "미흡한 실적으로 계약이 종료되었습니다. 추가 임무 배정은 없습니다.",

                // Ending Messages
                ending_S_title: "PERFECT AGENT", ending_S_desc: "모든 것을 완벽하게 해냈습니다!\n당신은 MH의 S급 요원입니다.",
                ending_A_title: "ELITE AGENT", ending_A_desc: "훌륭한 성과입니다.\n당신은 MH의 엘리트 요원입니다.",
                ending_B_title: "GOOD AGENT", ending_B_desc: "무사히 임무를 완수했습니다.\n다음엔 더 좋은 성과를 기대합니다.",
                ending_C_title: "AGENT", ending_C_desc: "임무를 완수했습니다.\n...하지만 보스는 만족하지 않은 것 같군요.",
                ending_F_title: "TERMINATED", ending_F_desc: "최소 요구 실적 미달로 계약이 해지되었습니다.",
                
                // Gravity Panel
                gravity_desc_prefix: 'COMO를 투표하여',
                gravity_desc_stage: 'Stage',
                gravity_desc_suffix: '무대에 오를 Dimension을 결정하세요!',
                
                // Dynamic Feedback / Modals / System
                feedback_collect_full: '인벤토리가 가득 찼습니다!',
                feedback_not_enough_como: 'COMO가 부족합니다!', 
                feedback_amulet_activated: '✨ AMULET 발동! ✨', 
                feedback_joker_acquired: '✨ JOKER(MH) 획득! ✨',
                feedback_card_acquired: ' 카드 획득!', 
                feedback_grid_available: ' GRID 가능!', 
                feedback_grid_complete: '✨ GRID 완료!',
                feedback_need_four_cards: '동일한 일반 카드가 4장 이상 필요합니다!', 
                feedback_spin_failed: 'SPIN 실패... 카드를 잃었습니다!', 
                feedback_reload_penalty: '점수 감소',

                // Confirm Modal
                confirm_return_title: '⚠️ WARNING', confirm_return_msg: '현재 진행 상황이 모두 초기화됩니다.\n타이틀로 돌아가시겠습니까?',
                
                // Playing Screen
                playing_next_block_boss: 'WARNING: Dimension 감지 중...',
                playing_next_block_normal: '다음 블록 수신 중...',

            },
            en: {
                lang_select: "Language Select", 
lang_desc: "Set the display language for in-game text.",
                
                // Intro Script
                intro_line_0: "Welcome to MH, New Agent.\nYour mission is as follows:",
                intro_line_1_a: "Craft the correct Objekt corresponding to the Order and deliver it to the Client.",
                intro_line_1_b: "Match the Data pool items below accurately and Input them into the Slot.",
                intro_line_1_c: "Remember, all Order Blocks have a strict deadline.",
                intro_line_1_d: "Before deployment, you must fully understand the confidential data on the next page.",
                intro_line_prompt: "...I don't tolerate mistakes. Are you up to it?",

                // Item Descriptions
                item_reload_desc: 'Adds 1 RELOAD count for the next stage.\n(Max +20 times)',
                item_timePlus_desc: 'Increases the block time limit by 2 seconds.\n(Max Level 1)',
                item_scan_desc: 'Displays member color hints for Birthday blocks.\n(Max Level 1)',
                item_amulet_desc: '20% chance to change Defect/Friend cards to ARTMS cards upon input.\n(Max Level 1)',
                item_assist_desc: '20% chance for Friend cards to appear in the Data Pool.\n(Max Level 1)',

                // Boss Comments
                boss_S_0: "Quite capable, aren't you. This is the minimum to become my partner.", boss_S_1: "A perfect job. S rank is not for everyone.", boss_S_2: "Hmm... This is satisfactory. I'll ask for you again.",
                boss_A_0: "A... Not bad. But aim for S.", boss_A_1: "Excellent. But don't let your guard down.", boss_A_2: "Well done. Don't forget this feeling.",
                boss_B_0: "B... You did average. Strive for better.", boss_B_1: "I still see room for improvement. Put in more effort.", boss_B_2: "Hey, Rookie. Show me better tomorrow.",
                boss_C_0: "C? ...See me in my office tomorrow.", boss_C_1: "...Is this your best effort?", boss_C_2: "Rookie. Show me better tomorrow than today.",
                boss_F_0: "Contract termination. Security access revoked due to underperformance. Report back to management immediately.", boss_F_1: "Warning: Mission failure. Further stage progress has been put on hold by the system.", boss_F_2: "Contract terminated due to unsatisfactory performance. No further assignments will be issued.",

                // Ending Messages
                ending_S_title: "PERFECT AGENT", ending_S_desc: "Everything was done perfectly!\nYou are an S-Class Agent of MH.",
                ending_A_title: "ELITE AGENT", ending_A_desc: "Excellent performance.\nYou are an Elite Agent of MH.",
                ending_B_title: "GOOD AGENT", ending_B_desc: "Mission completed successfully.\nWe expect better results next time.",
                ending_C_title: "AGENT", ending_C_desc: "Mission completed.\n...But the Boss doesn't seem satisfied.",
                ending_F_title: "TERMINATED", ending_F_desc: "Contract terminated due to failure to meet minimum required performance.",

                // Gravity Panel
                gravity_desc_prefix: 'Vote with COMO to decide',
                gravity_desc_stage: 'Stage',
                gravity_desc_suffix: 'which Dimension will perform!',
                
                // Dynamic Feedback / Modals / System
                feedback_collect_full: 'COLLECT FULL!', 
                feedback_not_enough_como: 'NOT ENOUGH COMO!', 
                feedback_amulet_activated: '✨ AMULET ACTIVATED! ✨', 
                feedback_joker_acquired: '✨ JOKER(MH) ACQUIRED! ✨',
                feedback_card_acquired: ' Card Acquired!', 
                feedback_grid_available: ' GRID AVAILABLE!', 
                feedback_grid_complete: '✨ GRID COMPLETE!',
                feedback_need_four_cards: 'You need 4 or more identical common cards!', 
                feedback_spin_failed: 'SPIN FAILED... Card Lost!', 
                feedback_reload_penalty: 'Score Penalty',

                // Confirm Modal
                confirm_return_title: '⚠️ WARNING', confirm_return_msg: 'All current progress will be reset.\nReturn to Title?',

                // Playing Screen
                playing_next_block_boss: 'WARNING: Dimension Detecting...',
                playing_next_block_normal: 'Receiving Next Block...',
                
            },
        };

        function objektCard(cardData, showEffects = true) {
            return {
                card: cardData,
                showEffects: showEffects,
                get cardStyles() {
                    const card = this.card;
                    if (!card) return {};
                    let backgroundStyle = `background-color: #FFFFFF;`; 
                    if (card.color) backgroundStyle = `background-color: ${card.color};`;
                    let textColor = 'color: #000000;'; 
                    if (card.customTextColor) { // Fix: Custom color should use the provided value
                        textColor = `color: ${card.customTextColor};`; 
                    } else if (card.sNumber === 'MH') {
                        textColor = 'color: #F5F5F5;'; 
                    }
                    return { background: backgroundStyle, text: textColor };
                },
                get borderStyles() {
                    // v10.111 FIX: 스페셜 카드의 전용 테두리 제거, 모든 카드 공용 테두리 사용
                    return 'border-gray-400';
                }
            }
        }

        function game() {
            return {
                // --- STATE ---
                gameState: 'start', // 'start', 'intro', 'playing', 'intermission', 'submitScore', 'ending', 'ranking', 'gacha', 'transition', 'settings'
                previousGameState: 'start',
                introStep: 1,
                introTab: 'members',
                rankingTab: 'main',
                
                // Core Game
                stage: 1,
                score: 0,
                totalScore: 0,
                lastStageScore: 0,
                finalScore: 0,
                como: 0, // v10.126: COMO 초기값 0으로 설정
                comoEarned: 0,
                bonusComo: 0,
                
                // Blocks & Timer
                currentBlock: null,
                blocksCompleted: 0,
                totalBlocksPerStage: 0,
                orderTimer: null,
                startTimer: null,
                isStarting: false,
                startCountdown: '',
                nextBlockWillBeBoss: false,
                
                // Scoring & Chain
                chainCount: 0,
                consecutivePerfects: 0,
                lastStageGrade: 'C',
                bossJComment: '',
                endingType: 'C',

                // Data & Slots
                korData: [],
                engData: [],
                completedCards: [],
                selectedData: null,
                matchedOrderIndices: [],
                
                // Inventory
                inventory: [],
                inventoryMaxSize: 12, // v10.111: 24 -> 12로 수정
                selectedInventoryCard: null,
                
                // Items & Shop
                amuletLevel: 0,
                assistLevel: 0,
                timePlusLevel: 0,
                scanLevel: 0,
                reloadCount: 10, // 기본 10회
                reloadBoost: 0, // 구매로 추가된 횟수
                currentReloadPenalty: 5,
                
                // Modals
                shopModal: { show: false, item: '', title: '', desc: '', cost: 0, isMax: false },
                unlockModal: { show: false, title: '', message: '' },
                returnConfirmModal: { show: false },
                resetConfirmModal: { show: false, type: 'all' }, // New reset modal
                feedback: { show: false, message: '', type: 'correct', timer: null },
                
                // Gacha
                gachaState: 'ready', // 'ready', 'opening', 'joker_flash', 'result'
                gachaResultCard: null,

                // Spin & Grid
                isSpinning: false,
                spinGrid: [],
                spinResult: null,
                selectedInventoryCardForSpin: null,
                intermissionSpinCount: 0,
                isCrafting: false,
                craftingCard: null,
                
                // Ranking
                highScores: [],
                extraHighScores: [],
                playerName: 'AAA',
                
                // Gravity Vote
                gravityVotes: {},
                
                // Audio
                sounds: {}, 
                bgm: {}, // BGM 객체 추가
                currentBGM: null, // 현재 재생 중인 BGM 상태 관리
                bgmVolume: 0.3, // BGM 볼륨 (0.0 - 1.0)
                sfxVolume: 0.5, // 효과음 볼륨 (0.0 - 1.0)

                // v10.111-S: 시즌 랭킹 시스템 밑작업
                currentSeason: { name: 'Atom01', color: '#FFDD00' }, // 현재 시즌 (테스트 초기값)
                currentSeasonIndex: 0, // 시즌 인덱스 (0: Atom01, 1: Binary01, ...)

                // v10.138: 다국어 지원 설정 추가
                currentLang: 'ko', // 현재 언어 코드
                supportedLangs: [ // 지원 언어 목록
                    { code: 'ko', name: '한국어' }, 
                    { code: 'en', name: 'English' }
                ],
                // v10.138: 번역 데이터 저장소
                translations: {}, 
                
                // --- CONSTANTS ---
                // v10.111-S: 시즌 설정 추가
                SEASON_CONFIG: [
                    { name: 'Atom01', color: '#FFDD00' },
                    { name: 'Binary01', color: '#00FF00' },
                    { name: 'Cream01', color: '#FF7477' },
                    { name: 'Divine01', color: '#B400FF' },
                    { name: 'Ever01', color: '#33ECFD' }
                ],
                SCORING: { CORRECT_CARD: 10, PERFECT_BASE: 100, BOSS_FIXED_BONUS: 500, FAIL_PENALTY: 50, FRIEND_PENALTY: 20 },
                // v10.138: ITEM_INFO 키로 대체
                ITEM_INFO: {
                    objekt: { title: 'OBJEKT PACK', desc: '', cost: 1 },
                    reload: { title: 'RELOAD CHARGE', desc: 'item_reload_desc', cost: 1 },
                    timePlus: { title: 'TIME+ (Lv.1)', desc: 'item_timePlus_desc', cost: 4 },
                    scan: { title: 'SCAN (Lv.1)', desc: 'item_scan_desc', cost: 3 },
                    amulet: { title: 'AMULET (Lv.1)', desc: 'item_amulet_desc', cost: 2 },
                    assist: { title: 'ASSIST (Lv.1)', desc: 'item_assist_desc', cost: 4 }
                },
                // v10.138: BOSS_COMMENTS 키로 대체
                BOSS_COMMENTS: {
                    S: ["boss_S_0", "boss_S_1", "boss_S_2"],
                    A: ["boss_A_0", "boss_A_1", "boss_A_2"],
                    B: ["boss_B_0", "boss_B_1", "boss_B_2"],
                    C: ["boss_C_0", "boss_C_1", "boss_C_2"],
                    F: ["boss_F_0", "boss_F_1", "boss_F_2"]
                },
                // v10.138: ENDING_MESSAGES 키로 대체
                ENDING_MESSAGES: { 
                    S: { title: "ending_S_title", desc: "ending_S_desc", theme: "text-yellow-300" },
                    A: { title: "ending_A_title", desc: "ending_A_desc", theme: "text-green-400" },
                    B: { title: "ending_B_title", desc: "ending_B_desc", theme: "text-blue-400" },
                    C: { title: "ending_C_title", desc: "ending_C_desc", theme: "text-gray-400" },
                    F: { title: "ending_F_title", desc: "ending_F_desc", theme: "text-red-400" } 
                },
                
                stageConfig: [
                    { blocks: 7, decoy: 0, birthdayChance: 0, bosses: [] }, // Stage 1
                    { blocks: 7, decoy: 0.1, birthdayChance: 0, bosses: [] }, // Stage 2
                    { blocks: 7, decoy: 0.1, birthdayChance: 0.1, bosses: [] }, // Stage 3
                    { blocks: 8, decoy: 0.1, birthdayChance: 0.1, bosses: [] }, // Stage 4
                    { blocks: 8, decoy: 0.2, birthdayChance: 0.1, bosses: ['NXT_GLOW'] }, // Stage 5
                    { blocks: 8, decoy: 0.2, birthdayChance: 0.1, bosses: ['AAA_KRE'] }, // Stage 6
                    { blocks: 9, decoy: 0.2, birthdayChance: 0.2, bosses: ['PLANET_DIMS'] }, // Stage 7
                    { blocks: 9, decoy: 0.2, birthdayChance: 0.2, bosses: ['LOVE_EVOL'] }, // Stage 8
                    { blocks: 9, decoy: 0.3, birthdayChance: 0.2, bosses: ['HATCH_ALPHIE'] }, // Stage 9
                    { blocks: 10, decoy: 0.3, birthdayChance: 0.2, bosses: ['ARIA_VV'] }, // Stage 10
                    { blocks: 24, decoy: 0.3, birthdayChance: 0.3, bosses: ['PLANET_DIMS'] } // Stage 11 (Overtime)
                ],
                bossPools: {
                    'NXT_GLOW': ['NXT', 'Glow'],
                    'AAA_KRE': ['AAA', 'KRE'],
                    'LOVE_EVOL': ['LOVE', 'EVOL'],
                    'ARIA_VV': ['Aria', 'VV'],
                    'HATCH_ALPHIE': ['Hatch!', 'Alphie'],
                    'PLANET_DIMS': ['Moon', 'Sun', 'Neptune', 'Zenith']
                },

                // --- Data (defined in loadMemberData) ---
                memberData: [],
                dimensionData: [],
                modhausData: [],
                artmsData: [],
                friendData: [],

                // --- METHODS ---
                init() { 
                    this.loadSettings(); // 설정 불러오기
                    this.loadLanguage(); // v10.138: 언어 설정 불러오기 및 번역 데이터 로드
                    this.loadMemberData(); 
                    this.loadHighScores(); 
                    this.loadExtraHighScores(); 
                    this.setDynamicHeight(); 
                    window.addEventListener('resize', this.setDynamicHeight.bind(this)); 
                    this.initSounds(); 
                    this.$watch('gameState', (newState) => { 
                        // v10.111: BGM 스위칭 로직 추가
                        this.switchBGM(newState);
                        
                        if (newState === 'intermission') { this.initializeGravityVotes(); } 
                    }); 
                    // 초기 BGM 재생 (start 화면)
                    this.switchBGM('start');
                    
                    // v10.111-S: 시즌 정보 로드
                    this.loadSeasonConfig();
                },

                // v10.138: 언어 설정 로드
                loadLanguage() {
                    const savedLang = localStorage.getItem('objektRushLanguage');
                    const defaultLang = this.supportedLangs.find(l => l.code === 'ko');
                    if (savedLang && this.supportedLangs.some(l => l.code === savedLang)) {
                        this.currentLang = savedLang;
                    } else if (defaultLang) {
                        this.currentLang = defaultLang.code;
                    } else {
                        this.currentLang = 'en'; // 최종 fallback
                    }
                    this.loadTranslationData(this.currentLang);
                },

                // v10.138: 번역 데이터 로드 (내부 상수 사용)
                // v10.157: 외부 JSON 파일 로드 로직 (경로 수정: locales -> assets/locales)
                async loadTranslationData(langCode) {
                    const fallbackEn = {
                        // 최소한의 필수 영어 키를 하드코딩
                        lang_select: "Language Select", 
                        lang_desc: "Set the display language for in-game text.",
                        intro_line_0: "Welcome to MH, New Agent.\nYour mission is as follows:",
                        confirm_return_title: "⚠️ WARNING", 
                        confirm_return_msg: "All current progress will be reset.\nReturn to Title?",
                        // 나머지 모든 키에 대한 최종 안전장치 (오류 메시지 대신 영어 키 사용)
                    };
                    
                    try {
                        // 1. 외부 JSON 파일 로드 시도 (경로 수정)
                        const response = await fetch(`assets/locales/${langCode}.json`);
                        if (!response.ok) throw new Error('File not found');
                        
                        // 2. 성공 시 로드된 데이터를 사용
                        const externalTranslations = await response.json();
                        this.translations = externalTranslations;
                        
                    } catch (error) {
                        // 3. 실패 시, 최종 안전장치인 하드코딩된 영어 데이터를 사용
                        console.error(`Failed to load translation for ${langCode}. Using English fallback.`, error);
                        this.translations = fallbackEn; 
                    }
                },

                // v10.138: 텍스트 번역 함수
                translate(key) {
                    return this.translations[key] || `[${key}]`; // 키가 없으면 키 자체를 반환하여 누락을 표시
                },

                // v10.138: 언어 설정 저장 및 적용
                setLanguage(langCode) {
                    this.playSound('click');
                    this.currentLang = langCode;
                    this.loadTranslationData(langCode); // 새 언어 데이터 로드
                    localStorage.setItem('objektRushLanguage', langCode);
                },
                
                // v10.111-S: 시즌 정보 로드 및 적용
                loadSeasonConfig() {
                    const savedSeasonIndex = localStorage.getItem('objektRushCurrentSeasonIndex');
                    this.currentSeasonIndex = savedSeasonIndex ? parseInt(savedSeasonIndex) : 0;
                    this.applyCurrentSeason();
                },

                // v10.111-S: 현재 시즌 적용
                applyCurrentSeason() {
                    this.currentSeasonIndex = this.currentSeasonIndex % this.SEASON_CONFIG.length;
                    this.currentSeason = this.SEASON_CONFIG[this.currentSeasonIndex];
                    localStorage.setItem('objektRushCurrentSeasonIndex', this.currentSeasonIndex);
                },

                // v10.111-S: 다음 시즌으로 변경 (Settings용)
                nextSeason() {
                    this.currentSeasonIndex = (this.currentSeasonIndex + 1) % this.SEASON_CONFIG.length;
                    this.applyCurrentSeason();
                    // 이 기능은 UI에서 제거되었으므로 피드백도 제거
                },

                // v10.111: 설정 불러오기
                loadSettings() {
                    const savedBGMVolume = localStorage.getItem('objektRushBGMVolume');
                    const savedSFXVolume = localStorage.getItem('objektRushSFXVolume');

                    if (savedBGMVolume !== null) this.bgmVolume = parseFloat(savedBGMVolume);
                    if (savedSFXVolume !== null) this.sfxVolume = parseFloat(savedSFXVolume);
                },

                // v10.111: 설정 저장
                saveSettings() {
                    localStorage.setItem('objektRushBGMVolume', this.bgmVolume.toFixed(2));
                    localStorage.setItem('objektRushSFXVolume', this.sfxVolume.toFixed(2));
                },

                // v10.111: BGM 파일 맵 정의
                BGM_MAP: {
                    'start': 'bgm_title.mp3',
                    'intro': 'bgm_title.mp3', // 타이틀 음악 공유
                    'ranking': 'bgm_title.mp3', // 랭킹 음악 공유
                    'settings': 'bgm_title.mp3', // 설정 화면에서도 타이틀 음악 공유
                    'intermission': 'bgm_intermission.mp3',
                    'playing': 'bgm_playing.mp3',
                    'gacha': 'bgm_intermission.mp3', // 상점/가챠는 인터미션 음악 공유
                    'submitScore': 'bgm_intermission.mp3',
                    'ending': 'bgm_ending.mp3'
                },
                
                switchBGM(newState) {
                    if (this.currentBGM) {
                        this.currentBGM.pause();
                    }
                    
                    const bgmName = this.BGM_MAP[newState];

                    // v10.155: F 등급 인터미션에서 BGM 재생을 방지합니다.
                    if (newState === 'intermission' && this.lastStageGrade === 'F') {
                        this.currentBGM = null;
                        return;
                    }
                    
                    if (bgmName) {
                        let audio = this.bgm[bgmName];
                        
                        // BGM이 로드되지 않았으면 로드 (경로 수정)
                        if (!audio) {
                            audio = new Audio(`assets/audio/${bgmName}`); // 경로 수정: assets/audio 폴더로 변경
                            audio.loop = true;
                            this.bgm[bgmName] = audio;
                        }
                        
                        this.currentBGM = audio;
                        
                        // 볼륨 설정 적용
                        audio.volume = this.bgmVolume;
                        
                        // BGM 재생 (에러 방지)
                        audio.play().catch(() => {});
                    } else {
                        this.currentBGM = null;
                    }
                },
                
                // v10.111: BGM 볼륨 업데이트
                updateBGMVolume(event) {
                    this.bgmVolume = parseFloat(event.target.value);
                    if (this.currentBGM) {
                        this.currentBGM.volume = this.bgmVolume;
                    }
                    this.saveSettings();
                },

                // v10.111: SFX 볼륨 업데이트
                updateSFXVolume(event) {
                    this.sfxVolume = parseFloat(event.target.value);
                    this.saveSettings();
                    // 테스트 사운드 재생 (선택 사운드를 예시로)
                    this.playSound('click'); 
                },

                initSounds() {
                    // v10.152: 'stage_clear' 사운드 추가 및 파일명 통일
                    const singleSoundList = ['click', 'select', 'input', 'refresh', 'perfect', 'clear', 'fail', 'chain', 'warn', 'buy', 'gacha', 'data_select', 'stage_clear'];
                    
                    singleSoundList.forEach(s => {
                        // v10.157: 파일 경로 수정
                        this.sounds[s] = new Audio(`assets/audio/sfx_${s}.mp3`);
                        this.sounds[s].volume = this.sfxVolume;
                    });

                    // v10.111: SFX 볼륨 변화 감지
                    this.$watch('sfxVolume', (newVolume) => {
                        for (const key in this.sounds) {
                            if (this.sounds[key] instanceof Audio) {
                                this.sounds[key].volume = newVolume;
                            }
                        }
                    });
                },
                playSound(name) {
                    let audio;
                    const soundEntry = this.sounds[name];
                    
                    // v10.149: Array.isArray 체크 로직 제거 (이제 모든 SFX는 Audio 객체이므로)
                    if (soundEntry instanceof Audio) {
                        audio = soundEntry;
                    } else {
                        return;
                    }

                    if (audio) {
                        audio.currentTime = 0; 
                        audio.play().catch(() => {}); 
                    }
                },
                setDynamicHeight() { const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); },
                loadMemberData() {
                    this.memberData = [ { sNumber: 'S1', kor: '서연', eng: 'SeoYeon', color: '#22AEFF', birthday: '08-06', dimensions: ['KRE', 'LOVE', 'Neptune'], decoysKor: ['서언', '서영', '셔연'], decoysEng: ['SeoYoun', 'SeoYeong', 'SoeYeon'], type: 'member_card' }, { sNumber: 'S2', kor: '혜린', eng: 'HyeRin', color: '#9200FF', birthday: '04-12', dimensions: ['AAA', 'LOVE', 'VV', 'Sun'], decoysKor: ['헤린', '혜림', '해린'], decoysEng: ['HyeLin', 'HyeRim', 'HeyRin'], type: 'member_card' }, { sNumber: 'S3', kor: '지우', eng: 'JiWoo', color: '#FFF800', birthday: '10-24', dimensions: ['KRE', 'EVOL', 'Aria', 'Hatch!', 'Zenith'], decoysKor: ['지유', '시우', '지후'], decoysEng: ['JiWu', 'JiYu', 'JiWooo'], type: 'member_card' }, { sNumber: 'S4', kor: '채연', eng: 'ChaeYeon', color: '#98F21D', birthday: '12-04', dimensions: ['KRE', 'EVOL', 'Aria', 'Hatch!', 'Sun'], decoysKor: ['채언', '채영', '체연'], decoysEng: ['ChaeYoun', 'ChaeYeong', 'CheaYeon'], type: 'member_card' }, { sNumber: 'S5', kor: '유연', eng: 'YooYeon', color: '#DB0C74', birthday: '02-09', dimensions: ['AAA', 'EVOL', 'VV', 'Hatch!', 'Alphie', 'Sun'], decoysKor: ['유언', '유영', '우연'], decoysEng: ['YooYoun', 'YooYeong', 'YooYoen'], type: 'member_card' }, { sNumber: 'S6', kor: '수민', eng: 'SooMin', color: '#FC83A4', birthday: '10-03', dimensions: ['KRE', 'EVOL', 'Hatch!', 'Zenith'], decoysKor: ['수밈', '수빈', '슈민'], decoysEng: ['SooMean', 'SooBin', 'SuMin'], type: 'member_card' }, { sNumber: 'S7', kor: '나경', eng: 'NaKyoung', color: '#6799A0', birthday: '10-13', dimensions: ['AAA', 'EVOL', 'VV', 'Neptune'], decoysKor: ['나겅', '나겸', '다경'], decoysEng: ['NaKyeong', 'NaKyoum', 'NaKyuong'], type: 'member_card' }, { sNumber: 'S8', kor: '유빈', eng: 'YuBin', color: '#FFE3E2', birthday: '02-03', dimensions: ['AAA', 'LOVE', 'VV', 'Zenith'], decoysKor: ['유빔', '유민', '우빈'], decoysEng: ['YuBean', 'YuBim', 'YooBin'], type: 'member_card' }, { sNumber: 'S9', kor: '카에데', eng: 'Kaede', color: '#FFC935', birthday: '12-30', dimensions: ['LOVE', 'Aria', 'VV', 'Moon'], decoysKor: ['카에대', '카애데', '가에데'], decoysEng: ['Kaedeh', 'Kaebe', 'Keade'], type: 'member_card' }, { sNumber: 'S10', kor: '다현', eng: 'DaHyun', color: '#FF9AD6', birthday: '01-08', dimensions: ['LOVE', 'Aria', 'Neptune'], decoysKor: ['다헌', '다형', '다연'], decoysEng: ['DaHyeon', 'DaHyung', 'DaHuyn'], type: 'member_card' }, { sNumber: 'S11', kor: '코토네', eng: 'Kotone', color: '#FFDE00', birthday: '03-10', dimensions: ['EVOL', 'VV', 'Hatch!', 'Alphie', 'Neptune'], decoysKor: ['코토내', '코도네', '고토네'], decoysEng: ['Kotoneh', 'Katone', 'Kotonae'], type: 'member_card' }, { sNumber: 'S12', kor: '연지', eng: 'YeonJi', color: '#5974FF', birthday: '01-08', dimensions: ['EVOL', 'VV', 'Zenith'], decoysKor: ['연시', '영지', '언지'], decoysEng: ['YeonJee', 'YeongJi', 'YoenJi'], type: 'member_card' }, { sNumber: 'S13', kor: '니엔', eng: 'Nien', color: '#FF953F', birthday: '06-02', dimensions: ['LOVE', 'Aria', 'VV', 'Alphie', 'Neptune'], decoysKor: ['니앤', '니옌', '리엔'], decoysEng: ['Niaen', 'Niyen', 'Nein'], type: 'member_card' }, { sNumber: 'S14', kor: '소현', eng: 'SoHyun', color: '#1222B5', birthday: '10-13', dimensions: ['LOVE', 'VV', 'Moon'], decoysKor: ['소헌', '소형', '소연'], decoysEng: ['SoHyeon', 'SoHyung', 'SoHuyn'], type: 'member_card' }, { sNumber: 'S15', kor: '신위', eng: 'Xinyu', color: '#D51313', birthday: '05-25', dimensions: ['LOVE', 'VV', 'Sun'], decoysKor: ['신이', '시니', '신유'], decoysEng: ['Xinyui', 'Xinyi', 'Xinuy'], type: 'member_card' }, { sNumber: 'S16', kor: '마유', eng: 'Mayu', color: '#FE8E76', birthday: '05-12', dimensions: ['EVOL', 'Hatch!', 'Sun'], decoysKor: ['마우', '미유', '마위'], decoysEng: ['Mayoo', 'Miyu', 'Mayuu'], type: 'member_card' }, { sNumber: 'S17', kor: '린', eng: 'Lynn', color: '#AC62B7', birthday: '04-12', dimensions: ['NXT', 'VV', 'Alphie', 'Moon'], decoysKor: ['링', '림', '릴'], decoysEng: ['Lyn', 'Lym', 'Rynn'], type: 'member_card' }, { sNumber: 'S18', kor: '주빈', eng: 'JooBin', color: '#B7F54C', birthday: '01-16', dimensions: ['NXT', 'Zenith'], decoysKor: ['주빔', '주민', '쥬빈'], decoysEng: ['JooBean', 'JooBim', 'JuBin'], type: 'member_card' }, { sNumber: 'S19', kor: '하연', eng: 'HaYeon', color: '#52D9BB', birthday: '08-01', dimensions: ['NXT', 'Alphie', 'Zenith'], decoysKor: ['하언', '하영', '햐연'], decoysEng: ['HaYoun', 'HaYeong', 'HaYoen'], type: 'member_card' }, { sNumber: 'S20', kor: '시온', eng: 'ShiOn', color: '#FF428A', birthday: '04-03', dimensions: ['NXT', 'Hatch!', 'Alphie', 'Moon'], decoysKor: ['시은', '시옴', '시욘'], decoysEng: ['SiOn', 'ShiOm', 'ShiOne'], type: 'member_card' }, { sNumber: 'S21', kor: '채원', eng: 'ChaeWon', color: '#C7A3E0', birthday: '05-02', dimensions: ['Glow', 'Hatch!', 'Alphie', 'Sun'], decoysKor: ['채윈', '채웡', '체원'], decoysEng: ['ChaeOne', 'ChaeWong', 'CheaWon'], type: 'member_card' }, { sNumber: 'S22', kor: '설린', eng: 'Sullin', color: '#7BBA8D', birthday: '11-30', dimensions: ['Glow', 'Moon'], decoysKor: ['설륀', '설림', '선린'], decoysEng: ['Seollin', 'Sullim', 'Sulin'], type: 'member_card' }, { sNumber: 'S23', kor: '서아', eng: 'SeoAh', color: '#CFF3FF', birthday: '06-11', dimensions: ['Glow', 'Neptune'], decoysKor: ['서이', '시아', '서하'], decoysEng: ['SeoA', 'SeeAh', 'SoeAh'], type: 'member_card' }, { sNumber: 'S24', kor: '지연', eng: 'JiYeon', color: '#FFAB62', birthday: '02-13', dimensions: ['Glow', 'VV', 'Alphie', 'Moon'], decoysKor: ['지언', '지영', '시연'], decoysEng: ['JiYoun', 'JiYeong', 'JiYoen'], type: 'member_card' }
                    ];
                    this.dimensionData = [ 
                        { sNumber: 'AAA', color: '#333333', textColor: '#F5F5F5' }, 
                        { sNumber: 'KRE', color: '#EEAFA7', textColor: '#333333' }, // Fix: Changed text color from #F5F5F5 (white) to #333333 (dark gray) for better contrast
                        { sNumber: 'LOVE', color: '#FFF3EB', textColor: '#FF4499' }, 
                        { sNumber: 'EVOL', color: '#0D549A', textColor: '#F5F5F5' }, 
                        { sNumber: 'NXT', color: '#0C324D', textColor: '#F5F5F5' }, 
                        { sNumber: 'Glow', color: '#DEFBE9', textColor: '#333333' }, 
                        { sNumber: 'Aria', color: '#C8A2C8', textColor: '#F5F5F5' }, 
                        { sNumber: 'VV', color: '#947CAD', textColor: '#F5F5F5' }, 
                        { sNumber: 'Hatch!', color: '#EECBE1', textColor: '#333333' }, 
                        { sNumber: 'Alphie', color: '#6C81AC', textColor: '#333333' }, 
                        { sNumber: 'Moon', color: '#333333', textColor: '#7BBA8D' }, 
                        { sNumber: 'Sun', color: '#333333', textColor: '#D51313' }, 
                        { sNumber: 'Neptune', color: '#333333', textColor: '#22AEFF' }, 
                        { sNumber: 'Zenith', color: '#333333', textColor: '#52D9BB' }
                       
                    ];
                    this.modhausData = [ { sNumber: 'X', kor: '불량', eng: 'Defect', color: '#F5F5F5', birthday: '08-08', type: 'fail_card' }, { sNumber: 'MH', kor: '제이든', eng: 'Jaden', color: '#333333', birthday: '05-01', type: 'joker_card' } ];
                    this.artmsData = [ { sNumber: 'A1', kor: '희진', eng: 'HeeJin', color: '#ED008F', birthday: '10-19', type: 'goddess_card' }, { sNumber: 'A2', kor: '하슬', eng: 'HaSeul', color: '#01C261', birthday: '08-18', type: 'goddess_card' }, { sNumber: 'A3', kor: '김립', eng: 'Kim Lip', color: '#DB3547', birthday: '02-10', type: 'goddess_card' }, { sNumber: 'A4', kor: '진솔', eng: 'JinSoul', color: '#1724A7', birthday: '06-13', type: 'goddess_card' }, { sNumber: 'A5', kor: '최리', eng: 'Choerry', color: '#5B2A93', birthday: '06-04', type: 'goddess_card' } ];
                    this.friendData = [ { sNumber: 'BB', kor: '비비', eng: 'BIBI', color: '#AAAAAA', birthday: '09-27', type: 'friend_card' }, { sNumber: 'HS', kor: '형서', eng: 'HyungSeo', color: '#AAAAAA', birthday: '06-25', type: 'friend_card' }, { sNumber: 'JM', kor: '지민', eng: 'JiMin', color: '#AAAAAA', birthday: '11-25', type: 'friend_card' }, { sNumber: 'BE', kor: '보은', eng: 'BoEun', color: '#AAAAAA', birthday: '02-11', type: 'friend_card' }, { sNumber: 'YA', eng: 'YunAh', kor: '윤아', color: '#AAAAAA', birthday: '01-15', type: 'member_card' }, { sNumber: 'MK', kor: '모카', eng: 'Moka', color: '#AAAAAA', birthday: '10-08', type: 'member_card' }, { sNumber: 'DH', kor: '도희', eng: 'DoHee', color: '#AAAAAA', birthday: '12-09', type: 'member_card' }, { sNumber: 'SJ', kor: '승주', eng: 'SeungJoo', color: '#AAAAAA', birthday: '09-24', type: 'member_card' }, { sNumber: 'HR', eng: 'Haruna', kor: '하루나', color: '#AAAAAA', birthday: '01-30', type: 'member_card' }, { sNumber: 'YS', kor: '예서', eng: 'YeSeo', color: '#AAAAAA', birthday: '08-22', type: 'member_card' } ];
                },
                loadHighScores() { const scores = localStorage.getItem('objektRushHighScores_v4_main'); this.highScores = scores ? JSON.parse(scores) : []; },
                saveHighScores() { localStorage.setItem('objektRushHighScores_v4_main', JSON.stringify(this.highScores)); },
                loadExtraHighScores() { const scores = localStorage.getItem('objektRushHighScores_v4_extra'); this.extraHighScores = scores ? JSON.parse(scores) : []; },
                saveExtraHighScores() { localStorage.setItem('objektRushHighScores_v4_extra', JSON.stringify(this.extraHighScores)); },
                showRanking() { this.playSound('click'); this.previousGameState = this.gameState; this.loadHighScores(); this.loadExtraHighScores(); this.rankingTab = 'main'; this.gameState = 'ranking'; },
                showSettings() { this.playSound('click'); this.previousGameState = this.gameState; this.gameState = 'settings'; }, // Settings 화면 추가
                startGame(isContinuing = false) {
                    this.playSound('click');
                    if (!isContinuing) {
                        this.stage = 1; this.como = 0; this.totalScore = 0; this.amuletLevel = 0; this.assistLevel = 0; this.timePlusLevel = 0; this.scanLevel = 0; this.inventory = []; this.gravityVotes = {}; 
                        // v10.110: 초기 S24 카드 4장 지급 로직 삭제 (정식 밸런스)
                        this.gameState = 'intro'; this.introStep = 1;
                    } else {
                        // v10.111: 구조 변경에 따라 continue는 다음 스테이지(intermission)로 바로 진입
                        this.gameState = 'intermission';
                        this.startStageLogic(); // 스테이지 준비만 수행 (카운트다운은 nextStage에서)
                    }
                },
                nextIntroStep() { this.playSound('click'); this.introStep++; },
                startActualGame() { 
                    this.playSound('click'); 
                    // Stage 1은 바로 시작 (인터미션 로직 건너뛰기)
                    this.gameState = 'playing'; 
                    this.startStageLogic(); 
                },
                // v10.114: F 등급 처리 로직 변경: NEXT 버튼 활성화 시에만 호출됨
                handleIntermissionNext() {
                    this.playSound('click');
                    this.nextStage();
                },
                // v10.115: showFiredMessage 제거 (NEXT 비활성화로 대체)
                nextStage() {
                    this.currentBlock = null; 
                    this.completedCards = [];
                    this.matchedOrderIndices = []; 
                    
                    // V10.111 최종 FIX: 깜빡임 방지: gameState를 'transition'으로 즉시 변경
                    this.gameState = 'transition'; 
                    
                    setTimeout(() => {
                        // 업데이트 완료 후 playing으로 전환하여 화면 표시
                        this.gameState = 'playing'; 
                        this.startStageLogic(); // 게임 시작 준비
                    }, 0); 
                },
                startStageLogic() {
                    const configIndex = Math.min(this.stage - 1, this.stageConfig.length - 1); 
                    const config = this.stageConfig[configIndex]; 
                    if (!config) { console.error(`Stage config for stage ${this.stage} not found.`); return; }
                    this.targetScore = 0; this.totalBlocksPerStage = config.blocks + config.bosses.length; this.decoyRatio = config.decoy;
                    
                    // Reload는 인터미션에서 구매된 상태로 넘어오므로 재설정 안함
                    this.reloadCount = 10; // 기본 10회 고정
                    this.currentReloadPenalty = 5; 
                    
                    this.score = 0; this.blocksCompleted = 0; 
                    this.chainCount = 0; this.consecutivePerfects = 0;
                    this.nextBlockWillBeBoss = false; 
                    this.currentBlock = null; this.completedCards = []; this.selectedData = null; this.selectedInventoryCard = null; 
                    
                    // 게임 시작 카운트다운
                    this.startCountdownSequence(); 
                },
                startCountdownSequence() {
                    this.isStarting = true; 
                    
                    // v10.111 재도입: STAGE N 또는 OVERTIME 표시
                    this.startCountdown = this.stage >= 11 ? 'OVERTIME' : `STAGE ${this.stage}`;
                    
                    clearInterval(this.startTimer); 
                    
                    // 1000ms 후 START!로 전환 (WORK 단계 제거)
                    this.startTimer = setTimeout(() => {
                        if (this.gameState !== 'playing') { clearTimeout(this.startTimer); return; }
                        this.startCountdown = 'START!';
                        
                        // 500ms 후 게임 시작
                        this.startTimer = setTimeout(() => {
                            if (this.gameState !== 'playing') { clearTimeout(this.startTimer); return; }
                            this.isStarting = false; 
                            this.generateNewBlock(); 
                            this.refillData(true); 
                        }, 500); // 500ms 후 게임 시작
                    }, 1000); // 1000ms (STAGE N/OVERTIME 유지 시간)
                },
                startBlockTimer() {
                    clearInterval(this.orderTimer);
                    this.orderTimer = setInterval(() => {
                        if (this.gameState !== 'playing' || this.isStarting || !this.currentBlock) { clearInterval(this.orderTimer); return; }
                        this.currentBlock.timer = Math.max(0, this.currentBlock.timer - 100);
                        if (this.currentBlock.timer <= 0) { this.processBlockFailure(); }
                    }, 100);
                },
                getStageBaseComo() {
                    // v10.126: COMO 수급 로직 수정
                    if (this.stage >= 9 && this.stage <= 11) return 5;
                    if (this.stage >= 7) return 4;
                    if (this.stage >= 5) return 3;
                    if (this.stage >= 3) return 2;
                    if (this.stage >= 1) return 1;
                    return 0; // 안전장치
                },
                goToIntermission() { 
                    clearInterval(this.orderTimer);
                    this.totalScore += this.score; this.lastStageScore = this.score; this.selectedInventoryCard = null; 
                    
                    // v10.126: 기본 COMO 지급 로직 수정
                    this.comoEarned = this.getStageBaseComo();
                    
                    this.intermissionSpinCount = 0; 
                    
                    // v10.126: ReloadBoost는 그대로 유지 (다음 스테이지로 넘어가는 횟수)
                    // this.reloadBoost = Math.max(0, this.reloadCount - 10); // 기본 10회보다 남은 횟수 (현재 로직에서는 10회 소진 후 부스트 사용이므로 이 코드는 제거)
                    
                    const averageScore = this.score / this.totalBlocksPerStage;
                    
                    // v10.111 FIX: F 등급 추가 및 등급 기준 로직 수정
                    let grade = 'C'; 
                    this.bonusComo = 0;
                    if (averageScore >= 250) { grade = 'S'; this.bonusComo = 3; } 
                    else if (averageScore >= 150) { grade = 'A'; this.bonusComo = 2; } 
                    else if (averageScore >= 80) { grade = 'B'; this.bonusComo = 1; }
                    else if (averageScore < 30) { grade = 'F'; this.bonusComo = 0; } // F 등급 (30점 미만)
                    // C 등급은 30점 이상 80점 미만일 때 자동으로 할당됨
                    
                    this.lastStageGrade = grade; 
                    this.como += this.comoEarned + this.bonusComo;
                    
                    const comments = this.BOSS_COMMENTS[grade]; 
                    // v10.138: 다국어 키를 이용해 코멘트 내용을 가져오도록 수정
                    const commentKey = comments[Math.floor(Math.random() * comments.length)];
                    this.bossJComment = this.translate(commentKey);
                    
                    this.consecutivePerfects = 0; this.chainCount = 0;

                    // v10.111 FIX: Intermission 진입 전, 다음 스테이지로 미리 업데이트 (구조 변경)
                    let nextIsEnding = false;
                    if (this.stage < 10) {
                        this.stage++; // 다음 스테이지로 미리 업데이트
                    } else if (this.stage === 10) { 
                        // Stage 10 클리어 -> Ending으로 진입 (Stage는 10으로 유지)
                        nextIsEnding = true;
                    } else if (this.stage === 11) {
                        // Stage 11 클리어 -> Stage는 11로 유지 (Overtime)
                    }
                    
                    if (nextIsEnding) {
                        this.finalScore = this.totalScore; this.loadHighScores();
                        const totalBlocksInGame = 89; 
                        const finalAverage = this.totalScore / totalBlocksInGame;
                        if (finalAverage >= 250) this.endingType = 'S'; else if (finalAverage >= 150) this.endingType = 'A'; else if (finalAverage >= 80) this.endingType = 'B'; else this.endingType = 'C';
                        const lowestHighScore = (this.highScores.length < 10) ? 0 : this.highScores[9].score;
                        if (this.totalScore > lowestHighScore) { 
                            this.playerName = 'AAA'; 
                            this.previousGameState = 'ending'; // v10.125: 하이 스코어 제출 후 엔딩으로 돌아가기 위한 플래그 설정
                            this.gameState = 'submitScore'; 
                        } else { 
                            this.gameState = 'ending'; 
                        }
                    } else { // Stage 10 미만 또는 Overtime 클리어
                        this.gameState = 'intermission'; 
                        
                        // v10.155: F 등급일 경우 BGM 재생 방지
                        if (this.lastStageGrade === 'F') {
                            // F 등급이면 BGM을 정지합니다.
                            if (this.currentBGM) {
                                this.currentBGM.pause();
                                this.currentBGM = null;
                            }
                        }
                        
                        // 기능 해금 (F 등급이 아닐 때만 실행)
                        if (this.lastStageGrade !== 'F') {
                            // 기능 해금은 미리 업데이트된 this.stage 기준으로 실행 (순서 SWAP 적용)
                            // v10.141: 하드코딩 및 텍스트 수정 적용
                            if (this.stage === 2) this.showUnlock('SHOP OPEN!', 'OBJEKT, RELOAD');
                            
                            // Stage 4 클리어 후 -> Stage 5 진입 시: SPECIAL FUNCTIONS! -> SYSTEM UNLOCKED!
                            if (this.stage === 4) this.showUnlock('SYSTEM UNLOCKED!', 'SPIN, GRID'); 
                            
                            // TIME+ / SCAN (Stage 4 클리어 후 -> Stage 5 진입)
                            if (this.stage === 5) this.showUnlock('NEW ITEM!', 'TIME+, SCAN');
                            
                            // Stage 6 클리어 후 -> Stage 7 진입 시: GRAVITY SYSTEM UNLOCKED! -> SYSTEM UNLOCKED!
                            if (this.stage === 6) this.showUnlock('SYSTEM UNLOCKED!', 'GRAVITY SYSTEM READY');
                            
                            // AMULET / ASSIST (Stage 6 클리어 후 -> Stage 7 진입)
                            if (this.stage === 7) this.showUnlock('NEW ITEM!', 'AMULET, ASSIST');
                        }
                    }
                },
                showUnlock(title, message) { 
                    this.playSound('click'); 
                    this.unlockModal.title = title; 
                    this.unlockModal.message = message; 
                    this.unlockModal.show = true; 
                },
                // v10.115: F 등급 리셋 로직 제거 (NEXT 비활성화로 대체)
                closeUnlockModal() { 
                    this.playSound('click'); 
                    this.unlockModal.show = false; 
                },
                confirmReturn() { this.playSound('click'); this.returnConfirmModal.show = true; },
                cancelReturn() { this.playSound('click'); this.returnConfirmModal.show = false; },
                
                // v10.111: 데이터 초기화 확인 모달 표시
                confirmReset(type) {
                    this.playSound('click');
                    // 이 기능은 UI에서 제거되었으므로 호출될 일 없음. 안전장치로 유지
                    // this.resetConfirmModal = { show: true, type: type };
                },

                // v10.111: 데이터 초기화 실행
                executeReset() {
                    this.playSound('fail'); // 초기화는 강한 경고음 사용
                    // 이 기능은 UI에서 제거되었으므로 호출될 일 없음. 안전장치로 유지
                    this.resetConfirmModal.show = false;
                },
                // v10.111: 데이터 초기화 취소
                cancelReset() {
                    this.playSound('click');
                    this.resetConfirmModal.show = false;
                },

                submitScore() {
                    if (this.playerName.length === 0) return;
                    this.playSound('click');
                    
                    // 랭킹에 저장할 아이템 및 스페셜 카드 정보 스냅샷 생성
                    const itemsSnapshot = {
                        amulet: this.amuletLevel,
                        assist: this.assistLevel,
                        time: this.timePlusLevel,
                        scan: this.scanLevel,
                        reload: this.reloadBoost // 직전 스테이지에서 남은 리로드 횟수
                    };
                    
                    // 스페셜 카드만 필터링하고 S번호 순으로 정렬
                    const specialCardsSnapshot = this.inventory
                        .filter(c => c.isSpecial)
                        .sort((a, b) => {
                            const numA = parseInt(a.sNumber.slice(1));
                            const numB = parseInt(b.sNumber.slice(1));
                            return numA - numB;
                        });

                    if (this.stage === 10 && this.previousGameState === 'ending') { // 메인 게임(Stage 10) 클리어 스코어
                        this.highScores.push({ 
                            name: this.playerName, 
                            score: this.totalScore, 
                            stage: this.stage,
                            items: itemsSnapshot, // 아이템 정보 추가
                            specialCards: specialCardsSnapshot, // 스페셜 카드 정보 추가
                            season: this.currentSeason.name // v10.111-S: 시즌 정보 추가
                        });
                        this.highScores.sort((a, b) => b.score - a.score); this.highScores = this.highScores.slice(0, 10); this.saveHighScores();
                        this.gameState = 'ending'; 
                    } else if (this.stage === 11) { // 오버타임(Stage 11) 클리어 스코어
                         // this.stage는 항상 11로 기록됨
                        this.extraHighScores.push({ 
                            name: this.playerName, 
                            score: this.lastStageScore, 
                            stage: this.stage,
                            items: itemsSnapshot, // 아이템 정보 추가
                            specialCards: specialCardsSnapshot, // 스페셜 카드 정보 추가
                            season: this.currentSeason.name // v10.111-S: 시즌 정보 추가
                        });
                        this.extraHighScores.sort((a, b) => b.score - a.score); this.extraHighScores = this.extraHighScores.slice(0, 10); this.saveExtraHighScores();
                        this.gameState = 'intermission'; 
                    }
                },
                restartGame() { this.playSound('click'); this.returnConfirmModal.show = false; this.gameState = 'start'; },
                // v10.129 FIX: Stage를 11로 업데이트하여 Overtime 시작 시 Stage 11 설정이 로드되도록 수정
                continueOvertime() { this.playSound('click'); this.stage = 11; this.gameState = 'intermission'; },
                generateNewBlock() {
                    if (this.currentBlock) return;
                    this.blocksCompleted++;
                    const configIndex = Math.min(this.stage - 1, this.stageConfig.length - 1); 
                    const config = this.stageConfig[configIndex]; 
                    if (!config) { console.error(`Stage config for stage ${this.stage} not found.`); return; }
                    const normalBlockCount = config.blocks;
                    const isBossBlockTime = this.blocksCompleted > normalBlockCount && config.bosses.length > 0;
                    let chosenType = 'sNumber'; let isBoss = false; let blockLabel = '';

                    if (isBossBlockTime) {
                        chosenType = 'dimension'; isBoss = true; 
                        const bossIndex = this.blocksCompleted - normalBlockCount - 1;
                        const poolKeyIndex = Math.min(bossIndex, config.bosses.length - 1);
                        let poolKey = config.bosses[poolKeyIndex]; 
                        if (this.bossPools[poolKey]) {
                            const pool = this.bossPools[poolKey];
                            let gravityPool = this.gravityVotes;
                            
                            // v10.111: 오버타임(stage 11)일 때도 투표가 반영되어야 함
                            // if (this.stage <= 10) { // 이 조건 제거
                                gravityPool = {}; 
                                pool.forEach(name => gravityPool[name] = this.gravityVotes[name] || 0); 
                            // }
                            
                            const totalVotes = pool.reduce((acc, name) => acc + (gravityPool[name] || 0), 0) + pool.length;
                            
                            if (totalVotes > 0) {
                                let weightSum = 0;
                                const weightedPool = pool.map(name => { const weight = 1 + (gravityPool[name] || 0); weightSum += weight; return { name, weight }; });
                                let randomWeight = Math.random() * weightSum;
                                for (const boss of weightedPool) { if (randomWeight < boss.weight) { blockLabel = boss.name; break; } randomWeight -= boss.weight; }
                            } else { blockLabel = pool[Math.floor(Math.random() * pool.length)]; }
                        } else { blockLabel = poolKey; }
                    } else {
                        const rand = Math.random();
                        if (rand < config.birthdayChance) chosenType = 'birthday'; else chosenType = 'sNumber';
                    }
                    let members = []; let blockSize = 1; let blockTime = 15000; let memberPool = [...this.memberData];
                    if (chosenType === 'dimension') {
                        members = this.memberData.filter(m => m.dimensions.includes(blockLabel));
                        blockSize = members.length; 
                        blockTime = 15000 + (blockSize * 5000); 
                    } else {
                        blockSize = Math.floor(Math.random() * 4) + 1; blockTime = 10000 + (blockSize * 5000); 
                        for (let i = 0; i < blockSize; i++) { if (memberPool.length === 0) break; const index = Math.floor(Math.random() * memberPool.length); members.push(memberPool.splice(index, 1)[0]); }
                    }
                    if (this.timePlusLevel > 0) blockTime += 2000; 
                    
                    this.currentBlock = { id: Date.now() + Math.random(), members: members, bundleType: chosenType, bundleLabel: blockLabel, timeLimit: blockTime, timer: blockTime, isBoss: isBoss };
                    this.completedCards = []; this.selectedData = null; this.selectedInventoryCard = null; this.updateMatchedOrders(); this.startBlockTimer(); 
                },
                checkStageCompletion() {
                    const block = this.currentBlock; 
                    this.currentBlock = null; 
                    
                    const config = this.stageConfig[Math.min(this.stage - 1, this.stageConfig.length - 1)];
                    const isLastNormalBlock = this.blocksCompleted === config.blocks && config.bosses.length > 0;
                    const isStageComplete = this.blocksCompleted >= this.totalBlocksPerStage; // v10.151: 스테이지 완료 플래그

                    if (isLastNormalBlock || isStageComplete) { // v10.151: 스테이지 완료 시에도 클리어 로직 실행
                        this.consecutivePerfects = 0; this.chainCount = 0;
                    }

                    if (isStageComplete) {
                        // v10.154: STAGE CLEAR 사운드와 피드백 하드코딩 적용
                        this.playSound('stage_clear'); 
                        this.showFeedback('STAGE CLEAR!', 'correct'); // <--- 하드코딩된 텍스트

                        setTimeout(() => { 
                            this.goToIntermission(); 
                        }, 2000); // 2초의 딜레이 후 인터미션으로 전환
                        
                    } else {
                        if (isLastNormalBlock) {
                            this.playSound('warn'); 
                            this.nextBlockWillBeBoss = true;
                            setTimeout(() => { this.nextBlockWillBeBoss = false; this.generateNewBlock(); }, 3000); 
                        } else { 
                            setTimeout(() => { this.generateNewBlock(); }, 1500); 
                        }
                    }
                },
                processBlockComplete() { clearInterval(this.orderTimer); this.calculateAndApplyScore(false); },
                processBlockFailure() { clearInterval(this.orderTimer); this.calculateAndApplyScore(true); },
                calculateAndApplyScore(isTimeOver) {
                    const block = this.currentBlock; 
                    if (!block) return; 
                    let totalScore = 0; let correctCount = 0; let wrongCount = 0; let penalty = 0; 
                    let blockChecklist = [];
                    if (block.bundleType === 'birthday') { blockChecklist = [...block.members.map((member) => member.birthday)]; }
                    else { blockChecklist = [...block.members.map((member) => member.sNumber)]; }
                    
                    for (const card of this.completedCards) {
                        let isCorrect = false;
                        if (block.bundleType === 'birthday') {
                            const indexInBlock = blockChecklist.indexOf(card.birthday);
                            if (indexInBlock > -1 && card.type === 'member_card') { isCorrect = true; blockChecklist.splice(indexInBlock, 1); }
                        } else {
                            const indexInBlock = blockChecklist.indexOf(card.sNumber);
                            if (indexInBlock > -1) { isCorrect = true; blockChecklist.splice(indexInBlock, 1); }
                        }
                        
                        if (isCorrect) { totalScore += this.SCORING.CORRECT_CARD; correctCount++; }
                        else if (card.type === 'joker_card' && blockChecklist.length > 0) { totalScore += this.SCORING.CORRECT_CARD; correctCount++; blockChecklist.splice(0, 1); }
                        else {
                            wrongCount++;
                            if (card.type === 'fail_card') { totalScore -= this.SCORING.FAIL_PENALTY; penalty += this.SCORING.FAIL_PENALTY; }
                            else if (card.type === 'friend_card') { totalScore -= this.SCORING.FRIEND_PENALTY; penalty += this.SCORING.FRIEND_PENALTY; }
                            else if (card.type === 'goddess_card') { /* 0점 */ }
                        }
                    }
                    
                    const isPerfect = !isTimeOver && wrongCount === 0 && this.completedCards.length === block.members.length;
                    
                    if (isPerfect) {
                        let perfectBonus = this.SCORING.PERFECT_BASE * block.members.length;
                        if (block.isBoss) perfectBonus += this.SCORING.BOSS_FIXED_BONUS;
                        totalScore += perfectBonus; 
                    }
                    
                    if (isPerfect) {
                        if (!block.isBoss) {
                            this.consecutivePerfects++;
                            this.chainCount = Math.max(0, this.consecutivePerfects - 1); 
                            if (this.chainCount > 0) { 
                                const chainBonus = this.chainCount * 50; 
                                totalScore += chainBonus; 
                                this.playSound('chain'); 
                            }
                        }
                    } else { 
                        if (!block.isBoss) { this.consecutivePerfects = 0; this.chainCount = 0; } 
                    }
                    
                    this.score = Math.max(0, this.score + totalScore);
                    
                    let feedbackMsg = '';
                    if (isTimeOver) {
                        feedbackMsg = `${correctCount} / ${block.members.length}`;
                        this.playSound('fail'); 
                    } else if (isPerfect) {
                        feedbackMsg = `+${totalScore}`;
                         this.playSound('perfect'); 
                    } else if (wrongCount > 0) { 
                        totalScore = (correctCount * this.SCORING.CORRECT_CARD) - penalty; 
                        feedbackMsg = `${totalScore >= 0 ? '+' + totalScore : totalScore}`; 
                        this.playSound('clear'); 
                    } else {
                        feedbackMsg = `+${totalScore}`;
                        this.playSound('clear'); 
                    }

                    if (block.isBoss) {
                        if (isPerfect) { feedbackMsg = `BOSS PERFECT! ${feedbackMsg}`; }
                        else { feedbackMsg = `BOSS CLEAR! ${feedbackMsg}`; }
                    } else {
                        if (isPerfect && this.chainCount > 0) { feedbackMsg += ` (⛓️${this.chainCount})`; }
                    }
                    this.showFeedback(feedbackMsg, isTimeOver || wrongCount > 0 ? 'incorrect' : 'correct'); 
                    
                    this.checkStageCompletion(); 
                },
                selectData(type, dataName, id) { 
                    // v10.111 FIX: data_select 사운드 배열 호출
                    this.playSound('data_select'); 
                    this.selectedData = (this.selectedData && this.selectedData.id === id) ? null : { id, name: dataName, type }; 
                    this.selectedInventoryCard = null; 
                },
                selectInventoryCard(card) { 
                    this.playSound('select'); 
                    this.selectedInventoryCard = (this.selectedInventoryCard && this.selectedInventoryCard.inventoryId === card.inventoryId) ? null : card; 
                    if (this.gameState === 'playing') this.selectedData = null; 
                },
                async inputData() {
                    if (!this.inputEnabled() || !this.currentBlock) return;
                    this.playSound('input'); 
                    let newCardData;
                    if (this.selectedData) {
                        const dataName = this.selectedData.name;
                        const member = this.memberData.find(m => m.kor === dataName || m.eng === dataName);
                        const isFriend = this.friendData.find(f => f.kor === dataName || f.eng === dataName);
                        
                        if (member) newCardData = member;
                        else if (isFriend) newCardData = isFriend; 
                        else newCardData = this.modhausData.find(m => m.sNumber === 'X'); 
                        
                        if ((newCardData.type === 'fail_card' || newCardData.type === 'friend_card') && this.amuletLevel > 0 && Math.random() < 0.2) {
                            newCardData = this.artmsData[Math.floor(Math.random() * this.artmsData.length)]; 
                            this.showFeedback(this.translate('feedback_amulet_activated'), 'correct');
                        }

                        this.clearSelectedData(true); 
                    } else if (this.selectedInventoryCard) {
                        newCardData = this.selectedInventoryCard;
                        if (!newCardData.isSpecial) { 
                            const index = this.inventory.findIndex(item => item.inventoryId === newCardData.inventoryId); 
                            if (index > -1) this.inventory.splice(index, 1); 
                        }
                        this.selectedInventoryCard = null;
                    }
                    
                    const newCard = { ...newCardData, id: Date.now() + Math.random(), isSpecial: newCardData.isSpecial || false };
                    if (this.completedCards.length < 8) this.completedCards.push(newCard); 
                    else { this.completedCards.shift(); this.completedCards.push(newCard); }
                    
                    this.updateMatchedOrders(); 
                    
                    if (this.completedCards.length === this.currentBlock.members.length) {
                        this.processBlockComplete(); 
                    }
                },
                updateMatchedOrders() {
                    if (!this.currentBlock) { this.matchedOrderIndices = []; return; }
                    
                    this.matchedOrderIndices = new Array(this.currentBlock.members.length).fill(false);
                    let slotCards = [...this.completedCards]; 
                    
                    for (let i = 0; i < this.currentBlock.members.length; i++) {
                        if (this.matchedOrderIndices[i]) continue;
                        
                        const order = this.currentBlock.members[i];
                        let matchIndex = -1;
                        
                        // 1. 정답 카드 찾기
                        if (this.currentBlock.bundleType === 'birthday') {
                            matchIndex = slotCards.findIndex(c => c && c.type === 'member_card' && c.birthday === order.birthday);
                        } else {
                            matchIndex = slotCards.findIndex(c => c && c.sNumber === order.sNumber);
                        }
                        
                        if (matchIndex !== -1) {
                            this.matchedOrderIndices[i] = true;
                            slotCards[matchIndex] = null; // 사용된 슬롯 카드는 제거
                            continue; 
                        }

                        // 2. 정답 카드가 없으면 조커 카드 찾기
                        const jokerIndex = slotCards.findIndex(c => c && c.type === 'joker_card');
                        if (jokerIndex !== -1) {
                            this.matchedOrderIndices[i] = true;
                            slotCards[jokerIndex] = null; 
                        }
                    }
                },
                reloadData() {
                    this.playSound('refresh'); 
                    
                    let actualReloads = 0;

                    // v10.126: 기본 횟수 10회를 먼저 소진
                    if (this.reloadCount > 0) {
                        this.reloadCount--;
                        actualReloads = this.reloadCount;
                    } 
                    // 기본 횟수 소진 후 구매한 부스트 횟수 소진
                    else if (this.reloadBoost > 0) {
                        this.reloadBoost--;
                        actualReloads = this.reloadBoost;
                    } 
                    // 모든 횟수 소진 후 페널티 적용
                    else {
                        this.score = Math.max(0, this.score - this.currentReloadPenalty);
                        this.showFeedback('Score Penalty -${this.currentReloadPenalty}', 'incorrect');
                        this.currentReloadPenalty = Math.min(30, this.currentReloadPenalty + 5);
                    }

                    // v10.133 FIX: 배열 전체를 새 배열로 할당
                    this.refillData(true); // reloadData는 항상 새 ID를 사용하도록 강제
                    this.selectedInventoryCard = null; this.selectedData = null;
                },
                getReloadDisplayCount() {
                    // v10.126: Reload 버튼에 표시되는 횟수 로직
                    if (this.reloadCount > 0) {
                        return this.reloadCount; // 기본 횟수 표시
                    }
                    if (this.reloadBoost > 0) {
                        return this.reloadBoost; // 구매 횟수 표시
                    }
                    return -this.currentReloadPenalty; // 페널티 표시
                },
                getReloadDisplayColor() {
                    // v10.126: Reload 버튼 색상 로직
                    if (this.reloadCount > 0) {
                        return 'text-white'; // 기본 횟수 잔여 시 흰색
                    }
                    if (this.reloadBoost > 0) {
                        return 'text-cyan-400'; // 구매 횟수 잔여 시 시안색
                    }
                    return 'text-red-400'; // 페널티 시 빨간색
                },
                clearSelectedData(isInput) {
                    if (!this.selectedData) return;
                    const selected = this.selectedData;
                    
                    // v10.147 FIX: 안전한 교체 (splice)를 위해 getNewData가 항상 새 ID를 갖도록 호출
                    const newData = this.getNewData(selected.type); 
                    
                    if (selected.type === 'kor') {
                        const index = this.korData.findIndex(k => k.id === selected.id);
                        if (index > -1) {
                            // v10.147 FIX: splice를 사용하여 Alpine의 DOM 노드 추적 충돌을 최소화
                            this.korData.splice(index, 1, newData); 
                        }
                    } else {
                        const index = this.engData.findIndex(k => k.id === selected.id);
                        if (index > -1) {
                            // v10.147 FIX: splice를 사용하여 Alpine의 DOM 노드 추적 충돌을 최소화
                            this.engData.splice(index, 1, newData);
                        }
                    }
                    this.selectedData = null;
                },
                shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
                ,
                refillData(isSafeMode = false) {
                    let memberPool = [...this.memberData];
                    this.shuffleArray(memberPool);
                    const selectedTwelve = memberPool.slice(0, 12);
                    
                    const newKorData = [];
                    const newEngData = [];

                    for (let i = 0; i < 6; i++) {
                        // isSafeMode=true 상태로 generateDataItem 호출 -> 항상 새 ID 할당
                        newKorData.push(this.generateDataItem(selectedTwelve[i], 'kor', isSafeMode)); 
                    }
                    for (let i = 6; i < 12; i++) {
                        newEngData.push(this.generateDataItem(selectedTwelve[i], 'eng', isSafeMode));
                    }
                    
                    // v10.147 FIX: splice를 사용하여 Alpine의 DOM 노드 추적 충돌을 최소화
                    this.korData.splice(0, this.korData.length, ...newKorData);
                    this.engData.splice(0, this.engData.length, ...newEngData);
                },
                getNewData(type) {
                    const currentDisplayedSNumbers = [...this.korData, ...this.engData].map(d => d.originSNumber).filter(Boolean);
                    let availableMembers = this.memberData.filter(m => !currentDisplayedSNumbers.includes(m.sNumber));
                    
                    if (availableMembers.length === 0) { 
                        availableMembers = [...this.memberData]; 
                    }
                    
                    const randomMember = availableMembers[Math.floor(Math.random() * availableMembers.length)];
                    return this.generateDataItem(randomMember, type, false); 
                },
                generateDataItem(member, type, isSafeMode = false) {
                    let dataName = (type === 'kor') ? member.kor : member.eng;
                    let originSNumber = member.sNumber; 
                    
                    if (!isSafeMode && this.stage > 1 && Math.random() < this.decoyRatio) { 
                        if (this.assistLevel > 0 && Math.random() < 0.2) { 
                            const friend = this.friendData[Math.floor(Math.random() * this.friendData.length)];
                            dataName = (type === 'kor') ? friend.kor : (friend.eng || friend.kor);
                            originSNumber = friend.sNumber; 
                        } else {
                            const decoys = (type === 'kor') ? member.decoysKor : member.decoysEng;
                            if (decoys && decoys.length > 0) {
                                dataName = decoys[Math.floor(Math.random() * decoys.length)];
                            }
                        }
                    }
                    
                    // v10.137 FIX: ID 재활용 로직 제거. 항상 새 ID를 할당하여 Alpine의 DOM 교체 시 충돌 방지.
                    let id = Date.now() + Math.random(); 
                    
                    return { id: id, name: dataName, type: type, originSNumber: originSNumber };
                },
                inputEnabled() { return this.selectedData !== null || this.selectedInventoryCard !== null; },
                isSelectedData(id) { return this.selectedData?.id === id; },
                isSelectedInventory(inventoryId) { return this.selectedInventoryCard?.inventoryId === inventoryId; },
                showFeedback(message, type) { clearTimeout(this.feedback.timer); this.feedback.message = message; this.feedback.type = type; this.feedback.show = true; this.feedback.timer = setTimeout(() => { this.feedback.show = false; }, 1500); },
                openShopModal(item) {
                    this.playSound('click');
                    if (item === 'objekt') { 
                        if (this.inventory.length >= this.inventoryMaxSize) { this.showFeedback(this.translate('feedback_collect_full'), 'incorrect'); return; }
                        this.openGachaModal(); 
                        return; 
                    }
                    const info = this.ITEM_INFO[item];
                    if (!info) return;
                    // v10.138: desc를 다국어 키로 변환
                    this.shopModal = { show: true, item: item, title: info.title, desc: this.translate(info.desc), cost: info.cost, isMax: false };
                    
                    if (item === 'timePlus' && this.timePlusLevel >= 1) this.shopModal.isMax = true;
                    if (item === 'scan' && this.scanLevel >= 1) this.shopModal.isMax = true;
                    if (item === 'amulet' && this.amuletLevel >= 1) this.shopModal.isMax = true;
                    if (item === 'assist' && this.assistLevel >= 1) this.shopModal.isMax = true;
                    if (item === 'reload' && this.reloadBoost >= 20) this.shopModal.isMax = true; 
                },
                closeShopModal() { this.playSound('click'); this.shopModal.show = false; },
                confirmBuyItem() {
                    // v10.128: F 등급 잠금 해제 (NEXT 버튼만 비활성화)
                    if (this.shopModal.item && !this.shopModal.isMax) { 
                        this.executePurchase(this.shopModal.item); 
                        if (this.shopModal.item === 'reload') {
                            if (this.reloadBoost >= 20) this.shopModal.isMax = true;
                        } else {
                            this.closeShopModal();
                        }
                    } else {
                        this.closeShopModal(); 
                    }
                },
                openGachaModal() {
                    // v10.128: F 등급 잠금 해제 (NEXT 버튼만 비활성화)
                    this.gachaState = 'ready'; this.gachaResultCard = null; this.gameState = 'gacha';
                },
                closeGachaModal() { this.playSound('click'); this.gameState = 'intermission'; },
                startGachaAnimation() {
                    if (this.como < 1) { this.showFeedback('NOT ENOUGH COMO!', 'incorrect'); return; }
                    this.como -= 1;
                    this.playSound('gacha'); 
                    this.gachaState = 'opening';
                    
                    setTimeout(() => {
                        if (this.inventory.length >= this.inventoryMaxSize) {
                             this.como += 1; 
                             this.showFeedback(this.translate('feedback_collect_full'), 'incorrect');
                             this.closeGachaModal();
                             return;
                        }
                        if (Math.random() < 0.005) { 
                            this.gachaResultCard = { ...this.modhausData.find(m => m.sNumber === 'MH'), inventoryId: Date.now() + Math.random(), isSpecial: false, type: 'joker_card' };
                             setTimeout(() => { this.gachaState = 'joker_flash'; setTimeout(() => { this.gachaState = 'result'; }, 1500); }, 2000);
                        } else {
                            const randomMember = this.memberData[Math.floor(Math.random() * this.memberData.length)];
                            this.gachaResultCard = { ...randomMember, inventoryId: Date.now() + Math.random(), isSpecial: false, type: 'member_card' };
                            setTimeout(() => { this.gachaState = 'result'; }, 2000);
                        }
                    }, 0); 
                },
                confirmGachaResult() {
                    if (this.gachaResultCard) {
                        // v10.111: JOKER 카드 예외 로직 삭제 (인벤토리 꽉 차면 JOKER도 안 들어감)
                         if (this.inventory.length >= this.inventoryMaxSize) {
                              this.como += 1; 
                              this.showFeedback(this.translate('feedback_collect_full'), 'incorrect'); 
                              this.closeGachaModal(); 
                              return;
                         }
                        this.inventory.push(this.gachaResultCard);
                        if (this.gachaResultCard.type === 'joker_card') { this.showFeedback(this.translate('feedback_joker_acquired'), 'correct'); }
                        // v10.138: 다국어 키를 이용해 피드백 메시지 생성
                        else { this.showFeedback(`${this.gachaResultCard.sNumber} ${this.translate('feedback_card_acquired')}`, 'correct'); this.checkCraftingAvailability(this.gachaResultCard); }
                    }
                    this.closeGachaModal();
                },
                executePurchase(item) {
                    const info = this.ITEM_INFO[item];
                    if (!info) return;
                    if (this.como >= info.cost) {
                         this.como -= info.cost;
                         this.playSound('buy'); 
                         switch(item) {
                            case 'reload': this.reloadBoost = Math.min(20, this.reloadBoost + 1); break;
                            case 'scan': this.scanLevel++; break; 
                            case 'amulet': this.amuletLevel++; break; 
                            case 'assist': this.assistLevel++; break; 
                            case 'timePlus': this.timePlusLevel++; break;
                        }
                    } else { this.showFeedback('NOT ENOUGH COMO!', 'incorrect'); }
                },
                startSpin() { 
                    if (this.isCrafting) return; 
                    // v10.138: 다국어 키를 이용해 피드백 메시지 생성
                    if (!this.selectedInventoryCard) { this.showFeedback('SPIN FAILED...', 'incorrect'); return; }
                    if (this.intermissionSpinCount >= 3) {
                         return;
                    }
                    this.playSound('click');
                    this.intermissionSpinCount++; 
                    this.selectedInventoryCardForSpin = this.selectedInventoryCard; this.selectedInventoryCard = null; this.spinResult = null; this.generateSpinGrid(); this.isSpinning = true; 
                },
                generateSpinGrid() {
                    this.spinGrid = []; 
                    // v10.127: Spin에서 획득 가능한 스페셜 카드 (isSpecial: true)를 첫 번째 요소로 추가
                    this.spinGrid.push({ ...this.memberData[Math.floor(Math.random() * this.memberData.length)], inventoryId: Date.now() + Math.random(), isSpecial: true, type: 'member_card' });
                    for (let i = 0; i < 2; i++) this.spinGrid.push({ ...(this.modhausData.find(m => m.sNumber === 'X')), inventoryId: Date.now() + Math.random(), isSpecial: false });
                    for (let i = 0; i < 13; i++) this.spinGrid.push({ ...this.memberData[Math.floor(Math.random() * this.memberData.length)], inventoryId: Date.now() + Math.random(), isSpecial: false, type: 'member_card' });
                    this.shuffleArray(this.spinGrid);
                },
                selectSpinCard(card) {
                    if (this.spinResult) return; 
                    this.playSound('input'); 
                    this.spinResult = card; 
                    const index = this.inventory.findIndex(c => c.inventoryId === this.selectedInventoryCardForSpin.inventoryId);
                    if (index > -1) {
                        if (card.type !== 'fail_card') { 
                            this.inventory.splice(index, 1, card); 
                            // v10.138: 다국어 키를 이용해 피드백 메시지 생성
                            this.showFeedback(`${card.sNumber} ${this.translate('feedback_card_acquired')}`, 'correct'); 
                            if (!card.isSpecial) this.checkCraftingAvailability(card); 
                        }
                        else { 
                            this.inventory.splice(index, 1); 
                            // v10.138: 다국어 키를 이용해 피드백 메시지 생성
                            this.showFeedback(this.translate('feedback_spin_failed'), 'incorrect'); 
                        }
                    }
                    setTimeout(() => { this.isSpinning = false; setTimeout(() => { this.selectedInventoryCardForSpin = null; this.spinResult = null; }, 300); }, 2000); 
                },
                canCraft() { if (!this.selectedInventoryCard || this.selectedInventoryCard.isSpecial) return false; return this.inventory.filter(c => c.sNumber === this.selectedInventoryCard.sNumber && !c.isSpecial).length >= 4; },
                startGridCraft() {
                    if (this.isSpinning) return; 
                    // v10.138: 다국어 키를 이용해 피드백 메시지 생성
                    if (!this.canCraft()) { this.showFeedback(this.translate('feedback_need_four_cards'), 'incorrect'); return; }
                    this.playSound('gacha'); 
                    this.craftingCard = this.selectedInventoryCard; this.isCrafting = true; this.selectedInventoryCard = null;
                    setTimeout(() => {
                        let removedCount = 0; 
                        for (let i = this.inventory.length - 1; i >= 0; i--) { 
                            if (this.inventory[i].sNumber === this.craftingCard.sNumber && !this.inventory[i].isSpecial && removedCount < 4) { 
                                this.inventory.splice(i, 1); removedCount++; 
                            } 
                        }
                        const specialCard = { ...this.craftingCard, inventoryId: Date.now() + Math.random(), isSpecial: true }; 
                        this.inventory.push(specialCard); 
                        // v10.138: 다국어 키를 이용해 피드백 메시지 생성
                        this.showFeedback(`✨ ${specialCard.sNumber} ${this.translate('feedback_grid_complete')}`, 'correct');
                        
                        setTimeout(() => { 
                            this.isCrafting = false; 
                            this.craftingCard = null; 
                        }, 500);
                    }, 2500); 
                },
                checkCraftingAvailability(card) { 
                    // v10.138: 다국어 키를 이용해 피드백 메시지 생성
                    if (card && this.inventory.filter(c => c.sNumber === card.sNumber && !c.isSpecial).length >= 4) this.showFeedback(`${card.sNumber} ${this.translate('feedback_grid_available')}`, 'correct'); 
                },
                getGravityVotes(poolKey) { return this.bossPools[poolKey] || []; },
                initializeGravityVotes() {
                    // v10.111: 오버타임(stage 11)에서도 투표가 가능하도록 수정
                    // Stage 10을 막 클리어했으면(this.stage === 10), 다음 스테이지(11)의 config를 가져옴
                    // Stage 11을 막 클리어했으면(this.stage === 11), 다음 스테이지(11)의 config를 가져옴
                    const configIndex = (this.stage === 10) ? this.stage : Math.min(this.stage - 1, this.stageConfig.length - 1);
                    const nextConfig = this.stageConfig[configIndex];
                    
                    if (!nextConfig || nextConfig.bosses.length === 0 || !this.bossPools[nextConfig.bosses[0]]) { this.gravityVotes = {}; return; }
                    const pool = this.bossPools[nextConfig.bosses[0]];
                    if (pool.some(name => this.gravityVotes[name] === undefined)) {
                        pool.forEach(name => { this.gravityVotes[name] = 0; });
                    }
                },
                voteForBoss(bossName) { 
                    // v10.128: F 등급 잠금 해제 (NEXT 버튼만 비활성화)
                    // v10.138: 다국어 키를 이용해 피드백 메시지 생성
                    if (this.como >= 1) { this.como--; this.gravityVotes[bossName] = (this.gravityVotes[bossName] || 0) + 1; this.playSound('buy'); } else this.showFeedback('NOT ENOUGH COMO!', 'incorrect'); 
                },
                getBossProbability(bossName, poolKey) {
                    const pool = this.bossPools[poolKey]; if (!pool) return 0;
                    const totalWeight = pool.reduce((acc, name) => acc + (this.gravityVotes[name] || 0), 0) + pool.length;
                    return totalWeight === 0 ? (100 / pool.length).toFixed(1) : (((this.gravityVotes[bossName] || 0) + 1) / totalWeight * 100).toFixed(1);
                },
                isMatchingOrder(card, indexInStall) {
                    if (!this.currentBlock) return false;
                    if (!card) return false; 
                    
                    if (card.type === 'joker_card') return true;
                    
                    if (this.currentBlock.bundleType === 'birthday') { 
                        if (card.type !== 'member_card') return false;
                        const requiredCount = this.currentBlock.members.filter(m => m.birthday === card.birthday).length;
                        if (requiredCount === 0) return false;
                        let previousCount = 0;
                        for (let i = 0; i < indexInStall; i++) { 
                            if (this.completedCards[i]?.birthday === card.birthday) previousCount++; 
                        }
                        return previousCount < requiredCount;
                    }
                    
                    // S-Number 체크
                    const requiredCount = this.currentBlock.members.filter(m => m.sNumber === card.sNumber).length;
                    if (requiredCount === 0) return false;
                    
                    let previousCount = 0;
                    for (let i = 0; i < indexInStall; i++) { 
                        if (this.completedCards[i]?.sNumber === card.sNumber) previousCount++; 
                    }
                    return previousCount < requiredCount;
                },
                getBirthdayBackground(member) {
                    if (this.scanLevel === 0) return 'background-color: #F5F5F5; border-color: #A0A0A0;';
                    const twins = this.memberData.filter(m => m.birthday === member.birthday).sort((a, b) => parseInt(a.sNumber.slice(1)) - parseInt(b.sNumber.slice(1)));
                    if (twins.length === 2) {
                        return `background: linear-gradient(to right, ${twins[0].color} 50%, ${twins[1].color} 50%); border-color: #A0A0A0;`;
                    }
                    return `background-color: ${member.color}; border-color: #A0A0A0;`;
                },
                getMembersByDimension(dimName) { return this.memberData.filter(m => m.dimensions.includes(dimName)); },
                // v10.111-S: 현재 시즌의 색상을 반환
                getCurrentSeasonColor() {
                    const season = this.SEASON_CONFIG.find(s => s.name === this.currentSeason.name);
                    return season ? season.color : '#FFFFFF';
                }
            }
        }
    </script>
</head>
<body class="bg-[#09090b] text-white font-sans antialiased overflow-hidden premium-bg">
    <div id="game-container" class="w-full max-w-md mx-auto flex flex-col items-center justify-start bg-transparent" style="height: 100vh; height: calc(var(--vh, 1vh) * 100);">
        <!-- v10.130: x-cloak 적용으로 초기 로딩 안정성 확보 -->
        <div x-data="game()" x-init="init()" x-cloak class="w-full h-full flex flex-col relative">
            
            <!-- 1. Start Screen -->
            <div x-show="gameState === 'start'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center z-50 title-bg-effect overflow-hidden">
                <!-- Floating Objekts -->
                <template x-for="i in 8"><div class="floating-objekt" :style="`top: ${Math.random() * 80 + 10}%; left: ${Math.random() * 80 + 10}%; animation-delay: -${Math.random() * 20}s; animation-duration: ${20 + Math.random() * 10}s`"></div></template>
                
                <div class="z-10 text-center p-8 flex flex-col items-center w-full">
                    <h1 class="text-7xl font-black mb-2 tracking-tighter leading-none"><span class="holo-text">OBJEKT</span><br><span class="text-white">RUSH</span></h1>
                    <!-- 부제목 변경: MH AGENT: RECRUIT -->
                    <p class="text-xl text-gray-300 font-semibold tracking-widest mb-12 opacity-80">MH AGENT: RECRUIT</p>
                    
                    <!-- v10.139: WORK START 하드코딩 -->
                    <button @click="startGame(false)" class="glass-button w-full py-4 px-6 mb-4 rounded-xl text-2xl font-bold text-white">WORK START</button>
                    <!-- REKORD와 CONFIG를 같은 가로줄에 배치 (grid-cols-2) -->
                    <div class="grid grid-cols-2 gap-4 w-full">
                        <!-- v10.139: REKORD 하드코딩 -->
                        <button @click="showRanking()" class="glass-button w-full py-4 px-6 rounded-xl text-xl font-bold text-gray-300 hover:text-white">REKORD</button>
                        <!-- v10.139: CONFIG 하드코딩 -->
                        <button @click="showSettings()" class="glass-button w-full py-4 px-6 rounded-xl text-xl font-bold text-gray-300 hover:text-white">CONFIG</button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-16 opacity-50">Developed by Kalsaver (2025) | Unofficial Fan Game</p>
                </div>
            </div>

            <!-- 2. Intro Screen -->
            <div x-show="gameState === 'intro'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center p-6 z-50 bg-black/80 backdrop-blur-md">
                <!-- Step 1: Briefing -->
                <div class="glass-panel briefing-panel p-6 rounded-3xl w-full h-full flex flex-col" x-show="introStep === 1" x-transition:enter="transition ease-out duration-500" x-transition:enter-start="opacity-0 translate-x-10" x-transition:enter-end="opacity-100 translate-x-0">
                    <div class="text-center mb-8 mt-4 flex-grow flex flex-col justify-center relative z-10 overflow-hidden">
                        <div class="h-full overflow-y-auto scrollbar-thin px-2">
                            <h2 class="text-3xl font-black text-yellow-300 mb-6 tracking-widest uppercase sticky top-0 bg-[#09090b]/80 backdrop-blur-md py-2 z-10" x-text="'MISSION ORDER'"></h2>
                            <div class="space-y-6 text-lg text-gray-200 pb-4">
                                <p class="italic" x-text="translate('intro_line_0')"></p>
                                <div class="bg-white/5 p-5 rounded-xl border border-white/10 text-left space-y-3 shadow-inner">
                                    <!-- v10.138: 다국어 키로 대체 -->
                                    <p x-text="`1. ${translate('intro_line_1_a')}`"></p>
                                    <p x-text="`2. ${translate('intro_line_1_b')}`"></p>
                                    <p x-text="`3. ${translate('intro_line_1_c')}`"></p>
                                    <p x-text="`4. ${translate('intro_line_1_d')}`"></p> <!-- <--- 4번 항목 추가 -->
                                </div>
                                <p class="italic" x-text="translate('intro_line_prompt')"></p> <!-- <--- 프롬프트 문구로 변경 -->
                            </div>
                        </div>
                    </div>
                    <!-- v10.142: NEXT (DATA ACCESS)를 DATA ACCESS로 변경 -->
                    <button @click="nextIntroStep()" class="glass-button w-full py-4 text-2xl font-bold rounded-2xl text-white relative z-10 hover:border-gray-300/50">DATA ACCESS</button>
                </div>

                <!-- Step 2: Data Sheet -->
                <div class="glass-panel p-6 rounded-3xl w-full h-full flex flex-col" x-show="introStep === 2" x-transition:enter="transition ease-out duration-500" x-transition:enter-start="opacity-0 translate-x-10" x-transition:enter-end="opacity-100 translate-x-0">
                    <div class="text-center mb-4 flex-shrink-0">
                        <!-- v10.139: S-CLASS LIST 하드코딩 -->
                        <h2 class="text-2xl font-black text-cyan-300 mb-1 tracking-widest" x-text="'S-CLASS LIST'"></h2>
                        <p class="text-gray-400 text-sm tracking-wider font-mono">// CONFIDENTIAL DATA //</p>
                    </div>
                    <div class="flex w-full mb-4 rounded-xl glass-panel p-1 flex-shrink-0">
                        <!-- v10.140: S-CLASS 하드코딩 -->
                        <button @click="introTab = 'members'" class="w-1/2 py-2 rounded-lg text-sm font-bold transition-all" :class="introTab === 'members' ? 'bg-cyan-600/80 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'">S-CLASS</button>
                        <!-- v10.140: DIMENSION 하드코딩 -->
                        <button @click="introTab = 'dimensions'" class="w-1/2 py-2 rounded-lg text-sm font-bold transition-all" :class="introTab === 'dimensions' ? 'bg-purple-600/80 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'">DIMENSION</button>
                    </div>
                    <div class="flex-grow overflow-y-auto scrollbar-thin bg-black/40 rounded-xl p-4 mb-6 border border-white/10 font-mono">
                        <!-- S-Class Tab -->
                        <div x-show="introTab === 'members'" class="grid grid-cols-1 gap-2">
                            <template x-for="member in memberData" :key="member.sNumber">
                                <div class="flex items-center p-3 rounded-lg border border-white/5 bg-white/5">
                                    <div class="w-12 h-12 flex items-center justify-center rounded-md mr-4 font-black text-xl border-2" :style="`background-color: ${member.color}; border-color: #A0A0A0; color: #000;`" x-text="member.sNumber"></div>
                                    <div class="flex flex-col">
                                        <span class="text-white font-bold text-lg" x-text="member.kor"></span>
                                        <span class="text-gray-400 text-xs uppercase tracking-wider" x-text="member.eng"></span>
                                    </div>
                                    <div class="ml-auto text-right">
                                        <span class="text-cyan-300 font-bold" x-text="member.birthday"></span>
                                        <span class="text-gray-500 text-xs block">BIRTHDAY</span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <!-- Dimension Tab -->
                        <div x-show="introTab === 'dimensions'" class="space-y-4">
                             <template x-for="dim in dimensionData" :key="dim.sNumber">
                                <div class="glass-panel p-3 rounded-xl border border-white/5 bg-white/5">
                                    <div class="flex items-center mb-3">
                                        <div class="px-3 py-1 rounded-lg font-black text-lg mr-2 border" :style="`background-color: ${dim.color}; color: ${dim.textColor}; border-color: #A0A0A0;`" x-text="dim.sNumber"></div>
                                        <span class="text-gray-400 text-xs tracking-widest" x-text="`${getMembersByDimension(dim.sNumber).length} Members`"></span>
                                    </div>
                                    <div class="grid grid-cols-5 gap-2">
                                         <template x-for="member in getMembersByDimension(dim.sNumber)" :key="member.sNumber">
                                             <div class="flex flex-col items-center p-1 bg-black/30 rounded-lg border border-white/10">
                                                 <div class="w-8 h-8 flex items-center justify-center rounded-md font-bold text-sm border" :style="`background-color: ${member.color}; border-color: #A0A0A0; color: #000;`" x-text="member.sNumber"></div>
                                                 <span class="text-gray-300 text-[10px] mt-1" x-text="member.kor"></span>
                                             </div>
                                         </template>
                                    </div>
                                </div>
                             </template>
                        </div>
                    </div>
                    <!-- v10.142: CONFIRM (WORK START)를 CONFIRM으로 변경 -->
                    <button @click="startActualGame()" class="glass-button btn-green-glow w-full py-4 text-2xl font-bold rounded-2xl text-green-400">CONFIRM</button>
                </div>
            </div>

            <!-- 3. Game Playing Screen -->
            <div x-show="gameState === 'playing'" x-transition.opacity.duration.300ms class="w-full h-full flex flex-col relative z-10">
                <header id="dashboard" class="w-full p-3 glass-panel shadow-lg z-20 border-t-0 rounded-b-2xl mb-1">
                    <div class="flex justify-between items-center mb-2">
                        <!-- v10.139: SCORE 하드코딩 -->
                        <div class="text-left flex-shrink-0"><span class="text-xs text-gray-400 font-bold tracking-widest" id="score-anchor">SCORE</span><span class="text-2xl font-bold text-yellow-300 ml-2 text-glow-sm" x-text="score"></span></div>
                        <div class="text-center flex-grow px-2"><div class="flex justify-center items-center space-x-2">
                            <template x-if="timePlusLevel > 0"><span class="text-lg filter drop-shadow-lg" title="TIME+ (시간 연장)">⏳</span></template>
                            <template x-if="scanLevel > 0"><span class="text-lg filter drop-shadow-lg" title="SCAN (생일 힌트)">🎨</span></template>
                            <template x-if="amuletLevel > 0"><span class="text-lg filter drop-shadow-lg" title="AMULET (달의 부적)">🌙</span></template>
                            <template x-if="assistLevel > 0"><span class="text-lg filter drop-shadow-lg" title="ASSIST (친구 호출)">🤝</span></template>
                        </div></div>
                        <!-- v10.111: STAGE N / OVERTIME 표시 -->
                        <div class="text-right flex-shrink-0">
                            <span class="text-xs text-gray-400 mr-2 font-bold tracking-widest" x-text="stage >= 11 ? 'OVERTIME' : `STAGE ${stage}`"></span>
                            <span class="text-xl font-bold text-cyan-300 text-glow-sm" x-text="`${blocksCompleted} / ${totalBlocksPerStage}`"></span>
                        </div>
                    </div>
                    <div class="flex items-center w-full space-x-3">
                        <div class="flex-grow bg-black/50 rounded-full h-2 border border-white/10 overflow-hidden"><div class="bg-gradient-to-r from-red-600 to-pink-500 h-full rounded-full transition-all duration-100 ease-linear" :style="currentBlock ? `width: ${(currentBlock.timer / currentBlock.timeLimit) * 100}%` : 'width: 100%'"></div></div>
                        <span class="text-lg font-bold text-pink-400 text-glow-sm w-8 text-right" x-text="currentBlock ? Math.ceil(currentBlock.timer / 1000) : '..'"></span>
                    </div>
                </header>

                <div id="order-area" class="w-full flex-shrink-0 p-2 glass-panel my-1 rounded-2xl relative">
                    <template x-if="chainCount > 0"><div class="absolute top-2 right-3 flex flex-col items-end z-10"><span class="text-cyan-400 text-xs font-bold tracking-widest animate-pulse mb-0 leading-none">⛓️ CHAIN</span><span class="text-yellow-300 text-2xl font-black text-glow-sm leading-none" x-text="chainCount"></span></div></template>
                    <div class="flex items-center justify-center space-x-2 h-16" id="boss-block-anchor">
                        <template x-if="!currentBlock && blocksCompleted < totalBlocksPerStage"><div>
                            <!-- v10.138: 다국어 키로 대체 (동적 메시지 유지) -->
                            <span x-show="nextBlockWillBeBoss" class="text-red-400 font-bold animate-pulse text-xl font-mono text-glow-sm" x-text="translate('playing_next_block_boss')"></span>
                            <span x-show="!nextBlockWillBeBoss" class="text-xl text-gray-400 tracking-widest animate-pulse font-mono text-glow-sm" x-text="translate('playing_next_block_normal')"></span>
                        </div></template>
                        <!-- S-Number Block -->
                        <template x-if="currentBlock?.bundleType === 'sNumber'">
                            <template x-for="(member, index) in currentBlock?.members" :key="currentBlock.id + '_' + index">
                                <div x-data="objektCard(member)" class="flex-shrink-0 w-14 h-16 rounded-lg flex flex-col items-center justify-center p-1 shadow-lg border-2" 
                                     :class="[borderStyles, matchedOrderIndices[index] ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-green-400' : '']" 
                                     :style="cardStyles.background">
                                    <span class="text-xl font-extrabold" :style="cardStyles.text" x-text="member.sNumber"></span>
                                </div>
                            </template>
                        </template>
                        <!-- Birthday Block -->
                        <template x-if="currentBlock?.bundleType === 'birthday'">
                            <template x-for="(member, index) in currentBlock?.members" :key="currentBlock.id + '_' + index">
                                <div class="flex-shrink-0 w-14 h-16 rounded-lg flex flex-col items-center justify-center p-1 shadow-lg border-2" 
                                     :class="matchedOrderIndices[index] ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-green-400' : ''" 
                                     :style="getBirthdayBackground(member)">
                                    <span class="font-extrabold" style="color: #000000;" :class="member.birthday.length > 4 ? 'text-base' : 'text-lg'" x-text="member.birthday"></span>
                                </div>
                            </template>
                        </template>
                        <!-- Dimension (Boss) Block - v10.123 Fix: optional chaining 추가 -->
                        <template x-if="currentBlock?.bundleType === 'dimension'">
                            <div x-data="{ 
                                 dimension: dimensionData.find(d => d.sNumber === currentBlock?.bundleLabel), 
                                 cardData: { 
                                     color: dimensionData.find(d => d.sNumber === currentBlock?.bundleLabel)?.color, 
                                     sNumber: currentBlock?.bundleLabel, 
                                     customTextColor: dimensionData.find(d => d.sNumber === currentBlock?.bundleLabel)?.textColor 
                                 } 
                             }" 
                                 class="flex-shrink-0 w-32 h-16 rounded-lg flex flex-col items-center justify-center p-1 shadow-lg border-2" 
                                 :class="{ 'boss-border': currentBlock?.isBoss }" 
                                 :style="`background-color: ${dimension?.color || '#FFFFFF'}; ${!currentBlock?.isBoss ? 'border-color: #A0A0A0' : ''}`">
                                <div x-data="objektCard(cardData)" class="flex flex-col items-center justify-center h-full">
                                    <span class="text-2xl font-extrabold" :style="cardStyles.text" x-text="currentBlock?.bundleLabel"></span>
                                    <span class="text-xs font-bold" :style="cardStyles.text" x-text="currentBlock?.members?.length ? `${currentBlock?.members?.length} Members` : ''"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div id="slot-line" class="w-full flex-shrink-0 p-2 mb-1 rounded-2xl glass-panel" style="background: rgba(0,0,0,0.5);">
                    <div class="flex space-x-2 overflow-x-auto scrollbar-thin h-24 items-center px-1">
                        <!-- v10.139: SLOTS: 하드코딩 -->
                        <template x-if="completedCards.length === 0 && currentBlock">
                            <div class="flex-shrink-0 w-16 h-20 bg-white/5 rounded-lg flex items-center justify-center border-2 border-dashed border-white/20">
                                <span class="text-gray-500 text-xs text-center p-1" x-text="'SLOTS: ' + (currentBlock?.members?.length || 0)"></span>
                            </div>
                        </template>
                        <template x-for="(card, index) in completedCards" :key="card.id">
                            <div x-data="objektCard(card, false)">
                                <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" 
                                     :class="[borderStyles, isMatchingOrder(card, index) ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-green-400' : '']" 
                                     :style="cardStyles.background">
                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-1">
                                        <span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span>
                                        <span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span>
                                    </div>
                                    <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'">
                                        <span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div id="collect-area" class="w-full flex-shrink-0 glass-panel p-2 mb-1 rounded-2xl">
                    <div class="flex space-x-2 overflow-x-auto scrollbar-thin h-24 items-center px-1">
                        <!-- v10.139: EMPTY COLLECT 하드코딩 -->
                        <template x-if="inventory.length === 0"><span class="text-gray-500 text-sm px-4 tracking-widest opacity-50">EMPTY COLLECT</span></template>
                        <template x-for="card in inventory" :key="card.inventoryId">
                            <button @click="selectInventoryCard(card)" class="relative transition-transform active:scale-95" 
                                        :class="{'ring-2 ring-offset-2 ring-offset-gray-900 ring-purple-500 rounded-lg': isSelectedInventory(card.inventoryId)}">
                                <div x-data="objektCard(card)">
                                    <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" 
                                        :class="borderStyles" 
                                        :style="cardStyles.background">
                                        <div class="flex-grow h-full flex flex-col items-center justify-center p-1">
                                            <span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span>
                                            <span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span>
                                        </div>
                                        <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'">
                                            <span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </template>
                    </div>
                </div>

                <div class="w-full px-1 py-2 grid grid-cols-2 gap-3">
                    <!-- v10.139: RELOAD 하드코딩 -->
                    <button @click="reloadData()" class="glass-button w-full py-4 text-xl font-bold rounded-2xl transition-all active:scale-95">
                        RELOAD
                        <span :class="getReloadDisplayColor()" x-text="`(${getReloadDisplayCount()})`"></span>
                    </button>
                    <!-- v10.139: INPUT 하드코딩 -->
                    <button @click="inputData()" :disabled="!inputEnabled()" 
                            :class="{ 'opacity-50 cursor-not-allowed': !inputEnabled(), 'btn-green-glow text-green-400': inputEnabled() }" 
                            class="glass-button w-full py-4 text-xl font-bold rounded-2xl transition-all active:scale-95">INPUT</button>
                </div>

                <div id="data-pool" class="w-full flex-grow grid grid-cols-2 gap-2 p-2 glass-panel rounded-t-2xl overflow-hidden border-b-0">
                    <div class="grid grid-cols-2 grid-rows-3 gap-2 h-full">
                        <template x-for="(data, index) in korData" :key="data.id">
                            <button @click="selectData('kor', data.name, data.id)" 
                                    :class="isSelectedData(data.id) ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-purple-500' : 'bg-white/5 hover:bg-white/10'" 
                                    class="w-full h-full flex items-center justify-center text-base font-medium rounded-xl shadow-sm transition-all transform active:scale-95 text-center p-1 border border-white/5 backdrop-blur-sm text-gray-200">
                                <span x-text="data.name"></span>
                            </button>
                        </template>
                    </div>
                    <div class="grid grid-cols-2 grid-rows-3 gap-2 h-full">
                        <template x-for="(data, index) in engData" :key="data.id">
                            <button @click="selectData('eng', data.name, data.id)" 
                                    :class="isSelectedData(data.id) ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-purple-500' : 'bg-white/5 hover:bg-white/10'" 
                                    class="w-full h-full flex items-center justify-center text-base font-medium rounded-xl shadow-sm transition-all transform active:scale-95 text-center p-1 border border-white/5 backdrop-blur-sm text-gray-200">
                                <span x-text="data.name"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div> 
            
            <!-- 4. Overlays -->
            <!-- Start Countdown -->
            <div x-show="isStarting" x-transition.opacity.duration.300ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/60 backdrop-blur-sm z-40">
                <!-- v10.111 재도입: STAGE N 또는 OVERTIME 표시 -->
                <span class="text-6xl font-black text-gray-100" :class="startCountdown === 'START!' ? 'countdown-zoom' : ''" x-text="startCountdown"></span>
            </div>
            
            <!-- Transition Blackout Screen -->
            <div x-show="gameState === 'transition'" x-transition.opacity.duration.50ms class="absolute inset-0 w-full h-full bg-black z-50"></div>

            
            <!-- Score Submit -->
            <div x-show="gameState === 'submitScore'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center p-8 z-50 bg-black/80 backdrop-blur-md">
                <div class="glass-panel p-8 rounded-3xl w-full flex flex-col items-center">
                    <!-- v10.139: NEW HIGH SCORE! 하드코딩 -->
                    <h2 class="text-4xl font-bold text-yellow-300 text-glow-sm text-center mb-4">NEW HIGH SCORE!</h2>
                    <!-- v10.111: stage > 10 대신 stage === 11 사용 -->
                    <template x-if="stage === 10 && previousGameState === 'ending'">
                        <div>
                            <!-- v10.139: All Stages Clear! 하드코딩 -->
                            <p class="text-2xl text-gray-300 text-center mb-2">All Stages Clear!</p>
                            <p class="text-6xl font-black text-white text-center mb-8 text-glow" x-text="totalScore"></p>
                        </div>
                    </template>
                    <template x-if="stage === 11">
                        <div>
                            <!-- v10.139: OVERTIME Clear! 하드코딩 -->
                            <p class="text-2xl text-gray-300 text-center mb-2">OVERTIME Clear!</p>
                            <p class="text-6xl font-black text-white text-center mb-8 text-glow" x-text="lastStageScore"></p>
                        </div>
                    </template>
                    <!-- v10.139: NAME (3 CHARS) 하드코딩 -->
                    <label for="playerNameInput" class="text-lg text-gray-400 mb-2 tracking-widest">NAME (3 CHARS)</label>
                    <input type="text" id="playerNameInput" x-model="playerName" @input="playerName = playerName.toUpperCase().replace(/[^A-Z0-9]/g, '')" maxlength="3" class="w-40 h-20 bg-black/50 border-2 border-white/20 text-white text-5xl font-bold text-center rounded-2xl focus:outline-none focus:border-purple-500 mb-8 tracking-widest">
                    <!-- v10.139: SUBMIT 하드코딩 -->
                    <button @click="submitScore()" class="glass-button btn-green-glow w-full py-4 text-2xl font-bold rounded-2xl text-green-400">SUBMIT</button>
                </div>
            </div>

            <!-- Intermission -->
            <!-- v10.111: stage 값 변경으로 인한 깜빡임 방지 위해 x-cloak 추가 -->
            <div x-show="gameState === 'intermission'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col p-4 z-50 bg-black/80 backdrop-blur-md" x-cloak>
                <div class="flex-grow overflow-y-auto scrollbar-thin space-y-6 pb-4">
                    <!-- Report Panel -->
                    <div id="report" class="glass-panel p-5 rounded-3xl relative overflow-hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold" :class="lastStageGrade === 'F' ? 'text-red-400 text-glow-sm' : 'text-green-400 text-glow-sm'">
                                <!-- v10.140: 하드코딩으로 변경 -->
                                <span x-show="stage < 11" x-text="`STAGE ${stage - 1} CLEAR!`"></span>
                                <span x-show="stage === 11" x-text="'OVERTIME CLEAR!'"></span>
                            </h2>
                            <!-- 랭킹 및 설정 버튼 그룹 (v10.121: 크기 축소 및 간격 조정) -->
                            <div class="flex space-x-1.5">
                                <button @click="showRanking()" class="glass-button p-1 rounded-full" title="REKORD">🏆</button>
                                <button @click="showSettings()" class="glass-button p-1 rounded-full" title="CONFIG">⚙️</button>
                            </div>
                        </div>
                        <div class="flex justify-around items-center text-gray-300 mb-6">
                            <!-- v10.139: TOTAL SCORE 하드코딩 -->
                            <div class="flex flex-col items-center"><span class="text-xs text-gray-500 font-bold tracking-widest mb-1">TOTAL SCORE</span><span class="text-xl font-bold text-yellow-300" x-text="totalScore"></span></div>
                            <!-- v10.139: RANK 하드코딩 -->
                            <div class="flex flex-col items-center mx-2"><span class="text-xs text-gray-500 font-bold tracking-widest mb-1">RANK</span><span class="text-5xl font-black" :class="{'text-yellow-300 text-glow': lastStageGrade === 'S', 'text-green-400 text-glow-sm': lastStageGrade === 'A', 'text-blue-400 text-glow-sm': lastStageGrade === 'B', 'text-gray-500': lastStageGrade === 'C', 'text-red-500 text-glow': lastStageGrade === 'F'}" x-text="lastStageGrade"></span></div>
                            <!-- v10.139: STAGE SCORE 하드코딩 -->
                            <div class="flex flex-col items-center"><span class="text-xs text-gray-500 font-bold tracking-widest mb-1">STAGE SCORE</span><span class="text-xl font-bold text-white" x-text="lastStageScore"></span></div>
                        </div>
                        <hr class="border-white/10 my-4">
                        <div class="relative pl-3">
                            <!-- F 등급 시 왼쪽 바 흰색으로 변경 -->
                            <div class="absolute top-0 left-0 w-1 h-full" :class="lastStageGrade === 'F' ? 'bg-white' : 'bg-yellow-500'" rounded-full></div>
                            <p class="text-sm font-bold tracking-widest mb-1 flex items-center" :class="lastStageGrade === 'F' ? 'text-white' : 'text-yellow-500'">
                                <!-- v10.139: BOSS J'S COMMENT / MH MESSAGE 하드코딩 -->
                                <span x-text="lastStageGrade === 'F' ? 'MH MESSAGE' : 'BOSS J\'S COMMENT'"></span>
                                <!-- F 등급 시 이모지 변경 (💀 -> ✉️) -->
                                <span class="ml-2 text-xl" x-text="lastStageGrade === 'S' ? '😏' : (lastStageGrade === 'A' ? '🙂' : (lastStageGrade === 'B' ? '😐' : (lastStageGrade === 'C' ? '😠' : '✉️')))"></span>
                                <!-- F 등급 시 EARNED 부분 삭제 -->
                                <span class="ml-auto font-bold" x-show="lastStageGrade !== 'F'"><span class="text-purple-300">EARNED:</span><span class="text-white" x-text="comoEarned"></span><span x-show="bonusComo > 0" class="text-green-400" x-text="`+${bonusComo}`"></span></span>
                            </p>
                            <!-- v10.138: 보스 코멘트는 다국어 키를 통해 translate 함수를 거쳐 표시됨 -->
                            <template x-if="lastStageGrade === 'F'">
                                <p class="text-lg text-gray-200 italic font-bold" x-text="bossJComment"></p>
                            </template>
                            <template x-if="lastStageGrade !== 'F'">
                                <p class="text-lg text-gray-200 italic" x-text="`&quot;${bossJComment}&quot;`"></p>
                            </template>
                        </div>
                    </div>
                    <!-- Shop Panel -->
                    <div id="shop" class="relative">
                        <div class="flex justify-between items-center mb-3 px-2">
                            <!-- v10.139: SHOP 하드코딩 -->
                            <h3 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">SHOP</h3>
                            <div class="glass-panel px-4 py-1 rounded-full flex items-center"><span class="text-lg font-black text-purple-300 mr-2">COMO</span><span class="text-lg font-bold text-white" x-text="como"></span></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <!-- Shop Item Buttons: disabled 속성 추가 (로직은 openShopModal에서 처리) -->
                            <button @click="openShopModal('objekt')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < 1}"><span class="text-3xl">🃏</span><div class="flex flex-col"><span class="font-bold text-sm text-gray-200 leading-none mb-1">OBJEKT</span><span class="text-xs font-bold" :class="como < 1 ? 'text-red-400' : 'text-purple-300'">1 COMO</span></div></button>
                            <!-- v10.139: MAX 하드코딩 -->
                            <button @click="openShopModal('reload')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < 1, 'border-yellow-500/50': reloadBoost >= 20}"><span class="text-3xl">🔄</span><div class="flex flex-col"><span class="font-bold text-sm text-gray-200 leading-none mb-1">RELOAD</span><span class="text-xs font-bold" :class="reloadBoost >= 20 ? 'text-yellow-500' : 'text-purple-300'" x-text="reloadBoost >= 20 ? 'MAX' : '1 COMO'"></span></div></button>
                            
                            <!-- TIME+ / SCAN (NEW: stage >= 5) -->
                            <!-- v10.139: MAX 하드코딩 -->
                            <template x-if="stage >= 5"><button @click="openShopModal('timePlus')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < 4, 'border-green-500/50': timePlusLevel >= 1}"><span class="text-3xl">⏳</span><div class="flex flex-col"><span class="font-bold text-sm text-gray-200 leading-none mb-1">TIME+</span><span class="text-xs font-bold" :class="timePlusLevel >= 1 ? 'text-green-500' : 'text-purple-300'" x-text="timePlusLevel >= 1 ? 'MAX' : '4 COMO'"></span></div></button></template>
                            <!-- v10.139: MAX 하드코딩 -->
                            <template x-if="stage >= 5"><button @click="openShopModal('scan')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < 3, 'border-orange-500/50': scanLevel >= 1}"><span class="text-3xl">🎨</span><div class="flex flex-col"><span class="font-bold text-sm text-gray-200 leading-none mb-1">SCAN</span><span class="text-xs font-bold" :class="scanLevel >= 1 ? 'text-orange-500' : 'text-purple-300'" x-text="scanLevel >= 1 ? 'MAX' : '3 COMO'"></span></div></button></template>
                            
                            <!-- AMULET / ASSIST (NEW: stage >= 7) -->
                            <!-- v10.139: MAX 하드코딩 -->
                            <template x-if="stage >= 7"><button @click="openShopModal('amulet')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < 2, 'border-purple-500/50': amuletLevel >= 1}"><span class="text-3xl">🌙</span><div class="flex flex-col"><span class="font-bold text-sm text-gray-200 leading-none mb-1">AMULET</span><span class="text-xs font-bold" :class="amuletLevel >= 1 ? 'text-purple-500' : 'text-purple-300'" x-text="amuletLevel >= 1 ? 'MAX' : '2 COMO'"></span></div></button></template>
                            <!-- v10.139: MAX 하드코딩 -->
                            <template x-if="stage >= 7"><button @click="openShopModal('assist')" class="glass-button p-2 rounded-2xl flex items-center space-x-2 text-left" :class="{'opacity-50': como < 4, 'border-cyan-500/50': assistLevel >= 1}"><span class="text-3xl">🤝</span><div class="flex flex-col"><span class="font-bold text-sm text-gray-200 leading-none mb-1">ASSIST</span><span class="text-xs font-bold" :class="assistLevel >= 1 ? 'text-cyan-500' : 'text-purple-300'" x-text="assistLevel >= 1 ? 'MAX' : '4 COMO'"></span></div></button></template>
                        </div>
                    </div>
                    <!-- Collect Panel -->
                    <div id="collect" class="glass-panel p-3 rounded-2xl">
                        <div class="flex justify-between items-center mb-3 px-1">
                            <h3 class="text-lg font-bold text-gray-300 tracking-wider">COLLECT (<span x-text="inventory.length"></span>/<span x-text="inventoryMaxSize"></span>)</h3>
                             <div class="flex justify-center items-center space-x-2 opacity-80">
                                <template x-if="timePlusLevel > 0"><span class="text-lg filter drop-shadow-lg" title="TIME+">⏳</span></template>
                                <template x-if="scanLevel > 0"><span class="text-lg filter drop-shadow-lg" title="SCAN">🎨</span></template>
                                <template x-if="amuletLevel > 0"><span class="text-lg filter drop-shadow-lg" title="AMULET">🌙</span></template>
                                <template x-if="assistLevel > 0"><span class="text-lg filter drop-shadow-lg" title="ASSIST">🤝</span></template>
                             </div>
                        </div>
                        <div class="flex space-x-2 overflow-x-auto scrollbar-thin h-24 items-center mb-3 px-1">
                            <!-- v10.139: EMPTY COLLECT 하드코딩 -->
                            <template x-if="inventory.length === 0"><span class="text-gray-500 text-sm px-4 tracking-widest opacity-50">EMPTY COLLECT</span></template>
                            <template x-for="card in inventory" :key="card.inventoryId">
                                <button @click="selectInventoryCard(card)" class="relative transition-transform active:scale-95" 
                                        :class="{'ring-2 ring-offset-2 ring-offset-gray-900 ring-purple-500 rounded-lg': isSelectedInventory(card.inventoryId)}">
                                    <div x-data="objektCard(card)">
                                        <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" 
                                            :class="borderStyles" 
                                            :style="cardStyles.background">
                                            <div class="flex-grow h-full flex flex-col items-center justify-center p-1">
                                                <span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span>
                                                <span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span>
                                            </div>
                                            <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'">
                                                <span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span>
                                            </div>
                                        </div>
                                    </div>
                                </button>
                            </template>
                        </div>
                        <template x-if="stage >= 4">
                            <div class="grid grid-cols-2 gap-3">
                                <button @click="startSpin()" :disabled="!selectedInventoryCard || intermissionSpinCount >= 3" 
                                        class="glass-button py-3 text-pink-400 font-bold rounded-xl" 
                                        :class="{'opacity-50': !selectedInventoryCard || intermissionSpinCount >= 3, 'btn-red-glow': selectedInventoryCard && intermissionSpinCount < 3}">
                                    SPIN 🎟️<span x-text="3 - intermissionSpinCount"></span>
                                </button>
                                <button @click="startGridCraft()" :disabled="!canCraft()" 
                                        class="glass-button py-3 text-teal-400 font-bold rounded-xl" 
                                        :class="{'opacity-50': !canCraft(), 'btn-green-glow': canCraft()}">
                                    GRID
                                </button>
                            </div>
                        </template>
                    </div>
                    <!-- Gravity Panel -->
                    <template x-if="stage >= 6 && stageConfig[Math.min(stage - 1, stageConfig.length - 1)].bosses.length > 0 && bossPools[stageConfig[Math.min(stage - 1, stageConfig.length - 1)].bosses[0]]">
                        <div id="gravity" class="glass-panel p-4 rounded-2xl relative">
                            <h3 class="text-lg font-bold text-cyan-400 mb-2 tracking-wider">GRAVITY</h3>
                            <!-- v10.142: 다국어 키 통합 및 Stage N 로직으로 통합 (Overtime = Stage 11) -->
                            <p class="text-sm text-gray-400 mb-3">
                                <!-- Stage 6 이상일 경우: Stage 번호 포함 표시 (11일 경우 'Stage 11'로 표시됨) -->
                                <span x-show="stage >= 6" x-text="`${translate('gravity_desc_prefix')} ${translate('gravity_desc_stage')} ${stage} ${translate('gravity_desc_suffix')}`"></span>
                            </p>
                            <div class="grid grid-cols-2 gap-2">
                                <template x-for="bossName in getGravityVotes(stageConfig[Math.min(stage - 1, stageConfig.length - 1)].bosses[0])" :key="bossName">
                                    <!-- F 등급 시 투표 버튼 비활성화 (버튼 자체는 클릭 방지) -->
                                    <button @click="voteForBoss(bossName)" class="glass-button p-3 rounded-xl flex flex-col justify-center items-center space-y-1">
                                        <span class="text-lg font-bold text-white" x-text="bossName"></span>
                                        <span class="font-bold text-cyan-300 text-sm">
                                            <span x-text="`${(gravityVotes[bossName] || 0)}표`"></span>
                                            <span class="text-gray-400 ml-1" x-text="`(${getBossProbability(bossName, stageConfig[Math.min(stage - 1, stageConfig.length - 1)].bosses[0])}%)`"></span>
                                        </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
               <!-- Bottom Navigation (Fixed) -->
                <div class="flex-shrink-0 pt-2 bg-black/20 backdrop-blur-md -mx-4 px-4 -mb-4 pb-2 rounded-t-xl z-20">
                    <div class="grid grid-cols-2 gap-4">
                        <!-- v10.139: RETURN 하드코딩 -->
                        <button @click="confirmReturn()" class="glass-button w-full py-4 text-2xl font-bold rounded-2xl text-gray-400 hover:text-white">RETURN</button>
                        <!-- v10.139: NEXT 하드코딩 -->
                        <button @click="handleIntermissionNext()" 
                                :disabled="lastStageGrade === 'F'"
                                class="glass-button w-full py-4 text-2xl font-bold rounded-2xl relative" 
                                :class="{
                                    'opacity-50 cursor-not-allowed text-gray-400 hover:text-gray-400': lastStageGrade === 'F', /* F등급 시 색상 고정 및 비활성화 */
                                    'btn-green-glow text-green-400': lastStageGrade !== 'F'
                                }">
                            NEXT
                            <!-- v10.156: F 등급일 때 자물쇠 이모지 오버레이 -->
                            <template x-if="lastStageGrade === 'F'">
                                <span class="absolute inset-0 flex items-center justify-center z-10">
                                    <span class="text-4xl filter drop-shadow-xl">🔒</span>
                                </span>
                            </template>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Unlock Modal (New Feature Notification ONLY) -->
            <div x-show="unlockModal.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[60] p-6" @click="closeUnlockModal()">
                <div class="glass-panel p-6 rounded-3xl text-center border border-purple-500/50 shadow-[0_0_30px_rgba(168,85,247,0.3)] unlock-bounce max-w-sm" @click.stop>
                    <h3 class="text-3xl font-black text-yellow-300 mb-4" x-text="unlockModal.title"></h3>
                    <p class="text-xl text-gray-200 whitespace-pre-line mb-8" x-text="unlockModal.message"></p>
                    <button @click="closeUnlockModal()" class="glass-button px-8 py-3 text-purple-300 text-xl font-bold rounded-xl hover:text-white hover:border-purple-400">OK</button>
                </div>
            </div>

            <!-- Return Confirm Modal -->
            <div x-show="returnConfirmModal.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[65] p-6" @click="cancelReturn()">
                <div class="glass-panel p-6 rounded-3xl text-center border border-red-500/50 shadow-2xl max-w-sm w-full" @click.stop>
                    <!-- v10.138: 다국어 키로 대체 (경고 메시지는 번역) -->
                    <h3 class="text-2xl font-black text-red-400 mb-4" x-text="translate('confirm_return_title')"></h3>
                    <p class="text-lg text-gray-200 mb-8 whitespace-pre-line" x-text="translate('confirm_return_msg')"></p>
                    <div class="grid grid-cols-2 gap-3">
                        <!-- v10.143: CANCEL을 BACK으로 변경 -->
                        <button @click="cancelReturn()" class="glass-button py-3 text-gray-300 font-bold rounded-xl">BACK</button>
                        <!-- v10.139: RETURN 하드코딩 (유지) -->
                        <button @click="restartGame()" class="glass-button py-3 font-bold rounded-xl text-red-400 border-red-500/50">RETURN</button>
                    </div>
                </div>
            </div>
            
            <!-- Reset Confirm Modal (New) -->
            <div x-show="resetConfirmModal.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[65] p-6" @click="cancelReset()">
                <div class="glass-panel p-6 rounded-3xl text-center border border-red-500/50 shadow-2xl max-w-sm w-full" @click.stop>
                    <h3 class="text-2xl font-black text-red-400 mb-4">⚠️ DATA RESET WARNING</h3>
                    <template x-if="resetConfirmModal.type === 'ranking'">
                        <p class="text-lg text-gray-200 mb-8">모든 랭킹 기록(<span class="text-yellow-300">STANDARD</span>, <span class="text-teal-300">OVERTIME</span>)이 영구적으로 삭제됩니다. 계속하시겠습니까?</p>
                    </template>
                    <template x-if="resetConfirmModal.type === 'all'">
                        <p class="text-lg text-gray-200 mb-8">인벤토리, 코모, 아이템 레벨, 현재 시즌 정보 등 <span class="text-red-400 font-bold">랭킹을 제외한 모든 진행 상황</span>이 초기화됩니다. 계속하시겠습니까?</p>
                    </template>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <!-- v10.143: CANCEL을 BACK으로 변경 -->
                        <button @click="cancelReset()" class="glass-button py-3 text-gray-300 font-bold rounded-xl">BACK</button>
                        <button @click="executeReset()" class="glass-button py-3 font-bold rounded-xl text-red-400 border-red-500/50">RESET</button>
                    </div>
                </div>
            </div>

            <!-- Ranking Screen -->
            <div x-show="gameState === 'ranking'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-between p-4 z-50 overflow-y-auto bg-black/80 backdrop-blur-md">
                <div>
                    <!-- v10.139: REKORD ARCHIVE 하드코딩 -->
                    <h2 class="text-4xl font-black text-center mt-6 mb-2 text-white">REKORD ARCHIVE</h2>
                    <!-- 시즌 표시 수정: 'SEASON' 문구 삭제 -->
                    <div class="text-center mb-6">
                        <span class="text-lg font-black tracking-widest text-glow-sm" 
                              :style="`color: ${getCurrentSeasonColor()}; text-shadow: 0 0 10px ${getCurrentSeasonColor()}80;`"
                              x-text="currentSeason.name">
                        </span>
                    </div>
                    <div class="flex w-full mb-4 rounded-xl glass-panel p-1">
                        <button @click="rankingTab = 'main'" class="w-1/2 py-3 rounded-xl text-lg font-bold transition-all" :class="rankingTab === 'main' ? 'bg-purple-600/80 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'">STANDARD</button>
                        <button @click="rankingTab = 'extra'" class="w-1/2 py-3 rounded-xl text-lg font-bold transition-all" :class="rankingTab === 'extra' ? 'bg-teal-600/80 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'">OVERTIME</button>
                    </div>
                    <div x-show="rankingTab === 'main'" class="space-y-1">
                        <!-- v10.139: NO REKORD 하드코딩 -->
                        <template x-if="highScores.length === 0"><p class="text-center text-gray-500 text-lg py-8">NO REKORD</p></template>
                        <template x-for="(entry, index) in highScores" :key="entry.name + entry.score + index">
                            <div>
                                <div class="flex items-center justify-between glass-panel p-4 rounded-2xl text-lg z-10 relative">
                                    <div class="flex items-center">
                                        <span class="font-bold w-8 text-left" :class="{'text-yellow-300 text-glow-sm': index === 0, 'text-gray-300': index === 1, 'text-yellow-700': index === 2, 'text-gray-600': index > 2}" x-text="`${index + 1}.`"></span>
                                        <span class="font-bold text-xl text-white ml-2" x-text="entry.name"></span>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-xl text-yellow-300" x-text="entry.score"></span>
                                        <!-- v10.111-S: 랭킹 항목에 시즌 정보 표시 -->
                                        <span class="text-xs text-gray-500 block" x-text="entry.season ? `SEASON: ${entry.season}` : ''"></span>
                                    </div>
                                </div>
                                <!-- 랭킹 항목 상세 정보 (아이템, 스페셜 카드) -->
                                <div x-show="(entry.items && (entry.items.reload > 0 || entry.items.time > 0 || entry.items.scan > 0 || entry.items.amulet > 0 || entry.items.assist > 0)) || (entry.specialCards && entry.specialCards.length > 0)"
                                     class="glass-panel p-3 rounded-b-2xl -mt-2 z-0 bg-black/30 border-t-0 border-white/10">
                                    <!-- 보유 아이템 -->
                                    <div class="flex items-center space-x-2 mb-2 px-1" x-show="entry.items && (entry.items.reload > 0 || entry.items.time > 0 || entry.items.scan > 0 || entry.items.amulet > 0 || entry.items.assist > 0)">
                                        <template x-if="entry.items.reload > 0"><span class="text-base" x-text="`🔄(${entry.items.reload})`" title="RELOAD"></span></template>
                                        <template x-if="entry.items.time > 0"><span class="text-base" title="TIME+">⏳</span></template>
                                        <template x-if="entry.items.scan > 0"><span class="text-base" title="SCAN">🎨</span></template>
                                        <template x-if="entry.items.amulet > 0"><span class="text-base" title="AMULET">🌙</span></template>
                                        <template x-if="entry.items.assist > 0"><span class="text-base" title="ASSIST">🤝</span></template>
                                    </div>
                                    <!-- 보유 스페셜 카드 (미니) -->
                                    <div x-show="entry.specialCards && entry.specialCards.length > 0" class="flex flex-wrap gap-1 px-1">
                                        <template x-for="card in entry.specialCards" :key="card.inventoryId || card.sNumber">
                                            <div x-data="objektCard(card, false)">
                                                <div class="w-8 h-10 rounded-md flex shadow-sm border" :class="borderStyles" :style="`${cardStyles.background}; border-width: 1px;`">
                                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-0">
                                                        <span class="text-xs font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span>
                                                    </div>
                                                    <div class="flex-shrink-0 w-1/5 h-full flex items-center justify-center rounded-r-sm holo-bg">
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="rankingTab === 'extra'" class="space-y-1">
                        <!-- v10.139: NO REKORD 하드코딩 -->
                        <template x-if="extraHighScores.length === 0"><p class="text-center text-gray-500 text-lg py-8">NO REKORD</p></template>
                        <template x-for="(entry, index) in extraHighScores" :key="entry.name + entry.score + index">
                            <div>
                                <div class="flex items-center justify-between glass-panel p-4 rounded-2xl text-lg z-10 relative">
                                    <div class="flex items-center">
                                        <span class="font-bold w-8 text-left" :class="{'text-yellow-300 text-glow-sm': index === 0, 'text-gray-300': index === 1, 'text-yellow-700': index === 2, 'text-gray-600': index > 2}" x-text="`${index + 1}.`"></span>
                                        <span class="font-bold text-xl text-white ml-2" x-text="entry.name"></span>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-xl text-teal-300" x-text="entry.score"></span>
                                        <!-- v10.111-S: 랭킹 항목에 시즌 정보 표시 -->
                                        <span class="text-xs text-gray-500 block" x-text="entry.season ? `SEASON: ${entry.season}` : ''"></span>
                                    </div>
                                </div>
                                <!-- 랭킹 항목 상세 정보 (아이템, 스페셜 카드) -->
                                <div x-show="(entry.items && (entry.items.reload > 0 || entry.items.time > 0 || entry.items.scan > 0 || entry.items.amulet > 0 || entry.items.assist > 0)) || (entry.specialCards && entry.specialCards.length > 0)"
                                     class="glass-panel p-3 rounded-b-2xl -mt-2 z-0 bg-black/30 border-t-0 border-white/10">
                                    <!-- 보유 아이템 -->
                                    <div class="flex items-center space-x-2 mb-2 px-1" x-show="entry.items && (entry.items.reload > 0 || entry.items.time > 0 || entry.items.scan > 0 || entry.items.amulet > 0 || entry.items.assist > 0)">
                                        <template x-if="entry.items.reload > 0"><span class="text-base" x-text="`🔄(${entry.items.reload})`" title="RELOAD"></span></template>
                                        <template x-if="entry.items.time > 0"><span class="text-base" title="TIME+">⏳</span></template>
                                        <template x-if="entry.items.scan > 0"><span class="text-base" title="SCAN">🎨</span></template>
                                        <template x-if="entry.items.amulet > 0"><span class="text-base" title="AMULET">🌙</span></template>
                                        <template x-if="entry.items.assist > 0"><span class="text-base" title="ASSIST">🤝</span></template>
                                    </div>
                                    <!-- 보유 스페셜 카드 (미니) -->
                                    <div x-show="entry.specialCards && entry.specialCards.length > 0" class="flex flex-wrap gap-1 px-1">
                                        <template x-for="card in entry.specialCards" :key="card.inventoryId || card.sNumber">
                                            <div x-data="objektCard(card, false)">
                                                <div class="w-8 h-10 rounded-md flex shadow-sm border" :class="borderStyles" :style="`${cardStyles.background}; border-width: 1px;`">
                                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-0">
                                                        <span class="text-xs font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span>
                                                    </div>
                                                    <div class="flex-shrink-0 w-1/5 h-full flex items-center justify-center rounded-r-sm holo-bg">
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                <!-- REKORD 화면 하단 버튼 영역에 공통 구조 적용 -->
                <div class="flex-shrink-0 pt-2 bg-black/20 backdrop-blur-md -mx-4 px-4 -mb-4 pb-2 rounded-t-xl z-20">
                    <!-- v10.144: RETURN을 BACK으로 변경 -->
                    <button @click="gameState = previousGameState" class="glass-button w-full py-4 text-2xl font-bold rounded-2xl text-white">BACK
                    </button>
                </div>
            </div>
            
            <!-- Settings Screen (New) -->
            <div x-show="gameState === 'settings'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-between p-4 z-50 overflow-y-auto bg-black/80 backdrop-blur-md">
                <div class="flex-grow">
                    <h2 class="text-4xl font-black text-center mt-6 mb-8 text-cyan-400 text-glow-sm">SYSTEM CONFIG</h2>
                    
                    <!-- LANGUAGE SECTION (다국어 선택 드롭다운) - (이동됨) -->
                    <div class="glass-panel p-5 rounded-2xl mb-6">
                        <h3 class="text-xl font-bold text-gray-300 mb-4" x-text="translate('lang_select')"></h3>
                        <p class="text-sm text-gray-400 mb-4" x-text="translate('lang_desc')"></p>
                        
                        <div class="relative">
                            <select @change="setLanguage($event.target.value)" 
                                    class="w-full bg-black/40 border border-white/20 text-white py-3 px-4 rounded-xl text-lg font-bold appearance-none pr-10 focus:outline-none focus:ring-2 focus:ring-purple-500" 
                                    :value="currentLang">
                                <!-- 현재 지원하는 언어 목록을 드롭다운 옵션으로 표시 -->
                                <template x-for="lang in supportedLangs" :key="lang.code">
                                    <option :value="lang.code" x-text="lang.name"></option>
                                </template>
                                <!-- 임시로 더미 언어 추가 (더 많은 언어를 지원할 경우의 예시) -->
                                <option value="ja">日本語 (Japanese) (Dummy)</option>
                                <option value="zh">中文 (Chinese) (Dummy)</option>
                                <option value="es">Español (Spanish) (Dummy)</option>
                            </select>
                            <!-- 커스텀 드롭다운 화살표 -->
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                                <svg class="fill-current h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VOLUME SECTION - (이동됨) -->
                    <div class="glass-panel p-5 rounded-2xl mb-6">
                        <h3 class="text-xl font-bold text-gray-300 mb-4 flex items-center">VOLUME CONTROL</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-base font-bold text-gray-400 mb-2 flex items-center">BGM VOLUME <span class="ml-auto text-cyan-300" x-text="`${Math.round(bgmVolume * 100)}%`"></span></h4>
                                <input type="range" min="0" max="1" step="0.05" :value="bgmVolume" @input="updateBGMVolume" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50">
                            </div>
                            <div>
                                <h4 class="text-base font-bold text-gray-400 mb-2 flex items-center">SFX VOLUME <span class="ml-auto text-cyan-300" x-text="`${Math.round(sfxVolume * 100)}%`"></span></h4>
                                <input type="range" min="0" max="1" step="0.05" :value="sfxVolume" @input="updateSFXVolume" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50">
                            </div>
                        </div>
                    </div>

                </div>

                <p class="text-center text-gray-500 text-xs mt-4 mb-2 px-4 opacity-70 flex-shrink-0">This is an unofficial fan game. All original IPs belong to MODHAUS.</p>
                
                <!-- Bottom Navigation (Fixed) -->
                <div class="flex-shrink-0 pt-2 bg-black/20 backdrop-blur-md -mx-4 px-4 -mb-4 pb-2 rounded-t-xl z-20">
                    <!-- v10.144: RETURN을 BACK으로 변경 -->
                    <button @click="gameState = previousGameState; saveSettings()" class="glass-button w-full py-4 text-2xl font-bold rounded-2xl text-white">BACK
                    </button>
                </div>
            </div>

            <!-- Ending Screen -->
            <div x-show="gameState === 'ending'" x-transition.opacity.duration.500ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center p-8 z-50 text-center bg-black/80 backdrop-blur-md relative ending-screen-overlay">
                <!-- Title with Rank-based Glow and Animation -->
                <!-- v10.138: 다국어 키로 대체 -->
                <h2 class="text-5xl font-black text-glow mb-6 ending-rank-glow" 
                    :class="[ENDING_MESSAGES[endingType]?.theme || 'text-white', 'ending-rank-glow']" 
                    x-text="translate(ENDING_MESSAGES[endingType]?.title)">
                </h2>
                <!-- v10.138: 다국어 키로 대체 -->
                <p class="text-xl text-gray-300 whitespace-pre-line mb-8" x-text="translate(ENDING_MESSAGES[endingType]?.desc)"></p>
                <!-- Score Panel with Dynamic Border Color -->
                <div class="glass-panel p-8 rounded-3xl mb-12 w-full border-4 transition-colors duration-500" 
                     :class="{
                         'border-yellow-300 shadow-[0_0_25px_rgba(253,224,71,0.5)]': endingType === 'S',
                         'border-green-400 shadow-[0_0_20px_rgba(52,211,153,0.4)]': endingType === 'A',
                         'border-blue-400 shadow-[0_0_15px_rgba(96,165,250,0.3)]': endingType === 'B',
                         'border-gray-500 shadow-none': endingType === 'C',
                         'border-red-400 shadow-[0_0_20px_rgba(239,68,68,0.5)]': endingType === 'F'
                     }">
                    <p class="text-sm text-gray-500 font-bold tracking-widest mb-2">FINAL TOTAL SCORE</p>
                    <p class="text-7xl font-black text-yellow-300 text-glow" x-text="finalScore"></p>
                </div>
                <!-- F 등급 엔딩일 경우 CONTINUE 버튼 숨김 -->
                <template x-if="endingType !== 'F'">
                    <!-- v10.139: CONTINUE (OVERTIME) 하드코딩 -->
                    <button @click="continueOvertime()" class="glass-button btn-green-glow w-full py-4 text-2xl font-bold rounded-2xl text-green-400 mb-4">CONTINUE (OVERTIME)</button>
                </template>
                <!-- v10.143: RESTART를 RETURN으로 변경 -->
                <button @click="restartGame()" class="glass-button w-full py-3 text-xl font-bold rounded-2xl text-gray-300 hover:text-white mb-4">RETURN</button>
                <!-- v10.139: VIEW REKORD 하드코딩 -->
                <button @click="showRanking()" class="glass-button btn-yellow-glow w-full py-3 text-xl font-bold rounded-2xl text-yellow-300">VIEW REKORD</button>
            </div>

            <!-- Spin Modal -->
            <div x-show="isSpinning" x-transition.opacity.duration.300ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center p-4 z-50 bg-black/70 backdrop-blur-sm">
                <h2 class="text-3xl font-bold text-pink-400 text-glow-sm mb-8" x-text="spinResult ? 'SPIN COMPLETE!' : (selectedInventoryCardForSpin ? `SPIN TARGET: ${selectedInventoryCardForSpin.sNumber}` : 'SPINNING...')"></h2>
                <div class="grid grid-cols-4 gap-3 p-4 glass-panel rounded-3xl">
                    <template x-for="card in spinGrid" :key="card.inventoryId">
                        <div class="w-16 h-20 perspective">
                            <div class="card-flip cursor-pointer" :class="{'is-flipped': spinResult}" @click="!spinResult ? selectSpinCard(card) : null">
                                <div class="card-face card-back rounded-lg border-2 border-gray-400">
                                    <div class="w-full h-full bg-gradient-to-bl from-[#0a0e17] via-[#0c1445] to-[#0a0e17] flex items-center justify-center">
                                        <span class="text-gray-300 text-3xl font-black opacity-50">//</span>
                                    </div>
                                </div>
                                <div class="card-face card-front" :class="{'ring-2 ring-offset-2 ring-offset-black ring-purple-500 rounded-lg': spinResult && spinResult.inventoryId === card.inventoryId}">
                                    <template x-if="card">
                                        <div x-data="objektCard(card)">
                                            <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" :class="borderStyles" :style="cardStyles.background">
                                                <div class="flex-grow h-full flex flex-col items-center justify-center p-1"><span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span><span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span></div>
                                                <!-- v10.127: 홀로그램 효과가 정상적으로 표시되도록 수정 -->
                                                <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'"><span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Grid Modal -->
            <div x-show="isCrafting" x-transition.opacity.duration.300ms class="absolute inset-0 w-full h-full flex flex-col justify-center items-center p-4 z-50 bg-black/70 backdrop-blur-sm">
                <h2 class="text-3xl font-bold text-teal-400 text-glow-sm mb-8" x-text="craftingCard ? `GRID: ${craftingCard?.sNumber}` : 'GRIDDING...'"></h2>
                <div class="craft-grid-container p-8 glass-panel rounded-full">
                    <template x-if="craftingCard">
                        <template x-for="i in 4" :key="i">
                            <div class="craft-card" :class="`craft-card-${i}`" x-data="objektCard(craftingCard)">
                                <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" :class="borderStyles" :style="cardStyles.background">
                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-1"><span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span><span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span></div>
                                    <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md"><span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span></div>
                                </div>
                            </div>
                        </template>
                    </template>
                    <template x-if="craftingCard">
                        <div class="craft-special-card">
                            <div x-data="objektCard({ ...craftingCard, isSpecial: true })">
                                <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" :class="borderStyles" :style="cardStyles.background">
                                    <div class="flex-grow h-full flex flex-col items-center justify-center p-1"><span class="text-lg font-extrabold" :style="cardStyles.text" x-text="card.sNumber"></span><span class="text-xs font-bold" :style="cardStyles.text" x-text="card.kor"></span></div>
                                    <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="card.isSpecial ? 'holo-bg' : 'bg-black/30'"><span class="text-xs font-bold text-white writing-mode-v-rl" x-text="card.eng"></span></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Feedback Popup -->
            <div x-show="feedback.show" 
                 x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" 
                 x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-4" 
                 class="absolute top-8 left-1/2 -translate-x-1/2 w-auto px-6 py-3 rounded-full shadow-2xl text-lg font-black z-[70] whitespace-nowrap backdrop-blur-md border-2" 
                 :class="{'bg-green-500/80 text-white border-green-400': feedback.type === 'correct', 'bg-red-500/80 text-white border-red-400': feedback.type === 'incorrect'}">
                <span x-text="feedback.message"></span>
            </div>

            <!-- Shop Item Confirmation Modal -->
            <div x-show="shopModal.show" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/70 backdrop-blur-sm z-[60] p-6" @click="closeShopModal()">
                <div class="glass-panel p-6 rounded-3xl text-center border border-white/10 shadow-2xl max-w-sm w-full" @click.stop>
                    <h3 class="text-2xl font-bold text-white mb-4" x-text="shopModal.title"></h3>
                    <!-- v10.138: desc는 이미 다국어 키를 통해 translate되어 들어옴 -->
                    <p class="text-lg text-gray-300 mb-2 whitespace-pre-line" x-text="shopModal.desc"></p>
                    <template x-if="shopModal.item === 'reload'"><p class="text-base font-bold text-cyan-300 mb-4" x-text="`(현재 구매 충전: +${reloadBoost}회)`"></p></template>
                    <div class="flex justify-center items-center mb-8" x-show="!shopModal.isMax">
                        <!-- v10.139: COST: 하드코딩 -->
                        <span class="text-gray-400 mr-2 text-2xl font-bold">COST:</span>
                        <span class="text-2xl font-bold" :class="como >= shopModal.cost ? 'text-purple-300' : 'text-red-400'" x-text="`${shopModal.cost} COMO`"></span>
                    </div>
                    <div class="flex justify-center items-center mb-8" x-show="shopModal.isMax">
                        <!-- v10.139: MAX LEVEL REACHED 하드코딩 -->
                        <span class="text-2xl font-bold text-yellow-500">MAX LEVEL REACHED</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <!-- v10.139: CANCEL 하드코딩 -->
                        <button @click="closeShopModal()" class="glass-button py-3 text-white font-bold rounded-xl">BACK</button>
                        <!-- v10.139: BUY 하드코딩 -->
                        <button @click="confirmBuyItem()" :disabled="como < shopModal.cost || shopModal.isMax" class="glass-button py-3 font-bold rounded-xl" :class="!shopModal.isMax && como >= shopModal.cost ? 'text-green-400 border-green-500/50' : 'opacity-50 cursor-not-allowed'">BUY</button>
                    </div>
                </div>
            </div>

            <!-- Gacha (Booster Pack) Modal -->
            <div x-show="gameState === 'gacha'" x-transition class="absolute inset-0 w-full h-full flex flex-col justify-center items-center bg-black/80 backdrop-blur-md z-[60]">
                <div class="relative flex flex-col items-center">
                    <h2 class="text-3xl font-bold mb-8" x-show="gachaState === 'ready'">
                        <span class="holo-text">OBJEKT</span><span class="text-white"> PACK</span>
                    </h2>
                    <!-- v10.135: 타이틀 제거를 위해 h2 제거 및 pt-16 제거 (카드팩이 중앙으로 이동) -->
                    <!-- h2 제거 -->
                    <div class="booster-pack-container flex flex-col items-center">
                        <template x-if="gachaState === 'ready' || gachaState === 'opening'">
                             <button @click="startGachaAnimation()" :disabled="gachaState !== 'ready'" class="booster-pack cursor-pointer" :class="gachaState === 'opening' ? 'pack-shaking' : ''">
                                <span class="text-purple-300 font-black">🃏</span>
                            </button>
                        </template>
                        <!-- Flash Overlay -->
                        <div x-show="gachaState === 'joker_flash'" class="absolute inset-0 z-10 w-full h-full flash-overlay-purple rounded-3xl"></div>
                        <div x-show="gachaState === 'opening'" class="absolute inset-0 z-10 w-full h-full flash-overlay rounded-3xl"></div>

                        <template x-if="gachaState === 'ready'">
                            <p class="text-gray-400 mt-4 text-xl font-bold" :class="como < 1 ? 'text-red-400' : 'text-purple-300'" x-text="`1 COMO`"></p>
                        </template>
                        
                        <template x-if="gachaState === 'result'">
                            <div class="card-reveal transform scale-150 origin-bottom-center">
                                <div x-data="objektCard(gachaResultCard)">
                                    <div class="flex-shrink-0 w-16 h-20 rounded-lg flex shadow-md border-2" 
                                        :class="borderStyles" 
                                        :style="cardStyles.background">
                                        <div class="flex-grow h-full flex flex-col items-center justify-center p-1">
                                            <span class="text-lg font-extrabold" :style="cardStyles.text" x-text="gachaResultCard.sNumber"></span>
                                            <span class="text-xs font-bold" :style="cardStyles.text" x-text="gachaResultCard.kor"></span>
                                        </div>
                                        <div class="flex-shrink-0 w-1/5 h-full bg-black/30 flex items-center justify-center rounded-r-md" :class="gachaResultCard.isSpecial || gachaResultCard.type === 'joker_card' ? 'holo-bg' : 'bg-black/30'">
                                            <span class="text-xs font-bold text-white writing-mode-v-rl" x-text="gachaResultCard.eng"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <template x-if="gachaState === 'result'">
                        <div class="flex flex-col items-center mt-12">
                            <h3 class="text-3xl font-black text-white mb-2 text-glow-sm" 
                                :class="gachaResultCard.type === 'joker_card' ? 'text-purple-400' : 'text-cyan-400'"
                                x-text="gachaResultCard.type === 'joker_card' ? 'SUPER RARE!' : 'NEW OBJEKT!'">
                            </h3>
                            <p class="text-xl text-gray-400 mb-8" x-text="`${gachaResultCard.sNumber} / ${gachaResultCard.kor}`"></p>
                            <!-- v10.139: OK 하드코딩 -->
                            <button @click="confirmGachaResult()" class="glass-button btn-green-glow py-4 px-12 text-2xl font-bold rounded-2xl text-green-400">OK</button>
                        </div>
                    </template>
                    
                    <!-- 구매 대기 상태일 때만 BACK 버튼 표시 (추가된 부분) -->
                    <template x-if="gachaState === 'ready'">
                        <div class="mt-8 w-64">
                            <!-- v10.139: BACK 하드코딩 -->
                            <button @click="closeGachaModal()" class="glass-button w-full py-3 text-lg font-bold rounded-xl text-white">BACK</button>
                        </div>
                    </template>

                </div>
            </div>

        </div>
    </div>
</body>
</html>
